(function(){if(window.CrmActivityEmailView)return;var e=function(e,t){var i=this;i.id=e;i.options=t;i.templates=[{FROM:"",SUBJECT:"",BODY:""}];if(i.options.pageSize<1||i.options.pageSize>100)i.options.pageSize=5;i.primaryNode=BX("crm-activity-email-details-"+e);i.wrapper=i.primaryNode.parentNode;i.scrollable=i.options.template=="slider"?document.body:i.wrapper;if(i.primaryNode.__crm_act_email_view_inited)return;i.primaryNode.__crm_act_email_view_inited=true;if(i.options.template=="slider")i.bindReplyHandlers(i.primaryNode);i.log={a:0,b:0};i.scrollTo(i.primaryNode);var a=BX.findChildByClassName(i.wrapper,"crm-task-list-mail-more-a",true);if(a){BX.bind(a,"click",function(e){i.loadLog(e,this,"a");return false})}var r=BX.findChildByClassName(i.wrapper,"crm-task-list-mail-more-b",true);if(r){BX.bind(r,"click",function(e){i.loadLog(e,this,"b");return false})}var o=BX.findChildrenByClassName(i.wrapper,"crm-task-list-mail-item",true);for(var l in o){var n=o[l].getAttribute("data-log").toLowerCase();if(typeof i.log[n]!="undefined")i.log[n]++;BX.bind(o[l],"click",function(e){i.toggleLogItem(e,this)})}};e.prototype.initScrollable=function(){var e=this;if(e.__scrollableInited)return true;if(e.scrollable!==document.body){e.__scrollableInited=true;return true}window.scrollBy(0,1);if(document.body.scrollTop>0){e.scrollable=document.body;e.__scrollableInited=true}else if(document.documentElement.scrollTop>0){e.scrollable=document.documentElement;e.__scrollableInited=true}window.scrollBy(0,-1);return e.__scrollableInited};e.prototype.scrollWrapper=function(e){var t=this;if(!t.initScrollable())return;if(t.scrollable.animation){clearInterval(t.scrollable.animation);t.scrollable.animation=null}var i=t.scrollable.scrollTop;var a=e-i;var r=0;t.scrollable.animation=setInterval(function(){r++;t.scrollable.scrollTop=i+a*r/8;if(r>=8){clearInterval(t.scrollable.animation);t.scrollable.animation=null}},20)};e.prototype.scrollTo=function(e,t){var i=this;if(!i.initScrollable())return;var a=BX.pos(i.scrollable);if(i.options.template=="slider"){a.top+=i.scrollable.scrollTop;a.bottom+=i.scrollable.scrollTop}var r=BX.pos(e);var o=typeof t=="undefined"||t===e?r:BX.pos(t);if(r.top<a.top){i.scrollWrapper(i.scrollable.scrollTop-(a.top-r.top))}else if(o.bottom>a.bottom){i.scrollWrapper(Math.min(i.scrollable.scrollTop-(a.top-r.top),i.scrollable.scrollTop+(o.bottom-a.bottom)))}};e.prototype.loadLog=function(e,t,i){var a=this;BX.PreventDefault(e);var r=t.parentNode;if(a["__loadingLog"+i]==true)return;a["__loadingLog"+i]=true;BX.ajax({method:"POST",url:a.options.ajaxUrl,data:{act:"log",id:a.id,log:i+a.log[i],size:a.options.pageSize,template:a.options.template},dataType:"json",onsuccess:function(e){a["__loadingLog"+i]=false;if(e.result!="error"){var t=document.createElement("DIV");t.innerHTML=e.html;var o=i=="a"?BX.findNextSibling(r,{tag:"div"}):r;while(t.childNodes.length>0){var l=r.parentNode.insertBefore(t.childNodes[0],o);if(l.nodeType==1&&BX.hasClass(l,"crm-task-list-mail-item")){a.log[i]++;BX.addClass(l,"crm-activity-email-show-animation-rev");BX.bind(l,"click",function(e){a.toggleLogItem(e,this)})}}if(e.count<a.options.pageSize)r.style.display="none";if(i=="b")a.scrollWrapper(a.scrollable.scrollHeight);t.innerHTML=""}},onfailure:function(){a["__loadingLog"+i]=false}})};e.prototype.toggleLogItem=function(e,t){var i=this;if(window.getSelection){if(window.getSelection().toString().trim()!="")return}else if(document.selection){if(document.selection.createRange().htmlText.trim()!="")return}BX.PreventDefault(e);var a=t.getAttribute("data-id");var r=BX.findChildByClassName(t.parentNode,"crm-activity-email-details-"+a,false);var o=BX.hasClass(t,"crm-task-list-mail-item-open");if(r){BX.toggleClass(t,"crm-task-list-mail-item-open");if(o){r.style.display="none";BX.addClass(t,"crm-activity-email-show-animation-rev");t.style.display=""}else{BX.removeClass(r,"crm-activity-email-show-animation-rev");BX.addClass(r,"crm-activity-email-show-animation");r.style.display="";if(r.getAttribute("data-empty")){BX.ajax({method:"POST",url:i.options.ajaxUrl,data:{act:"logitem",id:a,template:i.options.template},dataType:"json",onsuccess:function(e){if(e.result!="error"){var a=BX.processHTML(e.html);BX.removeClass(r,"crm-activity-email-show-animation");BX.removeClass(r,"crm-activity-email-show-animation-rev");setTimeout(function(){r.style.textAlign="";r.innerHTML=a.HTML;BX.ajax.processScripts(a.SCRIPT);BX.addClass(r,"crm-activity-email-show-animation-rev");var e=BX.findChildByClassName(r,"crm-task-list-mail-item-inner-header",true);BX.bind(e,"click",function(e){if(e.target.tagName&&e.target.tagName.toUpperCase()=="A")return;i.toggleLogItem(e,t)});if(i.options.template=="slider")i.bindReplyHandlers(r);i.scrollTo(r)},10);if(r.offsetHeight>0)t.style.display="none";r.removeAttribute("data-empty")}else{r.innerHTML=e.error}}});i.scrollTo(t,r)}else{t.style.display="none";i.scrollTo(r)}}}};e.prototype.bindReplyHandlers=function(e){var t=this;var i=e.getAttribute("data-id");var a=BX.findChildByClassName(e,"crm-task-list-mail-message-panel",true);var r=BX.findChildByClassName(e,"crm-task-list-mail-reply-block",true);var o=BX.findChildByClassName(e,"crm-task-list-mail-item-control-reply",true);var l=BX.findChildByClassName(e,"crm-task-list-mail-item-control-icon-answertoall",true);var n=BX.findChildByClassName(e,"crm-task-list-mail-item-control-icon-resend",true);var s=BX.findChildByClassName(e,"crm-task-list-mail-item-control-icon-spam",true);var c=BX.findChildByClassName(e,"crm-task-list-mail-item-control-icon-delete",true);var d=BX.findChildByClassName(r,"crm-task-list-mail-reply-field-close",true);var m=BX.findChildByClassName(r,"crm-task-list-mail-cancel-reply-button",true);var p=BX.findChildByClassName(r,"crm-task-list-mail-editor",true);var u=LHEPostForm.getHandler("CrmEmailActivity"+i+"LHE");var f=BXHtmlEditor.Get("CrmEmailActivity"+i+"LHE");BX.onCustomEvent(u.eventNode,"OnShowLHE",["justShow"]);f.dom.toolbarCont.style.opacity="inherit";u.controllerInit("hide");BX.addCustomEvent(f,"OnIframeClick",function(){BX.SocNetLogDestination.closeDialog();BX.SocNetLogDestination.closeSearch();clearTimeout(BX.SocNetLogDestination.searchTimeout);BX.SocNetLogDestination.searchOnSuccessHandle=false});var v=function(){BX.removeCustomEvent(f,"AutoResizeFinished",v);t.scrollTo(r)};BX.addCustomEvent(f,"AutoResizeFinished",v);u.parser.disk_file.regexp=/(bxacid):(n?\d+)/i;f.phpParser.AddBxNode("disk_file",{Parse:function(e,t){var i=f.GetIframeDoc().getElementById(t)||BX.findChild(B,{attr:{id:t}},true);if(i){var a=document.createElement("DIV");i=i.cloneNode(true);a.appendChild(i);if(i.tagName.toUpperCase()=="IMG"){var r="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";i.setAttribute("data-bx-orig-src",i.getAttribute("src"));i.setAttribute("src",r);return a.innerHTML.replace(r,"bxacid:"+e.value)}return a.innerHTML}return"[ "+e.value+" ]"}});var B=document.createElement("div");B.innerHTML=r.__quote;var y=BX.findChildByClassName(r,"crm-email-reply-quote-btn",true);var h=function(){if(B.__applied)return;B.__applied=true;f.SetContent(f.GetContent()+B.innerHTML,true);f.Focus(false);BX.hide(y,"inline-block")};BX.bind(y,"click",h);BX.addCustomEvent(f,"OnSetViewAfter",function(){if(f.GetViewMode()!="wysiwyg"){h();f.synchro.FullSyncFromIframe()}});BX.addCustomEvent(u.eventNode,"OnFileUploadRemove",function(e){f.synchro.Sync();for(b in f.bxTags){if(f.bxTags[b].params&&f.bxTags[b].params.value==e){var t=f.GetIframeDoc().getElementById(f.bxTags[b].id);if(t&&t.parentNode)t.parentNode.removeChild(t);var t=BX.findChild(B,{attr:{id:f.bxTags[b].id}},true);if(t&&t.parentNode)t.parentNode.removeChild(t);delete f.bxTags[b]}}f.synchro.FullSyncFromIframe()});var X=function(){var e=/(\/bitrix\/tools\/crm_show_file\.php\?fileId=)(\d+)&__bxtag=\2/;var t={IMG:"src",A:"href"};for(var i in t){var a=Array.prototype.slice.call(f.GetIframeDoc().getElementsByTagName(i)).concat(BX.findChildren(B,{tag:i},true));for(var r=0;r<a.length;r++){var o=a[r].getAttribute(t[i])?a[r].getAttribute(t[i]).match(e):false;if(o&&u.arFiles["disk_filen"+o[2]]){a[r].removeAttribute("id");a[r].setAttribute(t[i],a[r].getAttribute(t[i]).replace(e,"$1$2"));f.SetBxTag(a[r],{tag:"disk_file",params:{value:"n"+o[2]}});u.monitoringSetStatus("disk_file","n"+o[2],true);u.monitoringStart()}}}f.synchro.FullSyncFromIframe()};BX.addCustomEvent(f,"OnCreateIframeAfter",X);setTimeout(X,200);BX.addCustomEvent("onPullEvent-crm",function(t,a){if(t!="activity_email_read_confirmed")return;if(a.ID!=i)return;var r=BX.findChildrenByClassName(e,"read-confirmed-datetime",true);if(r&&r.length>0){for(var o in r)BX.adjust(r[o],{text:BX.message("CRM_ACT_EMAIL_VIEW_READ_CONFIRMED_SHORT")})}});var C=BX.findChildrenByClassName(e,"crm-task-list-mail-item-to-list-more");for(var b in C){BX.bind(C[b],"click",function(e){BX.findChildByClassName(this.parentNode,"crm-task-list-mail-item-to-list-hidden",false).style.display="inline";this.style.display="none";BX.PreventDefault(e)})}var _=BX.findChildByClassName(e,"crm-task-list-mail-item-inner-body",true);if(_){var g=BX.findChildren(_,{tag:"blockquote"},true);if(g&&g.length>0){for(var b in g){BX.bind(g[b],"click",function(){BX.addClass(this,"crm-email-quote-unfolded")})}}}var T=BX.findChildByClassName(r,"crm-task-list-mail-reply-control-container",true);var A=BX.findChildByClassName(T,"crm-task-list-mail-reply-control",false);var E=function(){if(r.offsetHeight==0)return;if(!t.initScrollable())return;var e=BX.pos(t.scrollable);var i=BX.pos(r);if(e.bottom>i.bottom-10-t.scrollable.scrollTop){if(A.parentNode!==T){BX.removeClass(A,"crm-activity-planner-section");BX.removeClass(A,"crm-activity-planner-section-control");T.appendChild(A);T.style.height="";BX.removeClass(t.wrapper,"crm-activity-planner-section-control-active")}}else{if(A.parentNode!==t.wrapper){if(e.bottom>BX.pos(T).top-t.scrollable.scrollTop)BX.addClass(t.wrapper,"crm-activity-planner-section-control-active");T.style.height=T.offsetHeight+"px";BX.addClass(A,"crm-activity-planner-section");BX.addClass(A,"crm-activity-planner-section-control");t.wrapper.appendChild(A)}if(e.bottom<i.top+120-t.scrollable.scrollTop)BX.removeClass(t.wrapper,"crm-activity-planner-section-control-active");else BX.addClass(t.wrapper,"crm-activity-planner-section-control-active")}};var N=function(e){var o=BX.findChildrenByClassName(t.wrapper,"crm-task-list-mail-reply-block",true);for(var l=0;l<o.length;l++)o[l].__hideReplyForm();setTimeout(function(){BX.bind(window,"resize",E);BX.bind(window,"scroll",E)},200);var n="reply_"+i+"_rcpt_selector";var s="reply_"+i+"_rcpt_cc_selector";var c="reply_"+i+"_rcpt_bcc_selector";var d=BX.SocNetLogDestination.getSelected(n);for(var l in d)BX.SocNetLogDestination.deleteItem(l,d[l],n);var m=BX.SocNetLogDestination.getSelected(s);for(var l in m)BX.SocNetLogDestination.deleteItem(l,m[l],s);var p=BX.SocNetLogDestination.getSelected(c);for(var l in p)BX.SocNetLogDestination.deleteItem(l,p[l],c);var d=e===true?r.__rcpt_selected:r.__rcpt_all_selected;BX.SocNetLogDestination.obItemsSelected[n]=BX.clone(d);for(var l in d)BX.SocNetLogDestination.runSelectCallback(l,d[l],n,false,"init");if(e!==true){m=r.__rcpt_cc_selected;BX.SocNetLogDestination.obItemsSelected[s]=BX.clone(m);for(var l in m)BX.SocNetLogDestination.runSelectCallback(l,m[l],s,false,"init")}a.style.display="none";BX.addClass(r,"crm-activity-email-show-animation");r.style.display="";f.ResizeSceleton();f.Focus();t.scrollTo(r)};r.__hideReplyForm=function(){BX.addClass(a,"crm-activity-email-show-animation-rev");a.style.display="";r.style.display="none";BX.unbind(window,"resize",E);BX.unbind(window,"scroll",E);if(A.parentNode!==T){BX.removeClass(A,"crm-activity-planner-section");BX.removeClass(A,"crm-activity-planner-section-control");T.appendChild(A);T.style.height="";BX.removeClass(t.wrapper,"crm-activity-planner-section-control-active")}};var w=BX.findChildByClassName(r,"crm-task-list-mail-rcpt-buttons",true);var x=BX.findChildrenByClassName(w,"crm-task-list-mail-more",true);for(var b=0;b<x.length;b++){BX.bind(x[b],"click",function(e){var t=BX(this.getAttribute("data-target"));BX.addClass(t,"crm-activity-email-show-animation");t.style.display="";this.style.display="none";BX.PreventDefault(e)})}var I=BX.findChildByClassName(r,"crm-activity-email-create-title-name",true);var R=BX.findChild(r,{tag:"input",attrs:{name:"DATA[from]"}},true,false);if(t.options.mailboxes&&t.options.mailboxes.length>0){BX.bind(I,"click",function(){var e=function(e,t){R.value=e;BX.adjust(I,{html:t})};var i=function(t,i){e(i.title,i.text);i.menuWindow.close()};var a=[];for(var r in t.options.mailboxes){a.push({text:BX.util.htmlspecialchars(t.options.mailboxes[r].value),title:t.options.mailboxes[r].value,onclick:i})}a.push({__callback:i,text:BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_MENU")),onclick:function(i,a){a.menuWindow.close();BXMainMailConfirm.showForm(function(i,a){t.options.mailboxes.push({email:i.email,name:i.name,value:a});e(a,BX.util.htmlspecialchars(a));BX.PopupMenu.destroy("crm-act-email-create-from-menu")})}});var o=BX.PopupMenu.getMenuById("crm-act-email-create-from-menu");if(o&&o.bindElement!==I)BX.PopupMenu.destroy("crm-act-email-create-from-menu");BX.PopupMenu.show("crm-act-email-create-from-menu",I,a,{offsetLeft:40,angle:true,closeByEsc:true})})}var k=BX.findChildByClassName(T,"crm-activity-email-create-template",true);if(t.options.templates&&k){var S=BX.findChild(k,{tag:"input",attr:{name:"OWNER_TYPE"}},true).value;if(S&&t.options.templates[S]&&t.options.templates[S].length>0){var L=BX.findChildByClassName(k,"crm-activity-planner-slider-header-control-text",true);BX.bind(k,"click",function(){var e=function(e,i){var a=function(e){if(e.FROM&&e.FROM.length>0){if(t.options.mailboxes&&t.options.mailboxes.length>0){var i=new RegExp("[-/\\^$*+?.()|[]{}]","g");for(var a in t.options.mailboxes){var r=new RegExp("(^|<)"+t.options.mailboxes[a].email.replace(i,"\\$&")+"(>|$)","i");if(e.FROM.trim().match(r)){if(I.offsetHeight==0){var o=I.parentNode;BX.addClass(o,"crm-activity-email-show-animation");o.style.display="";for(var a=0;a<x.length;a++){if(o.id==x[a].getAttribute("data-target"))x[a].style.display="none"}}R.value=e.FROM;BX.adjust(I,{html:BX.util.htmlspecialchars(e.FROM)});break}}}}f.SetContent(e.BODY+(B.__applied?f.Parse(B.innerHTML,true,false):""),true)};if(!t.templates[i.__data.id]){var r={sessid:BX.bitrix_sessid(),ACTION:"PREPARE_MAIL_TEMPLATE",TEMPLATE_ID:i.__data.id,CONTENT_TYPE:"HTML"};var o=BX.findChildren(k,{tag:"input"},true);for(var l=0;l<o.length;l++){if(o[l].name)r[o[l].name]=o[l].value}BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?action=prepare_mail_template&templateid="+i.__data.id,method:"POST",dataType:"json",data:r,onsuccess:function(e){if(e.DATA){t.templates[i.__data.id]=e.DATA;a(e.DATA)}}})}else{a(t.templates[i.__data.id])}BX.adjust(L,{html:i.text});i.menuWindow.close()};var a=[{text:BX.message("CRM_ACT_EMAIL_CREATE_NOTEMPLATE"),onclick:e,__data:{id:0}}];for(var r in t.options.templates[S]){a.push({text:BX.util.htmlspecialchars(t.options.templates[S][r].title),onclick:e,__data:t.options.templates[S][r]})}BX.PopupMenu.show("crm-act-email-reply-"+i+"-template-menu",L,a,{offsetLeft:40,angle:true,closeByEsc:true})})}}BX.bind(a,"click",N);BX.bind(l,"click",N);BX.bind(o,"click",function(){N(true)});BX.bind(d,"click",r.__hideReplyForm);BX.bind(m,"click",r.__hideReplyForm);BX.bind(n,"click",function(){var e=BX.CrmActivityType?BX.CrmActivityType.email:top.BX.CrmActivityType.email;window.location.href="/bitrix/components/bitrix/crm.activity.planner/slider.php"+"?site_id="+BX.message("SITE_ID")+"&TYPE_ID="+e+"&FROM_ACTIVITY_ID="+i+"&ajax_action=ACTIVITY_EDIT&MESSAGE_TYPE=FWD&IFRAME=Y&IFRAME_TYPE=SIDE_SLIDER"});var M=function(a){if(!window.confirm(top.BX.CrmActivityEditor.getMessage("deletionConfirm")))return false;var r={sessid:BX.bitrix_sessid(),ACTION:"DELETE",IS_SPAM:a===true?"Y":"N",ITEM_ID:i};var o=BX.findChildren(c.parentNode,{tag:"input"},true);for(var l=0;l<o.length;l++){if(o[l].name)r[o[l].name]=o[l].value}BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?id="+i+"&action=delete",method:"POST",dataType:"json",data:r,onsuccess:function(a){top.BX.onCustomEvent("Bitrix24.Slider:postMessage",[window,{action:"ACTIVITY_DELETE",source_id:t.id,target_id:i}]);if(t.id==i){top.BX.Bitrix24.Slider.close(false,function(e){top.BX.Bitrix24.Slider.destroy(e.getUrl())})}else{var r=BX.findChildByClassName(e.parentNode,"crm-activity-email-logitem-"+i,false);var o=r.getAttribute("data-log").toLowerCase();if(typeof t.log[o]!="undefined")t.log[o]--;e.style.maxHeight=e.offsetHeight*1.5+"px";e.style.transition="max-height .2s ease-in";setTimeout(function(){e.parentNode.removeChild(e);r.parentNode.removeChild(r)},200);e.offsetHeight;e.style.maxHeight="0px";BX.removeClass(e,"crm-activity-email-show-animation");BX.removeClass(e,"crm-activity-email-show-animation-rev");BX.addClass(e,"crm-activity-email-close-animation")}}})};BX.bind(s,"click",function(){M(true)});BX.bind(c,"click",M);var D=BX.findChildByClassName(r,"feed-add-post-form-editor-btn",true);if(f.toolbar.shown){BX.addClass(D,"feed-add-post-form-btn-active");BX.removeClass(p,"mail-editor-no-toolbar")}else{BX.removeClass(D,"feed-add-post-form-btn-active");BX.addClass(p,"mail-editor-no-toolbar")}BX.bind(D,"click",function(){if(f.toolbar.shown){f.toolbar.Hide();BX.removeClass(D,"feed-add-post-form-btn-active");BX.addClass(p,"mail-editor-no-toolbar")}else{f.toolbar.Show();BX.addClass(D,"feed-add-post-form-btn-active");BX.removeClass(p,"mail-editor-no-toolbar")}});var O=BX.findChildByClassName(r,"crm-task-list-mail-reply-button",true);var H=BX.findChildByClassName(r,"crm-task-list-mail-reply-error",true);var P=window["CrmEmailActivity"+i+"FormSendHandler"]=function(){var e={ACTION:"SAVE_EMAIL",DATA:{communications:[]}};var i=BX.findChildren(r,{tag:"input"},true);for(var a=0;a<i.length;a++){if(i[a].name){if(i[a].name.match(/\[\]$/)){var o=i[a].name.substr(0,i[a].name.length-2);if(typeof e[o]=="undefined")e[o]=[];e[o].push(i[a].value)}else{e[i[a].name]=i[a].value}}}e["DATA[message]"]=f.GetContent();if(!B.__applied)e["DATA[message]"]+=f.Parse(B.innerHTML,true,false);socNetLogDestTypes={leads:BX.CrmEntityType.names.lead,deals:BX.CrmEntityType.names.deal,contacts:BX.CrmEntityType.names.contact,companies:BX.CrmEntityType.names.company};for(var a in r.__rcpt){var l=BX.clone(r.__rcpt[a]);l.entityType=socNetLogDestTypes[l.entityType];l.type="EMAIL";l.value=l.email;e.DATA.communications.push(l)}if(e.DATA.communications.length==0){BX.adjust(H,{text:BX.message("CRM_ACT_EMAIL_REPLY_EMPTY_RCPT"),style:{display:"block"}});return false}for(var a in u.controllers){var n=u.controllers[a];if(n.storage=="disk"&&n.handler&&n.handler.agent){if(n.handler.agent.uploads&&n.handler.agent.uploads.length>0){BX.adjust(H,{text:BX.message("CRM_ACT_EMAIL_REPLY_UPLOADING"),style:{display:"block"}});t.scrollTo(T);return false}}}BX.hide(H);BX.addClass(O,"webform-small-button-wait");BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?action=save_email",method:"POST",dataType:"json",data:e,onsuccess:function(e){BX.removeClass(O,"webform-small-button-wait");if(e.ERROR&&e.ERROR.length>0){H.innerHTML="";if(!BX.type.isArray(e.ERROR))e.ERROR=[e.ERROR];for(var i=0;i<e.ERROR.length;i++){H.appendChild(document.createTextNode(e.ERROR[i]));H.appendChild(document.createElement("BR"))}H.style.display="block"}else{top.BX.onCustomEvent("Bitrix24.Slider:postMessage",[window,{action:"ACTIVITY_CREATE",source_id:t.id,target_id:e.ACTIVITY.ID}]);r.__hideReplyForm();top.BX.Bitrix24.Slider.close(false,function(e){top.BX.Bitrix24.Slider.destroy(e.getUrl())});return;var a=BX.findChildByClassName(t.wrapper,"crm-task-list-mail-more-a",true);var o=a.parentNode;clearTimeout(o.__contTimeout);clearTimeout(o.__textTimeout);var l=function(){BX.adjust(a,{text:BX.message("CRM_ACT_EMAIL_REPLY_SENT")});a.style.color="#333";a.style.opacity=1};if(o.offsetHeight>0){a.style.opacity=.3;o.__textTimeout=setTimeout(l,200)}else{l();o.style.display="";t.loadLog(null,a,"a")}o.style.transition="none";o.style.background="#fffcee";o.__contTimeout=setTimeout(function(){clearTimeout(o.__textTimeout);a.style.opacity=.3;o.__textTimeout=setTimeout(function(){a.style.color="";BX.adjust(a,{text:BX.message("CRM_ACT_EMAIL_HISTORY_MORE")});a.style.opacity=1},200)},2e3);o.offsetHeight;o.style.transition="";o.style.background=""}},onfailure:function(e){BX.removeClass(O,"webform-small-button-wait")}})};BX.bind(O,"click",P)};window.CrmActivityEmailView=e})();(function(){if(window.CrmActivityEmailEdit)return;var e=function(e,t){var i=this;i.id=e;i.options=t;i.templates=[{FROM:"",SUBJECT:"",BODY:""}];i.primaryNode=BX("crm_act_email_create_form");i.wrapper=i.primaryNode.parentNode;i.scrollable=i.options.template=="slider"?document.body:i.wrapper;if(i.primaryNode.__crm_act_email_view_inited)return;i.primaryNode.__crm_act_email_view_inited=true;i.bindEditHandlers(i.primaryNode)};e.prototype.initScrollable=function(){var e=this;if(e.__scrollableInited)return true;if(e.scrollable!==document.body){e.__scrollableInited=true;return true}if(document.body.scrollTop>0){e.scrollable=document.body;e.__scrollableInited=true;return true}if(document.documentElement.scrollTop>0){e.scrollable=document.documentElement;e.__scrollableInited=true;return true}};e.prototype.bindEditHandlers=function(e){var t=this;var i=BX.findChildByClassName(e,"crm-task-list-mail-editor",true);var a=LHEPostForm.getHandler("CrmEmailActivityNewLHE");var r=BXHtmlEditor.Get("CrmEmailActivityNewLHE");BX.onCustomEvent(a.eventNode,"OnShowLHE",["justShow"]);if(t.options.hideFiles)a.controllerInit("hide");BX.addCustomEvent(r,"OnIframeClick",function(){BX.SocNetLogDestination.closeDialog();BX.SocNetLogDestination.closeSearch();clearTimeout(BX.SocNetLogDestination.searchTimeout);BX.SocNetLogDestination.searchOnSuccessHandle=false});a.parser.disk_file.regexp=/(bxacid):(n?\d+)/i;r.phpParser.AddBxNode("disk_file",{Parse:function(e,t){var i=r.GetIframeDoc().getElementById(t)||BX.findChild(o,{attr:{id:t}},true);if(i){var a=document.createElement("DIV");i=i.cloneNode(true);a.appendChild(i);if(i.tagName.toUpperCase()=="IMG"){var l="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";i.setAttribute("data-bx-orig-src",i.getAttribute("src"));i.setAttribute("src",l);return a.innerHTML.replace(l,"bxacid:"+e.value)}return a.innerHTML}return"[ "+e.value+" ]"}});var o=document.createElement("div");o.innerHTML=e.__quote;BX.addCustomEvent(a.eventNode,"OnFileUploadRemove",function(e){r.synchro.Sync();for(b in r.bxTags){if(r.bxTags[b].params&&r.bxTags[b].params.value==e){var t=r.GetIframeDoc().getElementById(r.bxTags[b].id);if(t&&t.parentNode)t.parentNode.removeChild(t);var t=BX.findChild(o,{attr:{id:r.bxTags[b].id}},true);if(t&&t.parentNode)t.parentNode.removeChild(t);delete r.bxTags[b]}}r.synchro.FullSyncFromIframe()});var l=function(){var e=/(\/bitrix\/tools\/crm_show_file\.php\?fileId=)(\d+)&__bxtag=\2/;var t={IMG:"src",A:"href"};for(var i in t){var l=Array.prototype.slice.call(r.GetIframeDoc().getElementsByTagName(i)).concat(BX.findChildren(o,{tag:i},true));for(var n=0;n<l.length;n++){var s=l[n].getAttribute(t[i])?l[n].getAttribute(t[i]).match(e):false;if(s&&a.arFiles["disk_filen"+s[2]]){l[n].removeAttribute("id");l[n].setAttribute(t[i],l[n].getAttribute(t[i]).replace(e,"$1$2"));r.SetBxTag(l[n],{tag:"disk_file",params:{value:"n"+s[2]}});a.monitoringSetStatus("disk_file","n"+s[2],true);a.monitoringStart()}}}r.synchro.FullSyncFromIframe()};BX.addCustomEvent(r,"OnCreateIframeAfter",l);setTimeout(l,200);var n=BX.findChildByClassName(t.primaryNode,"crm-task-list-mail-reply-control-container",true);var s=BX.findChildByClassName(n,"crm-task-list-mail-reply-control",false);var c=function(){if(!t.initScrollable())return;var e=BX.pos(t.scrollable);var i=BX.pos(t.primaryNode);if(e.bottom>i.bottom-10-t.scrollable.scrollTop){if(s.parentNode!==n){BX.removeClass(s,"crm-activity-planner-section");BX.removeClass(s,"crm-activity-planner-section-control");n.appendChild(s);n.style.height="";BX.removeClass(t.primaryNode,"crm-activity-planner-section-control-active")}}else{if(s.parentNode!==t.primaryNode){if(e.bottom>BX.pos(n).top-t.scrollable.scrollTop)BX.addClass(t.primaryNode,"crm-activity-planner-section-control-active");n.style.height=n.offsetHeight+"px";BX.addClass(s,"crm-activity-planner-section");BX.addClass(s,"crm-activity-planner-section-control");t.primaryNode.appendChild(s)}if(e.bottom<i.top+120-t.scrollable.scrollTop)BX.removeClass(t.primaryNode,"crm-activity-planner-section-control-active");else BX.addClass(t.primaryNode,"crm-activity-planner-section-control-active")}};setTimeout(function(){BX.bind(window,"resize",c);BX.bind(window,"scroll",c)},200);var d=BX.findChildByClassName(e,"feed-add-post-form-editor-btn",true);BX[r.toolbar.shown?"addClass":"removeClass"](d,"feed-add-post-form-btn-active");BX.bind(d,"click",function(){if(r.toolbar.shown){r.toolbar.Hide();BX.removeClass(d,"feed-add-post-form-btn-active");BX.addClass(i,"mail-editor-no-toolbar")}else{r.toolbar.Show();BX.addClass(d,"feed-add-post-form-btn-active");BX.removeClass(i,"mail-editor-no-toolbar")}});var m=BX.findChildByClassName(e,"crm-activity-email-create-title-name",true);var p=BX.findChild(e,{tag:"input",attrs:{name:"DATA[from]"}},true,false);var u=BX.findChild(e,{tag:"input",attrs:{name:"DATA[subject]"}},true,false);if(t.options.mailboxes&&t.options.mailboxes.length>0){BX.bind(m,"click",function(){var e=function(e,t){p.value=e;BX.adjust(m,{html:t})};var i=function(t,i){e(i.title,i.text);i.menuWindow.close()};var a=[];for(var r in t.options.mailboxes){a.push({text:BX.util.htmlspecialchars(t.options.mailboxes[r].value),title:t.options.mailboxes[r].value,onclick:i})}a.push({__callback:i,text:BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_MENU")),onclick:function(i,a){a.menuWindow.close();BXMainMailConfirm.showForm(function(i,a){t.options.mailboxes.push({email:i.email,name:i.name,value:a});e(a,BX.util.htmlspecialchars(a));BX.PopupMenu.destroy("crm-act-email-create-from-menu")})}});BX.PopupMenu.show("crm-act-email-create-from-menu",m,a,{offsetLeft:40,angle:true,closeByEsc:true})})}if(t.options.templates&&t.options.templates.length>0){var f=BX.findChild(document,{tag:"input",attr:{name:"DATA[REPLIED_ID]"}},true);var v=f?f.value:0;var B=BX.findChildByClassName(document,"crm-activity-email-create-template",true);var y=BX.findChildByClassName(B,"crm-activity-planner-slider-header-control-text",true);BX.bind(B,"click",function(){var e=function(e,i){var a=function(e){if(e.FROM&&e.FROM.length>0){if(t.options.mailboxes&&t.options.mailboxes.length>0){var i=new RegExp("[-/\\^$*+?.()|[]{}]","g");for(var a in t.options.mailboxes){var l=new RegExp("(^|<)"+t.options.mailboxes[a].email.replace(i,"\\$&")+"(>|$)","i");if(e.FROM.trim().match(l)){p.value=e.FROM;BX.adjust(m,{html:BX.util.htmlspecialchars(e.FROM)});break}}}}if(v<=0&&e.SUBJECT&&e.SUBJECT.length>0)u.value=e.SUBJECT;r.SetContent(e.BODY+r.Parse(o.innerHTML,true,false),true)};if(!t.templates[i.__data.id]){var l={sessid:BX.bitrix_sessid(),ACTION:"PREPARE_MAIL_TEMPLATE",TEMPLATE_ID:i.__data.id,CONTENT_TYPE:"HTML"};var n=BX.findChildren(B,{tag:"input"},true);for(var s=0;s<n.length;s++){if(n[s].name)l[n[s].name]=n[s].value}BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?action=prepare_mail_template&templateid="+i.__data.id,method:"POST",dataType:"json",data:l,onsuccess:function(e){if(e.DATA){t.templates[i.__data.id]=e.DATA;a(e.DATA)}}})}else{a(t.templates[i.__data.id])}BX.adjust(y,{html:i.text});i.menuWindow.close()};var i=[{text:BX.message("CRM_ACT_EMAIL_CREATE_NOTEMPLATE"),onclick:e,__data:{id:0}}];for(var a in t.options.templates){i.push({text:BX.util.htmlspecialchars(t.options.templates[a].title),onclick:e,__data:t.options.templates[a]})}BX.PopupMenu.show("crm-act-email-create-template-menu",y,i,{offsetLeft:40,angle:true,closeByEsc:true})})}var h=BX("crm_act_email_create_batch");var X=BX.findChildByClassName(e,"crm-task-list-mail-rcpt-buttons",true);var C=BX.findChildrenByClassName(X,"crm-task-list-mail-more",true);for(var b=0;b<C.length;b++){BX.bind(C[b],"click",function(e){var t=BX(this.getAttribute("data-target"));BX.addClass(t,"crm-activity-email-show-animation");t.style.display="";this.style.display="none";BX.PreventDefault(e)})}BX.bind(h,"change",function(){X.style.display=this.checked?"none":"";if(this.checked){X.style.display="none";for(var e=0;e<C.length;e++)BX(C[e].getAttribute("data-target")).style.display="none"}else{for(var e=0;e<C.length;e++){if(C[e].offsetHeight>0)continue;BX(C[e].getAttribute("data-target")).style.display=""}X.style.display=""}});var _=BX.findChildByClassName(e,"crm-task-list-mail-reply-button",true);var g=BX.findChildByClassName(e,"crm-task-list-mail-cancel-reply-button",true);var T=BX.findChildByClassName(e,"crm-task-list-mail-reply-error",true);BX.bind(g,"click",function(){top.BX.Bitrix24.Slider.close()});var A=window.CrmEmailActivityNewFormSendHandler=function(){var i={ACTION:"SAVE_EMAIL",DATA:{communications:[],bindings:[]}};var o=BX.findChildren(document,{tag:"input"},true);for(var l=0;l<o.length;l++){if(o[l].name){var n=o[l].name;if(n.indexOf("__crm_activity_planner[")>=0)n="DATA"+n.substr("__crm_activity_planner".length);else if(!BX.isParentForNode(e,o[l]))continue;var s=o[l].type.toLowerCase();if(s=="checkbox"||s=="radio"){if(!o[l].checked)continue}if(n.match(/\[\]$/)){var n=n.substr(0,n.length-2);if(typeof i[n]=="undefined")i[n]=[];i[n].push(o[l].value)}else{i[n]=o[l].value}}}i["DATA[message]"]=r.GetContent();socNetLogDestTypes={leads:BX.CrmEntityType.names.lead,deals:BX.CrmEntityType.names.deal,contacts:BX.CrmEntityType.names.contact,companies:BX.CrmEntityType.names.company};for(var l in e.__rcpt){var c=BX.clone(e.__rcpt[l]);c.entityType=socNetLogDestTypes[c.entityType];c.type="EMAIL";c.value=c.email;i.DATA.communications.push(c)}for(var l in e.__docs){var c=BX.clone(e.__docs[l]);c.entityType=socNetLogDestTypes[c.entityType];i.DATA.bindings.push(c);break}if(i.DATA.communications.length==0){BX.adjust(T,{text:BX.message("CRM_ACT_EMAIL_REPLY_EMPTY_RCPT"),style:{display:"block"}});document.body.scrollTop=document.body.scrollHeight;return false}for(var l in a.controllers){var d=a.controllers[l];if(d.storage=="disk"&&d.handler&&d.handler.agent){if(d.handler.agent.uploads&&d.handler.agent.uploads.length>0){BX.adjust(T,{text:BX.message("CRM_ACT_EMAIL_REPLY_UPLOADING"),style:{display:"block"}});document.body.scrollTop=document.body.scrollHeight;return false}}}BX.hide(T);BX.addClass(_,"webform-small-button-wait");BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?action=save_email",method:"POST",dataType:"json",data:i,onsuccess:function(e){BX.removeClass(_,"webform-small-button-wait");if(e.ERROR&&e.ERROR.length>0){T.innerHTML="";if(!BX.type.isArray(e.ERROR))e.ERROR=[e.ERROR];for(var i=0;i<e.ERROR.length;i++){T.appendChild(document.createTextNode(e.ERROR[i]));T.appendChild(document.createElement("BR"))}T.style.display="block";document.body.scrollTop=document.body.scrollHeight}else{top.BX.onCustomEvent("Bitrix24.Slider:postMessage",[window,{action:"ACTIVITY_CREATE",source_id:t.id,target_id:e.ACTIVITY.ID}]);top.BX.Bitrix24.Slider.close(false,function(e){top.BX.Bitrix24.Slider.destroy(e.getUrl())})}},onfailure:function(e){BX.removeClass(_,"webform-small-button-wait")}})};BX.bind(_,"click",A)};window.CrmActivityEmailEdit=e})();