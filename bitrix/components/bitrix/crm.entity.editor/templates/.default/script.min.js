BX.namespace("BX.Crm");if(typeof BX.Crm.EntityEditor==="undefined"){BX.Crm.EntityEditor=function(){this._id="";this._settings={};this._entityTypeId=0;this._entityId=0;this._userFieldManager=null;this._dupControlManager=null;this._bizprocManager=null;this._container=null;this._buttonContainer=null;this._createSectionButton=null;this._pageTitle=null;this._pageTitleInput=null;this._editPageTitleButton=null;this._copyPageUrlButton=null;this._formElement=null;this._ajaxForm=null;this._formSubmitHandler=BX.delegate(this.onFormSubmit,this);this._controllers=null;this._controls=null;this._activeControls=null;this._toolPanel=null;this._model=null;this._scheme=null;this._config=null;this._context=null;this._contextId="";this._externalContextId="";this._mode=BX.Crm.EntityEditorMode.intermediate;this._isNew=false;this._readOnly=false;this._enableAjaxForm=true;this._enableSectionEdit=false;this._enableSectionCreation=false;this._enableModeToggle=true;this._serviceUrl="";this._htmlEditorConfig=null;this._areAvailableSchemeElementsChanged=false;this._availableSchemeElements=null;this._dragPlaceHolder=null;this._dragContainerController=null;this._dropHandler=BX.delegate(this.onDrop,this);this._pageTitleExternalClickHandler=BX.delegate(this.onPageTitleExternalClick,this);this._pageTitleKeyPressHandler=BX.delegate(this.onPageTitleKeyPress,this);this._modeChangeNotifier=null;this._controlChangeNotifier=null;this._validators=null};BX.Crm.EntityEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",0);this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._isNew=this._entityId<=0;this._container=BX(BX.prop.get(this._settings,"containerId"));this._parentContainer=BX.findParent(this._container,{className:"crm-entity-section"},false);this._buttonContainer=BX(BX.prop.get(this._settings,"buttonContainerId"));this._createSectionButton=BX(BX.prop.get(this._settings,"createSectionButtonId"));this._pageTitle=BX("pagetitle");this._editPageTitleButton=BX("pagetitle_edit");this._copyPageUrlButton=BX("page_url_copy_btn");this._formElement=BX.create("form",{});this._container.appendChild(this._formElement);this._enableAjaxForm=BX.prop.getBoolean(this._settings,"enableAjaxForm",true);if(this._enableAjaxForm){this.initializeAjaxForm()}var i=BX.prop.getObject(this._settings,"duplicateControl",{});if(this._ajaxForm){i["form"]=this._ajaxForm}this._dupControlManager=BX.Crm.EntityEditorDupManager.create(this._id.toLowerCase()+"_dup",i);this._model=BX.prop.get(this._settings,"model",null);this._scheme=BX.prop.get(this._settings,"scheme",null);this._config=BX.prop.get(this._settings,"config",null);this._context=BX.prop.getObject(this._settings,"context",{});this._contextId=BX.prop.getString(this._settings,"contextId","");this._externalContextId=BX.prop.getString(this._settings,"externalContextId","");this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);if(this._readOnly){this._enableSectionEdit=this._enableSectionCreation=false}else{this._enableSectionEdit=BX.prop.getBoolean(this._settings,"enableSectionEdit",false);this._enableSectionCreation=BX.prop.getBoolean(this._settings,"enableSectionCreation",false)}this._userFieldManager=BX.prop.get(this._settings,"userFieldManager",null);this._bizprocManager=BX.prop.get(this._settings,"bizprocManager",null);this._bizprocManager._editor=this;this._restPlacementTabManager=BX.prop.get(this._settings,"restPlacementTabManager",null);this._restPlacementTabManager._editor=this;this._modeChangeNotifier=BX.CrmNotifier.create(this);this._controlChangeNotifier=BX.CrmNotifier.create(this);this._availableSchemeElements=this._scheme.getAvailableElements();this._controllers=[];this._controls=[];this._activeControls=[];this._htmlEditorConfig=BX.prop.getObject(this._settings,"htmlEditorConfig",{});var n=this._scheme.getElements();var r=BX.Crm.EntityEditorMode.view;if(!this._readOnly){r=BX.Crm.EntityEditorMode.parse(BX.prop.getString(this._settings,"initialMode",""))}this._mode=r!==BX.Crm.EntityEditorMode.intermediate?r:BX.Crm.EntityEditorMode.view;this._enableModeToggle=false;if(!this._readOnly){this._enableModeToggle=BX.prop.getBoolean(this._settings,"enableModeToggle",true)}if(this._isNew&&!this._readOnly){this._mode=BX.Crm.EntityEditorMode.edit}var o,s;var a=BX.prop.getArray(this._settings,"controllers",[]);for(o=0,s=a.length;o<s;o++){var l=this.createController(a[o]);if(l){this._controllers.push(l)}}var d,h;for(o=0,s=n.length;o<s;o++){d=n[o];h=this.createControl(d.getType(),d.getName(),{schemeElement:d,mode:BX.Crm.EntityEditorMode.view});if(!h){continue}this._controls.push(h)}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._controls.length>0){for(o=0,s=this._controls.length;o<s;o++){h=this._controls[o];var p=h.getEditPriority();if(p===BX.Crm.EntityEditorPriority.high){h.setMode(BX.Crm.EntityEditorMode.edit,false)}}if(this.getActiveControlCount()===0){this._controls[0].setMode(BX.Crm.EntityEditorMode.edit,false)}}this._validators=[];var c=BX.prop.getArray(this._settings,"validators",[]);for(o=0,s=c.length;o<s;o++){var u=this.createValidator(c[o]);if(u){this._validators.push(u)}}this._modeChangeNotifier.notify([this]);this._toolPanel=BX.Crm.EntityEditorToolPanel.create(this._id,{container:this._formElement,editor:this,visible:false});this._dragContainerController=BX.Crm.EditorDragContainerController.create("editor_"+this.getId(),{charge:BX.Crm.EditorSectionDragContainer.create({editor:this}),node:this._formElement});this._dragContainerController.addDragFinishListener(this._dropHandler);BX.addCustomEvent(window,"Crm.InterfaceToolbar.MenuBuild",BX.delegate(this.onInterfaceToolbarMenuBuild,this));this.layout()},initializeAjaxForm:function(){if(this._ajaxForm){return}this._ajaxForm=BX.Crm.AjaxForm.create(this._id,{elementNode:this._formElement,config:{url:this._serviceUrl,method:"POST",dataType:"json",processData:true,onsuccess:BX.delegate(this.onSaveSuccess,this),data:{ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId))}}});BX.addCustomEvent(this._ajaxForm,"onAfterSubmit",this._formSubmitHandler)},releaseAjaxForm:function(){if(!this._ajaxForm){return}BX.removeCustomEvent(this._ajaxForm,"onAfterSubmit",this._formSubmitHandler);this._ajaxForm=null},getId:function(){return this._id},getEntityTypeId:function(){return this._entityTypeId},getEntityTypeName:function(){return BX.CrmEntityType.resolveName(this._entityTypeId)},getEntityId:function(){return this._entityId},getOwnerInfo:function(){return this._model.getOwnerInfo()},getMode:function(){return this._mode},getContextId:function(){return this._contextId},getExternalContextId:function(){return this._externalContextId},getScheme:function(){return this._scheme},isSectionEditEnabled:function(){return this._enableSectionEdit},isSectionCreationEnabled:function(){return this._enableSectionCreation},isModeToggleEnabled:function(){return this._enableModeToggle},isNew:function(){return this._isNew},isReadOnly:function(){return this._readOnly},isEditInViewEnabled:function(){return this._entityId>0},getEntityCreateUrl:function(t){if(t===BX.CrmEntityType.names.contact){return BX.prop.getString(this._settings,"contactCreateUrl","")}else if(t===BX.CrmEntityType.names.company){return BX.prop.getString(this._settings,"companyCreateUrl","")}return""},getEntityRequisiteSelectUrl:function(t,e){var i="";if(t===BX.CrmEntityType.names.contact){i=BX.prop.getString(this._settings,"contactRequisiteSelectUrl","").replace(/#contact_id#/gi,e)}else if(t===BX.CrmEntityType.names.company){i=BX.prop.getString(this._settings,"companyRequisiteSelectUrl","").replace(/#company_id#/gi,e)}return i},getRequisiteEditUrl:function(t){return BX.prop.getString(this._settings,"requisiteEditUrl","").replace(/#requisite_id#/gi,t)},getUserFieldManager:function(){return this._userFieldManager},getBizprocManager:function(){return this._bizprocManager},getHtmlEditorId:function(){return BX.prop.getString(this._htmlEditorConfig,"id")},getHtmlEditor:function(){return BXHtmlEditor.Get(BX.prop.getString(this._htmlEditorConfig,"id"))},getHtmlEditorConfig:function(){return this._htmlEditorConfig},createValidator:function(t){t["editor"]=this;return BX.Crm.EntityEditorValidatorFactory.create(BX.prop.getString(t,"type",""),t)},getControlIndex:function(t){for(var e=0,i=this._controls.length;e<i;e++){if(this._controls[e]===t){return e}}return-1},getControls:function(){return this._controls},getControlCount:function(){return this._controls.length},createControl:function(t,e,i){i["serviceUrl"]=this._serviceUrl;i["container"]=this._formElement;i["model"]=this._model;i["editor"]=this;return BX.Crm.EntityEditorControlFactory.create(t,e,i)},addControlAt:function(t,e){var i={};if(e<this._controls.length){i["anchor"]=this._controls[e].getWrapper();this._controls.splice(e,0,t)}else{this._controls.push(t)}t.layout(i)},moveControl:function(t,e){var i=this._controls.length;var n=i-1;if(e<0||e>i){e=n}var r=this.getControlIndex(t);if(r<0||r===e){return false}t.clearLayout();this._controls.splice(r,1);i--;var o=e<i?this._controls[e].getWrapper():null;if(e<i){this._controls.splice(e,0,t)}else{this._controls.push(t)}if(o){t.layout({anchor:o})}else{t.layout()}this._config.moveSchemeElement(t.getSchemeElement(),e)},removeControl:function(t){var e=this.getControlIndex(t);if(e<0){return false}this.processControlRemove(t);t.clearLayout();this._controls.splice(e,1)},getControlById:function(t){for(var e=0,i=this._controls.length;e<i;e++){var n=this._controls[e];if(n.getId()===t){return n}var r=n.getChildById(t);if(r){return r}}return null},getActiveControlCount:function(){return this._activeControls.length},getActiveControlIndex:function(t){var e=this._activeControls.length;if(e===0){return-1}for(var i=0;i<e;i++){if(this._activeControls[i]===t){return i}}return-1},getActiveControlById:function(t){var e=this._activeControls.length;if(e===0){return null}for(var i=0;i<e;i++){var n=this._activeControls[i];if(n.getId()===t){return n}}return null},registerActiveControl:function(t){var e=this.getActiveControlIndex(t);if(e>=0){return}this._activeControls.push(t);t.setActive(true);if(this._mode!==BX.Crm.EntityEditorMode.edit){this._mode=BX.Crm.EntityEditorMode.edit;this._modeChangeNotifier.notify([this])}},unregisterActiveControl:function(t){var e=this.getActiveControlIndex(t);if(e<0){return}this._activeControls.splice(e,1);t.setActive(false);if(this._activeControls.length===0&&this._mode!==BX.Crm.EntityEditorMode.view){this._mode=BX.Crm.EntityEditorMode.view;this._modeChangeNotifier.notify([this])}},releaseActiveControls:function(){for(var t=0,e=this._activeControls.length;t<e;t++){var i=this._activeControls[t];i.setActive(false);i.toggleMode(false)}this._activeControls=[]},processControlModeChange:function(t){if(t.getMode()===BX.Crm.EntityEditorMode.edit){this.registerActiveControl(t)}else{this.unregisterActiveControl(t)}if(this.getActiveControlCount()>0){this.showToolPanel()}else{this.hideToolPanel()}},processControlChange:function(t,e){this.showToolPanel();this._controlChangeNotifier.notify([e])},processControlAdd:function(t){this.removeAvailableSchemeElement(t.getSchemeElement())},processControlMove:function(t){},processControlRemove:function(t){if(t instanceof BX.Crm.EntityEditorField){this.addAvailableSchemeElement(t.getSchemeElement())}else if(t instanceof BX.Crm.EntityEditorSection){var e=t.getChildren();for(var i=0,n=e.length;i<n;i++){this.addAvailableSchemeElement(e[i].getSchemeElement())}}},getAvailableSchemeElements:function(){return this._availableSchemeElements},addAvailableSchemeElement:function(t){this._availableSchemeElements.push(t);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},removeAvailableSchemeElement:function(t){var e=this.getAvailableSchemeElementIndex(t);if(e<0){return}this._availableSchemeElements.splice(e,1);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},getAvailableSchemeElementIndex:function(t){var e=this._availableSchemeElements;for(var i=0,n=e.length;i<n;i++){if(e[i]===t){return i}}return-1},getAvailableSchemeElementByName:function(t){var e=this._availableSchemeElements;for(var i=0,n=e.length;i<n;i++){var r=e[i];if(r.getName()===t){return r}}return null},hasAvailableSchemeElements:function(){return this._availableSchemeElements.length>0},notifyAvailableSchemeElementsChanged:function(){for(var t=0,e=this._activeControls.length;t<e;t++){this._activeControls[t].processAvailableSchemeElementsChange()}},createController:function(t){return BX.Crm.EntityEditorControllerFactory.create(BX.prop.getString(t,"type",""),BX.prop.getString(t,"name",""),{config:BX.prop.getObject(t,"config",{}),model:this._model,editor:this})},processControllerChange:function(t){this.showToolPanel()},prepareContextDataLayout:function(t,e){for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var r=i;if(BX.type.isNotEmptyString(e)){r=e+"["+r+"]"}if(BX.type.isPlainObject(n)){this.prepareContextDataLayout(n,r)}else{this._formElement.appendChild(BX.create("input",{props:{type:"hidden",name:r,value:n}}))}}},layout:function(){this.prepareContextDataLayout(this._context,"");this._toolPanel.layout();if(this.isSectionCreationEnabled()){BX.bind(this._createSectionButton,"click",BX.delegate(this.onCreateSectionButtonClick,this))}else{this._createSectionButton.style.display="none"}var t,e,i;for(t=0,e=this._controls.length;t<e;t++){i=this._controls[t];i.layout();if(i.getMode()===BX.Crm.EntityEditorMode.edit){this.registerActiveControl(i)}}if(this.getActiveControlCount()>0){this.showToolPanel()}if(this._model.isCaptionEditable()&&this._editPageTitleButton){BX.bind(this._editPageTitleButton,"click",BX.delegate(this.onPageTileButtonClick,this))}},refreshLayout:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].refreshLayout()}},switchToViewMode:function(){this.rollback();this.releaseActiveControls();this.hideToolPanel()},switchTitleMode:function(t){if(t===BX.Crm.EntityEditorMode.edit){this._pageTitle.style.display="none";if(this._editPageTitleButton){this._editPageTitleButton.style.display="none"}if(this._copyPageUrlButton){this._copyPageUrlButton.style.display="none"}this._pageTitleInput=BX.create("input",{props:{type:"text",className:"pagetitle-item",value:this._model.getCaption()}});this._pageTitle.parentNode.insertBefore(this._pageTitleInput,this._editPageTitleButton);this._pageTitleInput.focus();window.setTimeout(BX.delegate(function(){BX.bind(document,"click",this._pageTitleExternalClickHandler);BX.bind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler)},this),300)}else{if(this._pageTitleInput){this._pageTitleInput=BX.remove(this._pageTitleInput)}this._pageTitle.innerHTML=BX.util.htmlspecialchars(this._model.getCaption());this._pageTitle.style.display="";if(this._editPageTitleButton){this._editPageTitleButton.style.display=""}if(this._copyPageUrlButton){this._copyPageUrlButton.style.display=""}BX.unbind(document,"click",this._pageTitleExternalClickHandler);BX.unbind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler)}},showToolPanel:function(){if(this._toolPanel.isVisible()){return}this._toolPanel.setVisible(true);if(this._parentContainer){this._parentContainer.style.paddingBottom="50px"}},hideToolPanel:function(){if(!this._toolPanel.isVisible()){return}this._toolPanel.setVisible(false);if(this._parentContainer){this._parentContainer.style.paddingBottom=""}},addModeChangeListener:function(t){this._modeChangeNotifier.addListener(t)},removeModeChangeListener:function(t){this._modeChangeNotifier.removeListener(t)},addControlChangeListener:function(t){this._controlChangeNotifier.addListener(t)},removeControlChangeListener:function(t){this._controlChangeNotifier.removeListener(t)},getMessage:function(t){var e=BX.Crm.EntityEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getFormElement:function(){return this._formElement},savePageTitle:function(){if(!this._pageTitleInput){return}var t=BX.util.trim(BX.util.strip_tags(this._pageTitleInput.value));if(t===""){return}this._model.setCaption(t);var e={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId))};this._model.prepareCaptionData(e);BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:e,onsuccess:BX.delegate(this.onSaveSuccess,this)})},save:function(){var t=BX.Crm.EntityValidationResult.create();var e=this.getBizprocManager();this.validate(t).then(function(){return e.onBeforeSave(t)}).then(BX.delegate(function(){if(t.getStatus()){this.innerSave();e.onAfterSave()}else{var i=t.getTopmostField();if(i){i.focus()}}},this))},saveControl:function(t){if(this._entityId<=0){return}var e=BX.Crm.EntityValidationResult.create();t.validate(e);if(!e.getStatus()){return}var i={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId))};i=BX.mergeEx(i,this._context);t.save();t.prepareSaveData(i);BX.ajax({method:"POST",dataType:"json",url:this._serviceUrl,data:i,onsuccess:BX.delegate(this.onSaveSuccess,this)})},validate:function(t){for(var e=0,i=this._activeControls.length;e<i;e++){this._activeControls[e].validate(t)}var n=new BX.Promise;this._userFieldManager.validate(t).then(BX.delegate(function(){n.fulfill()},this));return n},innerSave:function(){var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].onBeforeSubmit()}for(t=0,e=this._activeControls.length;t<e;t++){var i=this._activeControls[t];i.save();i.onBeforeSubmit();if(i.isSchemeChanged()){this._config.updateSchemeElement(i.getSchemeElement())}}if(this._areAvailableSchemeElementsChanged){this._scheme.setAvailableElements(this._availableSchemeElements);this._areAvailableSchemeElementsChanged=false}if(this._config.isChanged()){this._config.save(false)}var n={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onSave",[this,n]);if(n["cancel"]){return}if(this._ajaxForm){this._ajaxForm.submit()}},cancel:function(){var t={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onCancel",[this,t]);if(t["cancel"]){return}if(this._isNew){this.rollback();this.refreshLayout();if(typeof top.BX.Bitrix24.Slider!=="undefined"){var e=top.BX.Bitrix24.Slider.getCurrentPage();if(e){e.close(false)}}}else{this.switchToViewMode();this.refreshLayout()}},rollback:function(){var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].rollback()}for(t=0,e=this._activeControls.length;t<e;t++){this._activeControls[t].rollback()}if(this._areAvailableSchemeElementsChanged){this._availableSchemeElements=this._scheme.getAvailableElements();this._areAvailableSchemeElementsChanged=false}this._mode=BX.Crm.EntityEditorMode.view;this._modeChangeNotifier.notify([this])},addSchemeElementAt:function(t,e){this._config.addSchemeElementAt(t,e)},updateSchemeElement:function(t){this._config.updateSchemeElement(t)},removeSchemeElement:function(t){this._config.removeSchemeElement(t)},isSchemeChanged:function(){return this._config.isChanged()},saveScheme:function(){return this._config.save(false)},saveSchemeChanges:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].commitSchemeChanges()}return this._config.save(false)},onSaveSuccess:function(t){this._toolPanel.processSaveComplete();this._toolPanel.clearErrors();var e=BX.prop.getString(t,"ERROR","");if(e!==""){this._toolPanel.addError(e);this.releaseAjaxForm();this.initializeAjaxForm();return}var i={};var n=BX.prop.getObject(t,"ENTITY_INFO",null);if(n){i["entityInfo"]=n}var r=BX.prop.getObject(t,"ENTITY_DATA",null);if(this._isNew){this._entityId=BX.prop.getInteger(t,"ENTITY_ID",0);if(this._entityId<=0){this._toolPanel.addError(this.getMessage("couldNotFindEntityIdError"));return}BX.Crm.EntityEvent.fireCreate(this._entityTypeId,this._entityId,this._externalContextId,i);i["entityData"]=r;BX.onCustomEvent(window,BX.Crm.EntityEvent.names.create,[i]);this._isNew=false}else{BX.Crm.EntityEvent.fireUpdate(this._entityTypeId,this._entityId,this._externalContextId,i);i["entityData"]=r;BX.onCustomEvent(window,BX.Crm.EntityEvent.names.update,[i])}var o=BX.prop.getObject(t,"EVENT_PARAMS",null);if(o){var s=BX.prop.getString(o,"name","");var a=BX.prop.getObject(o,"args",null);if(s!==""&&a!==null){BX.localStorage.set(s,a,10)}}var l=BX.prop.getString(t,"REDIRECT_URL","");if(l!==""){window.location.replace(l)}else{var d=BX.prop.getObject(t,"ENTITY_DATA",null);if(BX.type.isPlainObject(d)){this._model.setData(d)}this._pageTitle.innerHTML=BX.util.htmlspecialchars(this._model.getCaption());this.releaseAjaxForm();this.initializeAjaxForm();this.switchToViewMode();this.refreshLayout()}},formatMoney:function(t,e,i){BX.ajax({url:BX.prop.getString(this._settings,"serviceUrl",""),method:"POST",dataType:"json",data:{ACTION:"GET_FORMATTED_SUM",CURRENCY_ID:e,SUM:t},onsuccess:i})},findOption:function(t,e){for(var i=0,n=e.length;i<n;i++){if(t===e[i].VALUE){return e[i].NAME}}return t},getServiceUrl:function(){return this._serviceUrl},loadCustomHtml:function(t,e,i){e["ACTION"]=t;e["ACTION_ENTITY_ID"]=this._entityId;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:e,onsuccess:i})},onFormSubmit:function(t,e){this._toolPanel.processSaveBegin()},isDuplicateControlEnabled:function(){return this._dupControlManager.isEnabled()},getDuplicateManager:function(){return this._dupControlManager},onPageTileButtonClick:function(t){if(!this._readOnly){this.switchTitleMode(BX.Crm.EntityEditorMode.edit)}},onCreateSectionButtonClick:function(t){if(!this.isSectionCreationEnabled()){return}var e=this.getControlCount();var i="user_"+BX.util.getRandomString(8).toLowerCase();var n=BX.Crm.EntitySchemeElement.create({type:"section",name:i,title:this.getMessage("newSectionTitle")});this.addSchemeElementAt(n,e);var r=this.createControl("section",i,{schemeElement:n,model:this._model,container:this._formElement});this.addControlAt(r,e);this.saveScheme();r.setMode(BX.Crm.EntityEditorMode.edit);r.refreshLayout();r.setTitleMode(BX.Crm.EntityEditorMode.edit);this.registerActiveControl(r)},onPageTitleExternalClick:function(t){var e=BX.getEventTarget(t);if(e!==this._pageTitleInput){this.savePageTitle();this.switchTitleMode(BX.Crm.EntityEditorMode.view)}},onPageTitleKeyPress:function(t){var e=t.keyCode;if(e===13){this.savePageTitle();this.switchTitleMode(BX.Crm.EntityEditorMode.view)}else if(e===27){this.switchTitleMode(BX.Crm.EntityEditorMode.view)}},onInterfaceToolbarMenuBuild:function(t,e){var i=BX.prop.getArray(e,"items",null);if(!i){return}var n=BX.delegate(this.onMenuItemClick,this);i.push({delimiter:true});i.push({id:"resetConfig",text:this.getMessage("resetConfig"),onclick:n});if(BX.prop.getBoolean(this._settings,"enableSettingsForAll",false)){i.push({id:"resetConfigForAllUsers",text:this.getMessage("resetConfigForAllUsers"),onclick:n});i.push({id:"saveConfigForAllUsers",text:this.getMessage("saveConfigForAllUsers"),onclick:n})}},resetConfig:function(){this._config.reset(false).then(function(){window.location.reload()})},resetConfigForAllUsers:function(){if(BX.prop.getBoolean(this._settings,"enableSettingsForAll",false)){this._config.reset(true).then(function(){window.location.reload()})}},onMenuItemClick:function(t,e){var i=BX.prop.getString(e,"id","");if(i==="resetConfig"){this.resetConfig()}else if(i==="resetConfigForAllUsers"){this.resetConfigForAllUsers()}else if(i==="saveConfigForAllUsers"){this.saveConfigForAllUsers()}if(e.menuWindow){e.menuWindow.close()}},saveConfigForAllUsers:function(){if(BX.prop.getBoolean(this._settings,"enableSettingsForAll",false)){this._config.save(true)}},hasPlaceHolder:function(){return!!this._dragPlaceHolder},createPlaceHolder:function(t){var e=this.getControlCount();if(t<0||t>e){t=e>0?e:0}if(this._dragPlaceHolder){if(this._dragPlaceHolder.getIndex()===t){return this._dragPlaceHolder}this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}this._dragPlaceHolder=BX.Crm.EditorDragSectionPlaceholder.create({container:this._formElement,anchor:t<e?this._controls[t].getWrapper():null,index:t});this._dragPlaceHolder.layout();return this._dragPlaceHolder},getPlaceHolder:function(){return this._dragPlaceHolder},removePlaceHolder:function(){if(this._dragPlaceHolder){this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}},processDraggedItemDrop:function(t,e){var i=t.getCharge();if(!(i instanceof BX.Crm.EditorSectionDragContainer&&i.getEditor()===this)){return}var n=e.getContextData();var r=BX.type.isNotEmptyString(n["contextId"])?n["contextId"]:"";if(r!==BX.Crm.EditorSectionDragItem.contextId){return}var o=typeof n["charge"]!=="undefined"?n["charge"]:null;if(!(o instanceof BX.Crm.EditorSectionDragItem)){return}var s=o.getControl();if(!s){return}var a=this.getControlIndex(s);if(a<0){return}var l=this.getPlaceHolder();var d=l?l.getIndex():-1;if(d<0){return}var h=d<=a?d:d-1;if(h!==a){this.moveControl(s,h);this.saveScheme()}},onDrop:function(t,e,i,n){this.processDraggedItemDrop(t,e)}};BX.Crm.EntityEditor.defaultInstance=null;BX.Crm.EntityEditor.items={};BX.Crm.EntityEditor.get=function(t){return this._items.hasOwnProperty(t)?this._items[t]:null};if(typeof BX.Crm.EntityEditor.messages==="undefined"){BX.Crm.EntityEditor.messages={}}BX.Crm.EntityEditor.setDefault=function(t){BX.Crm.EntityEditor.defaultInstance=t};BX.Crm.EntityEditor.getDefault=function(){return BX.Crm.EntityEditor.defaultInstance};BX.Crm.EntityEditor.create=function(t,e){var i=new BX.Crm.EntityEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityEditorMode==="undefined"){BX.Crm.EntityEditorMode={intermediate:0,view:1,edit:2,parse:function(t){t=t.toLowerCase();if(t==="view"){return this.view}else if(t==="edit"){return this.edit}return this.intermediate}}}if(typeof BX.Crm.EntityEditorPriority==="undefined"){BX.Crm.EntityEditorPriority={undefined:0,normal:1,high:2}}if(typeof BX.Crm.EditorDialogButtonType==="undefined"){BX.Crm.EditorDialogButtonType={undefined:0,accept:1,cancel:2}}if(typeof BX.Crm.EditorDialogButton==="undefined"){BX.Crm.EditorDialogButton=function(){this._id="";this._type=BX.Crm.EditorDialogButtonType.undefined;this._settings={};this._dialog=null};BX.Crm.EditorDialogButton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._type=BX.prop.getInteger(this._settings,"type",BX.Crm.EditorDialogButtonType.undefined);this._dialog=BX.prop.get(this._settings,"dialog",null)},getId:function(){return this._id},getDialog:function(){return this._dialog},prepareContent:function(){if(this._type===BX.Crm.EditorDialogButtonType.accept){return new BX.PopupWindowButton({text:BX.prop.getString(this._settings,"text",this._id),className:"popup-window-button-create",events:{click:BX.delegate(this.onClick,this)}})}else if(this._type===BX.Crm.EditorDialogButtonType.cancel){return new BX.PopupWindowButtonLink({text:BX.prop.getString(this._settings,"text",this._id),className:"webform-button-link-cancel",events:{click:BX.delegate(this.onClick,this)}})}else{return new BX.PopupWindowButton({text:BX.prop.getString(this._settings,"text",this._id),events:{click:BX.delegate(this.onClick,this)}})}},onClick:function(t){var e=BX.prop.getFunction(this._settings,"callback",null);if(e){e(this)}}};BX.Crm.EditorDialogButton.create=function(t,e){var i=new BX.Crm.EditorDialogButton;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorDialog==="undefined"){BX.Crm.EditorDialog=function(){this._id="";this._settings={};this._popup=null;this._buttons=null};BX.Crm.EditorDialog.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{}},getSetting:function(t,e){return BX.prop.get(this._settings,t,e)},open:function(){this._popup=new BX.PopupWindow(this._id,BX.prop.getElementNode(this._settings,"anchor",null),{autoHide:false,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,zIndex:BX.prop.getInteger(this._settings,"zIndex",0),bindOptions:{forceBindPosition:true},titleBar:BX.prop.getString(this._settings,"title","No title"),content:BX.prop.getString(this._settings,"content",""),buttons:this.prepareButtons(),events:{}});this._popup.show()},close:function(){if(this._popup){this._popup.close()}},prepareButtons:function(){var t=[];this._buttons=[];var e=BX.prop.getArray(this._settings,"buttons",[]);for(var i=0,n=e.length;i<n;i++){var r=e[i];r["dialog"]=this;var o=BX.Crm.EditorDialogButton.create(BX.prop.getString(r,"id",""),r);this._buttons.push(o);t.push(o.prepareContent())}return t}};BX.Crm.EditorDialog.create=function(t,e){var i=new BX.Crm.EditorDialog;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityValidator==="undefined"){BX.Crm.EntityValidator=function(){this._settings={};this._editor=null;this._data=null};BX.Crm.EntityValidator.prototype={initialize:function(t){this._settings=t?t:{};this._editor=BX.prop.get(this._settings,"editor",null);this._data=BX.prop.getObject(this._settings,"data",{});this.doInitialize()},doInitialize:function(){},release:function(){},getData:function(){return this._data},getDataStringParam:function(t,e){return BX.prop.getString(this._data,t,e)},getErrorMessage:function(){return BX.prop.getString(this._settings,"message","")},validate:function(t){return true},processControlChange:function(t){}}}if(typeof BX.Crm.EntityPersonValidator==="undefined"){BX.Crm.EntityPersonValidator=function(){BX.Crm.EntityPersonValidator.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityPersonValidator,BX.Crm.EntityValidator);BX.Crm.EntityPersonValidator.prototype.doInitialize=function(){this._nameField=this._editor.getControlById(this.getDataStringParam("nameField",""));if(this._nameField){this._nameField.addValidator(this)}this._lastNameField=this._editor.getControlById(this.getDataStringParam("lastNameField",""));if(this._lastNameField){this._lastNameField.addValidator(this)}};BX.Crm.EntityPersonValidator.prototype.release=function(){if(this._nameField){this._nameField.removeValidator(this)}if(this._lastNameField){this._lastNameField.removeValidator(this)}};BX.Crm.EntityPersonValidator.prototype.validate=function(t){var e=this._nameField.isActive();var i=this._lastNameField.isActive();if(!e&&!i){return true}var n=e?this._nameField.getRuntimeValue():this._nameField.getValue();var r=i?this._lastNameField.getRuntimeValue():this._lastNameField.getValue();if(n!==""||r!==""){return true}if(n===""&&e){t.addError(BX.Crm.EntityValidationError.create({field:this._nameField}));this._nameField.showError(this.getErrorMessage())}if(r===""&&i){t.addError(BX.Crm.EntityValidationError.create({field:this._lastNameField}));this._lastNameField.showError(this.getErrorMessage())}return false};BX.Crm.EntityPersonValidator.prototype.processFieldChange=function(t){if(t!==this._nameField&&t!==this._lastNameField){return}if(this._nameField){this._nameField.clearError()}if(this._lastNameField){this._lastNameField.clearError()}};BX.Crm.EntityPersonValidator.create=function(t){var e=new BX.Crm.EntityPersonValidator;e.initialize(t);return e}}if(typeof BX.Crm.EntityValidationError==="undefined"){BX.Crm.EntityValidationError=function(){this._settings={};this._field=null;this._message=""};BX.Crm.EntityValidationError.prototype={initialize:function(t){this._settings=t?t:{};this._field=BX.prop.get(this._settings,"field",null);this._message=BX.prop.getString(this._settings,"message","")},getField:function(){return this._field},getMessage:function(){return this._message}};BX.Crm.EntityValidationError.create=function(t){var e=new BX.Crm.EntityValidationError;e.initialize(t);return e}}if(typeof BX.Crm.EntityValidationResult==="undefined"){BX.Crm.EntityValidationResult=function(){this._settings={};this._errors=[]};BX.Crm.EntityValidationResult.prototype={initialize:function(t){this._settings=t?t:{}},getStatus:function(){return this._errors.length===0},addError:function(t){this._errors.push(t)},getErrors:function(){return this._errors},addResult:function(t){var e=t.getErrors();for(var i=0,n=e.length;i<n;i++){this._errors.push(e[i])}},getTopmostField:function(){var t=null;var e=null;for(var i=0,n=this._errors.length;i<n;i++){var r=this._errors[i].getField();if(!t){t=r;e=r.getPosition()["top"];continue}var o=r.getPosition();if(!o){continue}var s=r.getPosition()["top"];if(s<e){t=r;e=s}}return t}};BX.Crm.EntityValidationResult.create=function(t){var e=new BX.Crm.EntityValidationResult;e.initialize(t);return e}}if(typeof BX.Crm.EntityConfig==="undefined"){BX.Crm.EntityConfig=function(){this._id="";this._settings={};this._data={};this._items=[];this._serviceUrl="";this._isChanged=false};BX.Crm.EntityConfig.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._data=BX.prop.getArray(this._settings,"data");this._items=[];for(var i=0,n=this._data.length;i<n;i++){var r=this._data[i];var o=BX.prop.getString(r,"type","");if(o==="section"){this._items.push(BX.Crm.EntityConfigSection.create({data:r}))}else{this._items.push(BX.Crm.EntityConfigField.create({data:r}))}}this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","")},findItemByName:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getName()===t){return n}}return null},findItemIndexByName:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getName()===t){return e}}return-1},toJSON:function(){var t=[];for(var e=0,i=this._items.length;e<i;e++){t.push(this._items[e].toJSON())}return t},addSchemeElementAt:function(t,e){var i=t.createConfigItem();var n=t.getType()==="section"?BX.Crm.EntityConfigSection.create({data:i}):BX.Crm.EntityConfigField.create({data:i});if(e>=0&&e<this._items.length){this._items.splice(e,0,n)}else{this._items.push(n)}this._isChanged=true},moveSchemeElement:function(t,e){var i=this._items.length;var n=i-1;if(e<0||e>i){e=n}var r=this.findItemIndexByName(t.getName());if(r<0||r===e){return}var o=this._items[r];this._items.splice(r,1);i--;if(e<i){this._items.splice(e,0,o)}else{this._items.push(o)}this._isChanged=true},updateSchemeElement:function(t){var e;var i=t.getParent();if(i){var n=this.findItemByName(i.getName());if(n){e=n.findFieldIndexByName(t.getName());if(e>=0){n.setField(BX.Crm.EntityConfigField.create({data:t.createConfigItem()}),e);this._isChanged=true}}}else{e=this.findItemIndexByName(t.getName());if(e>=0){if(t.getType()==="section"){this._items[e]=BX.Crm.EntityConfigSection.create({data:t.createConfigItem()})}else{this._items[e]=BX.Crm.EntityConfigField.create({data:t.createConfigItem()})}this._isChanged=true}}},removeSchemeElement:function(t){var e=this.findItemIndexByName(t.getName());if(e<0){return}this._items.splice(e,1);this._isChanged=true},isChanged:function(){return this._isChanged},registerField:function(t){var e=t.getParent();if(!e){return}var i=this.findItemByName(e.getName());if(!i){return}i.addField(BX.Crm.EntityConfigField.create({data:t.createConfigItem()}));this.save()},unregisterField:function(t){var e=t.getParent();if(!e){return}var i=this.findItemByName(e.getName());if(!i){return}var n=i.findFieldByName(t.getName());if(!n){return}i.removeFieldByIndex(n.getIndex());this.save()},save:function(t){var e=new BX.Promise;if(!this._isChanged&&!t){window.setTimeout(function(){e.fulfill()},0);return e}var i={guid:this._id,action:"saveconfig",config:this.toJSON()};if(t){i["forAllUsers"]="Y";i["delete"]="Y"}BX.ajax.post(this._serviceUrl,i,function(){e.fulfill()});this._isChanged=false;return e},reset:function(t){var e={guid:this._id,action:"resetconfig",config:this.toJSON()};if(t){e["forAllUsers"]="Y"}var i=new BX.Promise;BX.ajax.post(this._serviceUrl,e,function(){i.fulfill()});return i}};BX.Crm.EntityConfig.create=function(t,e){var i=new BX.Crm.EntityConfig;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityConfigItem==="undefined"){BX.Crm.EntityConfigItem=function(){this._settings={};this._data={};this._name="";this._title=""};BX.Crm.EntityConfigItem.prototype={initialize:function(t){this._settings=t?t:{};this._data=BX.prop.getObject(this._settings,"data",[]);this._name=BX.prop.getString(this._data,"name","");this._title=BX.prop.getString(this._data,"title","");this.doInitialize()},doInitialize:function(){},getType:function(){return""},getName:function(){return this._name},getTitle:function(){return this._title},toJSON:function(){return{}}}}if(typeof BX.Crm.EntityConfigSection==="undefined"){BX.Crm.EntityConfigSection=function(){BX.Crm.EntityConfigSection.superclass.constructor.apply(this);this._fields=[]};BX.extend(BX.Crm.EntityConfigSection,BX.Crm.EntityConfigItem);BX.Crm.EntityConfigSection.prototype.doInitialize=function(){this._fields=[];var t=BX.prop.getArray(this._data,"elements",[]);for(var e=0,i=t.length;e<i;e++){var n=BX.Crm.EntityConfigField.create({data:t[e]});n.setIndex(e);this._fields.push(n)}};BX.Crm.EntityConfigSection.prototype.getType=function(){return"section"};BX.Crm.EntityConfigSection.prototype.getFields=function(){return this._fields};BX.Crm.EntityConfigSection.prototype.findFieldByName=function(t){var e=this.findFieldIndexByName(t);return e>=0?this._fields[e]:null};BX.Crm.EntityConfigSection.prototype.findFieldIndexByName=function(t){for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e];if(n.getName()===t){return e}}return-1};BX.Crm.EntityConfigSection.prototype.addField=function(t){this._fields.push(t)};BX.Crm.EntityConfigSection.prototype.setField=function(t,e){this._fields[e]=t};BX.Crm.EntityConfigSection.prototype.removeFieldByIndex=function(t){var e=this._fields.length;if(t<0||t>=e){return false}this._fields.splice(t,1);return true};BX.Crm.EntityConfigSection.prototype.toJSON=function(){var t={name:this._name,title:this._title,type:"section",elements:[]};for(var e=0,i=this._fields.length;e<i;e++){t.elements.push(this._fields[e].toJSON())}return t};BX.Crm.EntityConfigSection.create=function(t){var e=new BX.Crm.EntityConfigSection;e.initialize(t);return e}}if(typeof BX.Crm.EntityConfigField==="undefined"){BX.Crm.EntityConfigField=function(){BX.Crm.EntityConfigField.superclass.constructor.apply(this);this._index=-1};BX.extend(BX.Crm.EntityConfigField,BX.Crm.EntityConfigItem);BX.Crm.EntityConfigField.prototype.toJSON=function(){var t={name:this._name};if(this._title!==""){t["title"]=this._title}return t};BX.Crm.EntityConfigField.prototype.getIndex=function(){return this._index};BX.Crm.EntityConfigField.prototype.setIndex=function(t){this._index=t};BX.Crm.EntityConfigField.create=function(t){var e=new BX.Crm.EntityConfigField;e.initialize(t);return e}}if(typeof BX.Crm.EntityScheme==="undefined"){BX.Crm.EntityScheme=function(){this._id="";this._settings={};this._elements=null;this._availableElements=null};BX.Crm.EntityScheme.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._elements=[];this._availableElements=[];var i,n;var r=BX.prop.getArray(this._settings,"current",[]);for(i=0,n=r.length;i<n;i++){this._elements.push(BX.Crm.EntitySchemeElement.create(r[i]))}var o=BX.prop.getArray(this._settings,"available",[]);for(i=0,n=o.length;i<n;i++){this._availableElements.push(BX.Crm.EntitySchemeElement.create(o[i]))}},getId:function(){return this._id},getElements:function(){return[].concat(this._elements)},getAvailableElements:function(){return[].concat(this._availableElements)},setAvailableElements:function(t){this._availableElements=BX.type.isArray(t)?t:[]}};BX.Crm.EntityScheme.create=function(t,e){var i=new BX.Crm.EntityScheme;i.initialize(t,e);return i}}if(typeof BX.Crm.EntitySchemeElement==="undefined"){BX.Crm.EntitySchemeElement=function(){this._settings={};this._name="";this._type="";this._title="";this._originalTitle="";this._isEditable=true;this._isTransferable=true;this._isRequired=false;this._isRequiredConditionally=false;this._isHeading=false;this._visibilityPolicy=BX.Crm.EntityEditorVisibilityPolicy.always;this._data=null;this._elements=null;this._parent=null};BX.Crm.EntitySchemeElement.prototype={initialize:function(t){this._settings=t?t:{};this._name=BX.prop.getString(this._settings,"name","");this._type=BX.prop.getString(this._settings,"type","");this._isEditable=BX.prop.getBoolean(this._settings,"editable",true);this._isTransferable=BX.prop.getBoolean(this._settings,"transferable",true);this._isRequired=BX.prop.getBoolean(this._settings,"required",false);this._isRequiredConditionally=BX.prop.getBoolean(this._settings,"requiredConditionally",false);this._isHeading=BX.prop.getBoolean(this._settings,"isHeading",false);this._visibilityPolicy=BX.Crm.EntityEditorVisibilityPolicy.parse(BX.prop.getString(this._settings,"visibilityPolicy",""));this._data=BX.prop.getObject(this._settings,"data",{});var e=BX.prop.getString(this._settings,"title","");var i=BX.prop.getString(this._settings,"originalTitle","");if(e!==""&&i===""){i=e}else if(i!==""&&e===""){e=i}this._title=e;this._originalTitle=i;this._elements=[];var n=BX.prop.getArray(this._settings,"elements",[]);for(var r=0,o=n.length;r<o;r++){this._elements.push(BX.Crm.EntitySchemeElement.create(n[r]))}},getName:function(){return this._name},getType:function(){return this._type},getTitle:function(){return this._title},setTitle:function(t){this._title=t},getOriginalTitle:function(){return this._originalTitle},isEditable:function(){return this._isEditable},isTransferable:function(){return this._isTransferable},isRequired:function(){return this._isRequired},isRequiredConditionally:function(){return this._isRequiredConditionally},isHeading:function(){return this._isHeading},getVisibilityPolicy:function(){return this._visibilityPolicy},getData:function(){return this._data},setData:function(t){this._data=t},getDataParam:function(t,e){return BX.prop.get(this._data,t,e)},getDataStringParam:function(t,e){return BX.prop.getString(this._data,t,e)},getDataIntegerParam:function(t,e){return BX.prop.getInteger(this._data,t,e)},getDataBooleanParam:function(t,e){return BX.prop.getBoolean(this._data,t,e)},getDataObjectParam:function(t,e){return BX.prop.getObject(this._data,t,e)},getDataArrayParam:function(t,e){return BX.prop.getArray(this._data,t,e)},getElements:function(){return this._elements},setElements:function(t){this._elements=t},getAffectedFields:function(){var t=this.getDataArrayParam("affectedFields",[]);if(t.length===0){t.push(this._name)}return t},getParent:function(){return this._parent},setParent:function(t){this._parent=t instanceof BX.Crm.EntitySchemeElement?t:null},createConfigItem:function(){var t={name:this._name};if(this._type==="section"){t["type"]="section";if(this._title!==""){t["title"]=this._title}t["elements"]=[];for(var e=0,i=this._elements.length;e<i;e++){t["elements"].push(this._elements[e].createConfigItem())}}else{if(this._title!==""&&this._title!==this._originalTitle){t["title"]=this._title}}return t},clone:function(){return BX.Crm.EntitySchemeElement.create(BX.clone(this._settings))}};BX.Crm.EntitySchemeElement.create=function(t){var e=new BX.Crm.EntitySchemeElement;e.initialize(t);return e}}if(typeof BX.Crm.EntityEditorValidatorFactory==="undefined"){BX.Crm.EntityEditorValidatorFactory={create:function(t,e){if(t==="person"){return BX.Crm.EntityPersonValidator.create(e)}return null}}}if(typeof BX.Crm.EntityEditorControlFactory==="undefined"){BX.Crm.EntityEditorControlFactory={create:function(t,e,i){if(t==="section"){return BX.Crm.EntityEditorSection.create(e,i)}else if(t==="text"){return BX.Crm.EntityEditorText.create(e,i)}else if(t==="number"){return BX.Crm.EntityEditorNumber.create(e,i)}else if(t==="datetime"){return BX.Crm.EntityEditorDatetime.create(e,i)}else if(t==="boolean"){return BX.Crm.EntityEditorBoolean.create(e,i)}else if(t==="list"){return BX.Crm.EntityEditorList.create(e,i)}else if(t==="html"){return BX.Crm.EntityEditorHtml.create(e,i)}else if(t==="money"){return BX.Crm.EntityEditorMoney.create(e,i)}else if(t==="image"){return BX.Crm.EntityEditorImage.create(e,i)}else if(t==="user"){return BX.Crm.EntityEditorUser.create(e,i)}else if(t==="address"){return BX.Crm.EntityEditorAddress.create(e,i)}else if(t==="client"){return BX.Crm.EntityEditorClient.create(e,i)}else if(t==="multifield"){return BX.Crm.EntityEditorMultifield.create(e,i)}else if(t==="product_row_summary"){return BX.Crm.EntityEditorProductRowSummary.create(e,i)}else if(t==="requisite_selector"){return BX.Crm.EntityEditorRequisiteSelector.create(e,i)}else if(t==="requisite_list"){return BX.Crm.EntityEditorRequisiteList.create(e,i)}else if(t==="userField"){return BX.Crm.EntityEditorUserField.create(e,i)}else if(t==="userFieldConfig"){return BX.Crm.EntityEditorUserFieldConfigurator.create(e,i)}else if(t==="recurring"){return BX.Crm.EntityEditorRecurring.create(e,i)}return null}}}if(typeof BX.Crm.EntityEditorControllerFactory==="undefined"){BX.Crm.EntityEditorControllerFactory={create:function(t,e,i){if(t==="product_row_proxy"){return BX.Crm.EntityEditorProductRowProxy.create(e,i)}return null}}}if(typeof BX.Crm.EntityEditorModelFactory==="undefined"){BX.Crm.EntityEditorModelFactory={create:function(t,e,i){if(t===BX.CrmEntityType.enumeration.lead){return BX.Crm.LeadModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.contact){return BX.Crm.ContactModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.company){return BX.Crm.CompanyModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.deal){return BX.Crm.DealModel.create(e,i)}else if(t===BX.CrmEntityType.enumeration.dealrecurring){return BX.Crm.DealRecurringModel.create(e,i)}return BX.Crm.EntityModel.create(e,i)}}}if(typeof BX.Crm.EntityModel==="undefined"){BX.Crm.EntityModel=function(){this._id="";this._settings={};this._data=null;this._lockedFields=null;this._changeNotifier=null;this._lockNotifier=null};BX.Crm.EntityModel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._data=BX.prop.getObject(this._settings,"data",{});this._lockedFields={};this._changeNotifier=BX.CrmNotifier.create(this);this._lockNotifier=BX.CrmNotifier.create(this);this.doInitialize()},doInitialize:function(){},getEntityTypeId:function(){return BX.CrmEntityType.enumeration.undefined},getEntityId:function(){return BX.prop.getInteger(this._data,"ID",0)},getOwnerInfo:function(){return{ownerID:this.getEntityId(),ownerType:BX.CrmEntityType.resolveName(this.getEntityTypeId())}},getField:function(t,e){if(e===undefined){e=null}return BX.prop.get(this._data,t,e)},getStringField:function(t,e){if(e===undefined){e=null}return BX.prop.getString(this._data,t,e)},getIntegerField:function(t,e){if(e===undefined){e=null}return BX.prop.getInteger(this._data,t,e)},getNumberField:function(t,e){if(e===undefined){e=null}return BX.prop.getNumber(this._data,t,e)},setField:function(t,e,i){if(this._data.hasOwnProperty(t)&&this._data[t]===e){return}this._data[t]=e;if(!BX.type.isPlainObject(i)){i={}}if(BX.prop.getBoolean(i,"enableNotification",true)){this._changeNotifier.notify([{name:t,originator:BX.prop.get(i,"originator",null)}]);BX.onCustomEvent(window,"Crm.EntityModel.Change",[this,{entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId(),fieldName:t}])}},getData:function(){return this._data},setData:function(t,e){this._data=BX.type.isPlainObject(t)?t:{};if(BX.prop.getBoolean(e,"enableNotification",true)){this._changeNotifier.notify([{forAll:true,originator:BX.prop.get(e,"originator",null)}]);BX.onCustomEvent(window,"Crm.EntityModel.Change",[this,{entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId(),forAll:true}])}},getSchemeField:function(t,e,i){return this.getField(t.getDataStringParam(e,""),i)},getMappedField:function(t,e,i){var n=BX.prop.getString(t,e,"");return n!==""?this.getField(n,i):i},setMappedField:function(t,e,i){var n=BX.prop.getString(t,e,"");if(n!==""){this.setField(n,i)}},save:function(){},lockField:function(t){if(this._lockedFields.hasOwnProperty(t)){return}this._lockedFields[t]=true;this._lockNotifier.notify([{name:name,isLocked:true}])},unlockField:function(t){if(!this._lockedFields.hasOwnProperty(t)){return}delete this._lockedFields[t];this._lockNotifier.notify([{name:name,isLocked:false}])},isFieldLocked:function(t){return this._lockedFields.hasOwnProperty(t)},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},addLockListener:function(t){this._lockNotifier.addListener(t)},removeLockListener:function(t){this._lockNotifier.removeListener(t)},isCaptionEditable:function(){return false},getCaption:function(){return""},setCaption:function(t){},prepareCaptionData:function(t){}};BX.Crm.EntityModel.create=function(t,e){var i=new BX.Crm.EntityModel;i.initialize(t,e);return i}}if(typeof BX.Crm.LeadModel==="undefined"){BX.Crm.LeadModel=function(){BX.Crm.LeadModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.LeadModel,BX.Crm.EntityModel);BX.Crm.LeadModel.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this))};BX.Crm.LeadModel.prototype.onEntityProgressChange=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this.getEntityTypeId()||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}var i=BX.prop.getString(e,"currentStepId","");if(i!==this.getField("STATUS_ID","")){this.setField("STATUS_ID",i)}};BX.Crm.LeadModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.lead};BX.Crm.LeadModel.prototype.isCaptionEditable=function(){return true};BX.Crm.LeadModel.prototype.getCaption=function(){var t=this.getField("TITLE");return BX.type.isString(t)?t:""};BX.Crm.LeadModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.LeadModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.LeadModel.create=function(t,e){var i=new BX.Crm.LeadModel;i.initialize(t,e);return i}}if(typeof BX.Crm.ContactModel==="undefined"){BX.Crm.ContactModel=function(){BX.Crm.ContactModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.ContactModel,BX.Crm.EntityModel);BX.Crm.ContactModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.contact};BX.Crm.ContactModel.prototype.getCaption=function(){return this.getField("FORMATTED_NAME","")};BX.Crm.ContactModel.create=function(t,e){var i=new BX.Crm.ContactModel;i.initialize(t,e);return i}}if(typeof BX.Crm.CompanyModel==="undefined"){BX.Crm.CompanyModel=function(){BX.Crm.CompanyModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.CompanyModel,BX.Crm.EntityModel);BX.Crm.CompanyModel.prototype.isCaptionEditable=function(){return true};BX.Crm.CompanyModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.company};BX.Crm.CompanyModel.prototype.getCaption=function(){return this.getField("TITLE","")};BX.Crm.CompanyModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.CompanyModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.CompanyModel.create=function(t,e){var i=new BX.Crm.CompanyModel;i.initialize(t,e);return i}}if(typeof BX.Crm.DealModel==="undefined"){BX.Crm.DealModel=function(){BX.Crm.DealModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.DealModel,BX.Crm.EntityModel);BX.Crm.DealModel.prototype.doInitialize=function(){BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this))};BX.Crm.DealModel.prototype.onEntityProgressChange=function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this.getEntityTypeId()||BX.prop.getInteger(e,"entityId",0)!==this.getEntityId()){return}var i=BX.prop.getString(e,"currentStepId","");if(i!==this.getField("STAGE_ID","")){this.setField("STAGE_ID",i)}};BX.Crm.DealModel.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.deal};BX.Crm.DealModel.prototype.isCaptionEditable=function(){return true};BX.Crm.DealModel.prototype.getCaption=function(){var t=this.getField("TITLE");return BX.type.isString(t)?t:""};BX.Crm.DealModel.prototype.setCaption=function(t){this.setField("TITLE",t)};BX.Crm.DealModel.prototype.prepareCaptionData=function(t){t["TITLE"]=this.getField("TITLE","")};BX.Crm.DealModel.create=function(t,e){var i=new BX.Crm.DealModel;i.initialize(t,e);return i}}if(typeof BX.Crm.DealRecurringModel==="undefined"){BX.Crm.DealRecurringModel=function(){BX.Crm.DealRecurringModel.superclass.constructor.apply(this)};BX.extend(BX.Crm.DealRecurringModel,BX.Crm.DealModel);BX.Crm.DealRecurringModel.create=function(t,e){var i=new BX.Crm.DealRecurringModel;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorDragItem==="undefined"){BX.Crm.EditorDragItem=function(){};BX.Crm.EditorDragItem.prototype={getContextId:function(){return""},createGhostNode:function(){return null},processDragStart:function(){},processDragPositionChange:function(t,e){},processDragStop:function(){}}}if(typeof BX.Crm.EditorFieldDragItem==="undefined"){BX.Crm.EditorFieldDragItem=function(){BX.Crm.EditorFieldDragItem.superclass.constructor.apply(this);this._control=null;this._contextId=""};BX.extend(BX.Crm.EditorFieldDragItem,BX.Crm.EditorDragItem);BX.Crm.EditorFieldDragItem.prototype.initialize=function(t){this._control=BX.prop.get(t,"control");if(!this._control){throw"Crm.EditorFieldDragItem: The 'control' parameter is not defined in settings or empty."}this._contextId=BX.prop.getString(t,"contextId","")};BX.Crm.EditorFieldDragItem.prototype.getControl=function(){return this._control};BX.Crm.EditorFieldDragItem.prototype.getContextId=function(){return this._contextId!==""?this._contextId:BX.Crm.EditorFieldDragItem.contextId};BX.Crm.EditorFieldDragItem.prototype.createGhostNode=function(){return this._control.createGhostNode()};BX.Crm.EditorFieldDragItem.prototype.processDragStart=function(){window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorFieldDragItem.contextId,true);BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorSectionDragItem.contextId,false);BX.Crm.EditorDragContainerController.refreshAll()});this._control.getWrapper().style.opacity="0.2"};BX.Crm.EditorFieldDragItem.prototype.processDragPositionChange=function(t,e){var i=this._control.getParent();if(!i){return}var n=i.getPosition();if(t.y<n.top){t.y=n.top}if(t.y+e.height>n.bottom){t.y=n.bottom-e.height}if(t.x<n.left){t.x=n.left}if(t.x+e.width>n.right){t.x=n.right-e.width}};BX.Crm.EditorFieldDragItem.prototype.processDragStop=function(){window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorSectionDragItem.contextId,true);BX.Crm.EditorDragContainerController.refreshAll()});this._control.getWrapper().style.opacity="1"};BX.Crm.EditorFieldDragItem.contextId="editor_field";BX.Crm.EditorFieldDragItem.create=function(t){var e=new BX.Crm.EditorFieldDragItem;e.initialize(t);return e}}if(typeof BX.Crm.EditorSectionDragItem==="undefined"){BX.Crm.EditorSectionDragItem=function(){BX.Crm.EditorSectionDragItem.superclass.constructor.apply(this);this._control=null};BX.extend(BX.Crm.EditorSectionDragItem,BX.Crm.EditorDragItem);BX.Crm.EditorSectionDragItem.prototype.initialize=function(t){this._control=BX.prop.get(t,"control");if(!this._control){throw"Crm.EditorSectionDragItem: The 'control' parameter is not defined in settings or empty."}};BX.Crm.EditorSectionDragItem.prototype.getControl=function(){return this._control};BX.Crm.EditorSectionDragItem.prototype.getContextId=function(){return BX.Crm.EditorSectionDragItem.contextId};BX.Crm.EditorSectionDragItem.prototype.createGhostNode=function(){return this._control.createGhostNode()};BX.Crm.EditorSectionDragItem.prototype.processDragStart=function(){BX.addClass(document.body,"crm-entity-widgets-drag");window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorSectionDragItem.contextId,true);BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorFieldDragItem.contextId,false);BX.Crm.EditorDragContainerController.refreshAll()});this._control.getWrapper().style.opacity="0.2"};BX.Crm.EditorSectionDragItem.prototype.processDragStop=function(){BX.removeClass(document.body,"crm-entity-widgets-drag");window.setTimeout(function(){BX.Crm.EditorDragContainerController.enable(BX.Crm.EditorFieldDragItem.contextId,true);BX.Crm.EditorDragContainerController.refreshAll()});this._control.getWrapper().style.opacity="1"};BX.Crm.EditorSectionDragItem.contextId="editor_section";BX.Crm.EditorSectionDragItem.create=function(t){var e=new BX.Crm.EditorSectionDragItem;e.initialize(t);return e}}if(typeof BX.Crm.EditorDragItemController==="undefined"){BX.Crm.EditorDragItemController=function(){BX.Crm.EditorDragItemController.superclass.constructor.apply(this);this._charge=null;this._preserveDocument=true};BX.extend(BX.Crm.EditorDragItemController,BX.CrmCustomDragItem);BX.Crm.EditorDragItemController.prototype.doInitialize=function(){this._charge=this.getSetting("charge");if(!this._charge){throw"Crm.EditorDragItemController: The 'charge' parameter is not defined in settings or empty."}this._startNotifier=BX.CrmNotifier.create(this);this._stopNotifier=BX.CrmNotifier.create(this);this._ghostOffset={x:0,y:-40}};BX.Crm.EditorDragItemController.prototype.addStartListener=function(t){this._startNotifier.addListener(t)};BX.Crm.EditorDragItemController.prototype.removeStartListener=function(t){this._startNotifier.removeListener(t)};BX.Crm.EditorDragItemController.prototype.addStopListener=function(t){this._stopNotifier.addListener(t)};BX.Crm.EditorDragItemController.prototype.removeStopListener=function(t){this._stopNotifier.removeListener(t)};BX.Crm.EditorDragItemController.prototype.getCharge=function(){return this._charge};BX.Crm.EditorDragItemController.prototype.createGhostNode=function(){if(this._ghostNode){return this._ghostNode}this._ghostNode=this._charge.createGhostNode();document.body.appendChild(this._ghostNode)};BX.Crm.EditorDragItemController.prototype.getGhostNode=function(){return this._ghostNode};BX.Crm.EditorDragItemController.prototype.removeGhostNode=function(){if(this._ghostNode){document.body.removeChild(this._ghostNode);this._ghostNode=null}};BX.Crm.EditorDragItemController.prototype.getContextId=function(){return this._charge.getContextId()};BX.Crm.EditorDragItemController.prototype.getContextData=function(){return{contextId:this._charge.getContextId(),charge:this._charge}};BX.Crm.EditorDragItemController.prototype.processDragStart=function(){BX.Crm.EditorDragItemController.current=this;this._charge.processDragStart();BX.Crm.EditorDragContainerController.refresh(this._charge.getContextId());this._startNotifier.notify([])};BX.Crm.EditorDragItemController.prototype.processDrag=function(t,e){};BX.Crm.EditorDragItemController.prototype.processDragPositionChange=function(t){this._charge.processDragPositionChange(t,BX.pos(this.getGhostNode()))};BX.Crm.EditorDragItemController.prototype.processDragStop=function(){BX.Crm.EditorDragItemController.current=null;this._charge.processDragStop();BX.Crm.EditorDragContainerController.refreshAfter(this._charge.getContextId(),300);this._stopNotifier.notify([])};BX.Crm.EditorDragItemController.current=null;BX.Crm.EditorDragItemController.create=function(t,e){var i=new BX.Crm.EditorDragItemController;i.initialize(t,e);return i}}if(typeof BX.Crm.EditorDragContainer==="undefined"){BX.Crm.EditorDragContainer=function(){};BX.Crm.EditorDragContainer.prototype={getContextId:function(){return""},getPriority:function(){return 100},hasPlaceHolder:function(){return false},createPlaceHolder:function(t){return null},getPlaceHolder:function(){return null},removePlaceHolder:function(){},getChildNodes:function(){return[]},getChildNodeCount:function(){return 0}}}if(typeof BX.Crm.EditorFieldDragContainer==="undefined"){BX.Crm.EditorFieldDragContainer=function(){BX.Crm.EditorFieldDragContainer.superclass.constructor.apply(this);this._section=null;this._context=""};BX.extend(BX.Crm.EditorFieldDragContainer,BX.Crm.EditorDragContainer);BX.Crm.EditorFieldDragContainer.prototype.initialize=function(t){this._section=BX.prop.get(t,"section");if(!this._section){throw"Crm.EditorSectionDragContainer: The 'section' parameter is not defined in settings or empty."}this._context=BX.prop.getString(t,"context","")};BX.Crm.EditorFieldDragContainer.prototype.getSection=function(){return this._section};BX.Crm.EditorFieldDragContainer.prototype.getContextId=function(){return this._context!==""?this._context:BX.Crm.EditorFieldDragItem.contextId};BX.Crm.EditorFieldDragContainer.prototype.getPriority=function(){return 10};BX.Crm.EditorFieldDragContainer.prototype.hasPlaceHolder=function(){return this._section.hasPlaceHolder()};BX.Crm.EditorFieldDragContainer.prototype.createPlaceHolder=function(t){return this._section.createPlaceHolder(t)};BX.Crm.EditorFieldDragContainer.prototype.getPlaceHolder=function(){return this._section.getPlaceHolder()};BX.Crm.EditorFieldDragContainer.prototype.removePlaceHolder=function(){this._section.removePlaceHolder()};BX.Crm.EditorFieldDragContainer.prototype.getChildNodes=function(){var t=[];var e=this._section.getChildren();for(var i=0,n=e.length;i<n;i++){t.push(e[i].getWrapper())}return t};BX.Crm.EditorFieldDragContainer.prototype.getChildNodeCount=function(){return this._section.getChildCount()};BX.Crm.EditorFieldDragContainer.create=function(t){var e=new BX.Crm.EditorFieldDragContainer;e.initialize(t);return e}}if(typeof BX.Crm.EditorSectionDragContainer==="undefined"){BX.Crm.EditorSectionDragContainer=function(){BX.Crm.EditorSectionDragContainer.superclass.constructor.apply(this);this._editor=null};BX.extend(BX.Crm.EditorSectionDragContainer,BX.Crm.EditorDragContainer);BX.Crm.EditorSectionDragContainer.prototype.initialize=function(t){this._editor=BX.prop.get(t,"editor");if(!this._editor){throw"Crm.EditorSectionDragContainer: The 'editor' parameter is not defined in settings or empty."}};BX.Crm.EditorSectionDragContainer.prototype.getEditor=function(){return this._editor};BX.Crm.EditorSectionDragContainer.prototype.getContextId=function(){return BX.Crm.EditorSectionDragItem.contextId};BX.Crm.EditorSectionDragContainer.prototype.getPriority=function(){return 20};BX.Crm.EditorSectionDragContainer.prototype.hasPlaceHolder=function(){return this._editor.hasPlaceHolder()};BX.Crm.EditorSectionDragContainer.prototype.createPlaceHolder=function(t){return this._editor.createPlaceHolder(t)};BX.Crm.EditorSectionDragContainer.prototype.getPlaceHolder=function(){return this._editor.getPlaceHolder()};BX.Crm.EditorSectionDragContainer.prototype.removePlaceHolder=function(){this._editor.removePlaceHolder()};BX.Crm.EditorSectionDragContainer.prototype.getChildNodes=function(){var t=[];var e=this._editor.getControls();for(var i=0,n=e.length;i<n;i++){t.push(e[i].getWrapper())}return t};BX.Crm.EditorSectionDragContainer.prototype.getChildNodeCount=function(){return this._editor.getControlCount()};BX.Crm.EditorSectionDragContainer.create=function(t){var e=new BX.Crm.EditorSectionDragContainer;e.initialize(t);return e}}if(typeof BX.Crm.EditorDragContainerController==="undefined"){BX.Crm.EditorDragContainerController=function(){BX.Crm.EditorDragContainerController.superclass.constructor.apply(this);this._charge=null};BX.extend(BX.Crm.EditorDragContainerController,BX.CrmCustomDragContainer);BX.Crm.EditorDragContainerController.prototype.doInitialize=function(){this._charge=this.getSetting("charge");if(!this._charge){throw"Crm.EditorDragContainerController: The 'charge' parameter is not defined in settings or empty."}};BX.Crm.EditorDragContainerController.prototype.getCharge=function(){return this._charge};BX.Crm.EditorDragContainerController.prototype.createPlaceHolder=function(t){var e=BX.pos(BX.Crm.EditorDragItemController.current.getGhostNode());var i=e.top,n=e.top+40;var r=Math.floor((i+n)/2);var o,s;var a=this._charge.getPlaceHolder();if(a){o=a.getPosition();s=Math.floor((o.top+o.bottom)/2);if(i<=o.bottom&&i>=o.top||n>=o.top&&n<=o.bottom||Math.abs(r-s)<=8){if(!a.isActive()){a.setActive(true)}return}}var l=this._charge.getChildNodes();for(var d=0;d<l.length;d++){o=BX.pos(l[d]);s=Math.floor((o.top+o.bottom)/2);if(i<=o.bottom&&i>=o.top||n>=o.top&&n<=o.bottom||Math.abs(r-s)<=8){this._charge.createPlaceHolder(r-s<=0?d:d+1).setActive(true);return}}this._charge.createPlaceHolder(-1).setActive(true);this.refresh()};BX.Crm.EditorDragContainerController.prototype.removePlaceHolder=function(){if(!this._charge.hasPlaceHolder()){return}if(this._charge.getChildNodeCount()>0){this._charge.removePlaceHolder()}else{this._charge.getPlaceHolder().setActive(false)}this.refresh()};BX.Crm.EditorDragContainerController.prototype.getContextId=function(){return this._charge.getContextId()};BX.Crm.EditorDragContainerController.prototype.getPriority=function(){return this._charge.getPriority()};BX.Crm.EditorDragContainerController.prototype.isAllowedContext=function(t){return t===this._charge.getContextId()};BX.Crm.EditorDragContainerController.refresh=function(t){for(var e in this.items){if(!this.items.hasOwnProperty(e)){continue}var i=this.items[e];if(i.getContextId()===t){i.refresh()}}};BX.Crm.EditorDragContainerController.refreshAfter=function(t,e){e=parseInt(e);if(e>0){window.setTimeout(function(){BX.Crm.EditorDragContainerController.refresh(t)},e)}else{this.refresh(t)}};BX.Crm.EditorDragContainerController.refreshAll=function(){for(var t in this.items){if(!this.items.hasOwnProperty(t)){continue}this.items[t].refresh()}};BX.Crm.EditorDragContainerController.enable=function(t,e){for(var i in this.items){if(!this.items.hasOwnProperty(i)){continue}var n=this.items[i];if(n.getContextId()===t){n.enable(e)}}};BX.Crm.EditorDragContainerController.items={};BX.Crm.EditorDragContainerController.create=function(t,e){var i=new BX.Crm.EditorDragContainerController;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EditorDragPlaceholder==="undefined"){BX.Crm.EditorDragPlaceholder=function(){this._settings=null;this._container=null;this._node=null;this._isDragOver=false;this._isActive=false;this._index=-1;this._timeoutId=null};BX.Crm.EditorDragPlaceholder.prototype={initialize:function(t){this._settings=t?t:{};this._container=this.getSetting("container",null);this._isActive=this.getSetting("isActive",false);this._index=parseInt(this.getSetting("index",-1))},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getContainer:function(){return this._container},setContainer:function(t){this._container=t},isDragOver:function(){return this._isDragOver},isActive:function(){return this._isActive},setActive:function(t,e){if(this._timeoutId!==null){window.clearTimeout(this._timeoutId);this._timeoutId=null}e=parseInt(e);if(e>0){var i=this;window.setTimeout(function(){if(i._timeoutId===null)return;i._timeoutId=null;i.setActive(t,0)},e);return}t=!!t;if(this._isActive===t){return}this._isActive=t;if(this._node){}},getIndex:function(){return this._index},prepareNode:function(){return null},layout:function(){this._node=this.prepareNode();var t=this.getSetting("anchor",null);if(t){this._container.insertBefore(this._node,t)}else{this._container.appendChild(this._node)}BX.bind(this._node,"dragover",BX.delegate(this._onDragOver,this));BX.bind(this._node,"dragleave",BX.delegate(this._onDragLeave,this))},clearLayout:function(){if(this._node){this._node.style.height=0;setTimeout(BX.proxy(function(){this._node=BX.remove(this._node)},this),100)}},getPosition:function(){return BX.pos(this._node)},_onDragOver:function(t){t=t||window.event;this._isDragOver=true;return BX.eventReturnFalse(t)},_onDragLeave:function(t){t=t||window.event;this._isDragOver=false;return BX.eventReturnFalse(t)}}}if(typeof BX.Crm.EditorDragFieldPlaceholder==="undefined"){BX.Crm.EditorDragFieldPlaceholder=function(){};BX.extend(BX.Crm.EditorDragFieldPlaceholder,BX.Crm.EditorDragPlaceholder);BX.Crm.EditorDragFieldPlaceholder.prototype.prepareNode=function(){return BX.create("div",{attrs:{className:"crm-entity-widget-content-block-place"}})};BX.Crm.EditorDragFieldPlaceholder.create=function(t){var e=new BX.Crm.EditorDragFieldPlaceholder;e.initialize(t);return e}}if(typeof BX.Crm.EditorDragSectionPlaceholder==="undefined"){BX.Crm.EditorDragSectionPlaceholder=function(){};BX.extend(BX.Crm.EditorDragSectionPlaceholder,BX.Crm.EditorDragPlaceholder);BX.Crm.EditorDragSectionPlaceholder.prototype.prepareNode=function(){return BX.create("div",{attrs:{className:"crm-entity-card-widget crm-entity-card-widget-place"}})};BX.Crm.EditorDragSectionPlaceholder.create=function(t){var e=new BX.Crm.EditorDragSectionPlaceholder;e.initialize(t);return e}}if(typeof BX.Crm.EntityUserFieldType==="undefined"){BX.Crm.EntityUserFieldType={string:"string",integer:"integer",double:"double",boolean:"boolean",money:"money",date:"date",datetime:"datetime",enumeration:"enumeration",file:"file",url:"url"}}if(typeof BX.Crm.EntityUserFieldManager==="undefined"){BX.Crm.EntityUserFieldManager=function(){this._id="";this._settings={};this._entityId=0;this._fieldEntityId="";this._enableCreation=false;this._creationSignature="";this._creationUrl="";this._activeFields={};this._validationResult=null;this._validationPromise=null};BX.Crm.EntityUserFieldManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._fieldEntityId=BX.prop.getString(this._settings,"fieldEntityId","");this._enableCreation=BX.prop.getBoolean(this._settings,"enableCreation",false);this._creationSignature=BX.prop.getString(this._settings,"creationSignature","");this._creationPageUrl=BX.prop.getString(this._settings,"creationPageUrl","")},isCreationEnabled:function(){return this._enableCreation},isModificationEnabled:function(){return this._enableCreation},getDefaultFieldLabel:function(t){if(t==="string"){return this.getMessage("stringLabel")}else if(t==="double"){return this.getMessage("doubleLabel")}else if(t==="money"){return this.getMessage("moneyLabel")}else if(t==="datetime"){return this.getMessage("datetimeLabel")}else if(t==="enumeration"){return this.getMessage("enumerationLabel")}else if(t==="file"){return this.getMessage("fileLabel")}return this.getMessage("label")},getMessage:function(t){var e=BX.Crm.EntityUserFieldManager.messages;return e.hasOwnProperty(t)?e[t]:t},getAdditionalTypeList:function(){return BX.Crm.EntityUserFieldManager.additionalTypeList},getTypeInfos:function(){var t=[];t.push({name:"string",title:this.getMessage("stringTitle"),legend:this.getMessage("stringLegend")});t.push({name:"double",title:this.getMessage("doubleTitle"),legend:this.getMessage("doubleLegend")});t.push({name:"boolean",title:this.getMessage("booleanTitle"),legend:this.getMessage("booleanLegend")});t.push({name:"datetime",title:this.getMessage("datetimeTitle"),legend:this.getMessage("datetimeLegend")});t.push({name:"money",title:this.getMessage("moneyTitle"),legend:this.getMessage("moneyLegend")});t.push({name:"url",title:this.getMessage("urlTitle"),legend:this.getMessage("urlLegend")});t.push({name:"address",title:this.getMessage("addressTitle"),legend:this.getMessage("addressLegend")});t.push({name:"enumeration",title:this.getMessage("enumerationTitle"),legend:this.getMessage("enumerationLegend")});t.push({name:"file",title:this.getMessage("fileTitle"),legend:this.getMessage("fileLegend")});var e=this.getAdditionalTypeList();for(var i=0;i<e.length;i++){t.push({name:e[i].USER_TYPE_ID,title:e[i].TITLE,legend:e[i].LEGEND})}t.push({name:"custom",title:this.getMessage("customTitle"),legend:this.getMessage("customLegend")});return t},getCreationPageUrl:function(){return this._creationPageUrl},createField:function(t,e){if(!this._enableCreation){return}var i=BX.prop.getString(t,"USER_TYPE_ID","");if(i===""){i=BX.Crm.EntityUserFieldType.string}if(!BX.type.isNotEmptyString(t["EDIT_FORM_LABEL"])){t["EDIT_FORM_LABEL"]=this.getDefaultFieldLabel(i)}if(!BX.type.isNotEmptyString(t["LIST_COLUMN_LABEL"])){t["LIST_COLUMN_LABEL"]=t["EDIT_FORM_LABEL"]}this.addFieldLabel("EDIT_FORM_LABEL",t["EDIT_FORM_LABEL"],t);this.addFieldLabel("LIST_COLUMN_LABEL",t["LIST_COLUMN_LABEL"],t);var n=new BX.Promise;var r=function(t){n.fulfill(t)};if(!BX.type.isNotEmptyString(t["FIELD"])){t["FIELD"]="UF_CRM_"+(new Date).getTime().toString()}t["ENTITY_ID"]=this._fieldEntityId;t["SIGNATURE"]=this._creationSignature;if(!BX.type.isNotEmptyString(t["MULTIPLE"])){t["MULTIPLE"]="N"}if(!BX.type.isNotEmptyString(t["MANDATORY"])){t["MANDATORY"]="N"}if(i===BX.Crm.EntityUserFieldType.file){t["SHOW_FILTER"]="N";t["SHOW_IN_LIST"]="N"}else{t["SHOW_FILTER"]="Y";t["SHOW_IN_LIST"]="Y"}if(i===BX.Crm.EntityUserFieldType.enumeration){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["DISPLAY"]="UI"}if(i===BX.Crm.EntityUserFieldType.boolean){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["LABEL_CHECKBOX"]=t["EDIT_FORM_LABEL"]}if(i===BX.Crm.EntityUserFieldType.double){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["PRECISION"]=2}if(e===BX.Crm.EntityEditorMode.view){BX.Main.UF.ViewManager.add({FIELDS:[t]},r)}else{BX.Main.UF.EditManager.add({FIELDS:[t]},r)}return n},updateField:function(t,e){t["ENTITY_ID"]=this._fieldEntityId;t["SIGNATURE"]=this._creationSignature;var i=new BX.Promise;var n=function(t){i.fulfill(t)};if(e===BX.Crm.EntityEditorMode.view){BX.Main.UF.ViewManager.update({FIELDS:[t]},n)}else{BX.Main.UF.EditManager.update({FIELDS:[t]},n)}return i},resolveFieldName:function(t){return BX.prop.getString(t,"FIELD","")},addFieldLabel:function(t,e,i){var n=BX.prop.getArray(this._settings,"languages",[]);if(n.length===0){i[t]=e;return}i[t]={};for(var r=0,o=n.length;r<o;r++){var s=n[r];i[t][s["LID"]]=e}},prepareSchemeElementSettings:function(t){var e=BX.prop.getString(t,"FIELD","");if(e===""){return null}if(BX.prop.getString(t,"USER_TYPE_ID","")===""){t["USER_TYPE_ID"]="string"}if(BX.prop.getString(t,"ENTITY_ID","")===""){t["ENTITY_ID"]=this._fieldEntityId}if(BX.prop.getInteger(t,"ENTITY_VALUE_ID",0)<=0){t["ENTITY_VALUE_ID"]=this._entityId}return{name:e,originalTitle:BX.prop.getString(t,"EDIT_FORM_LABEL",e),title:BX.prop.getString(t,"EDIT_FORM_LABEL",e),type:"userField",required:BX.prop.getString(t,"MANDATORY","N")==="Y",data:{fieldInfo:t}}},createSchemeElement:function(t){return BX.Crm.EntitySchemeElement.create(this.prepareSchemeElementSettings(t))},updateSchemeElement:function(t,e){var i=this.prepareSchemeElementSettings(e);i["title"]=t.getTitle();t.initialize(i)},registerActiveField:function(t){var e=t.getName();this._activeFields[e]=t;BX.Main.UF.EditManager.registerField(e,t.getFieldInfo(),t.getFieldNode())},unregisterActiveField:function(t){var e=t.getName();if(this._activeFields.hasOwnProperty(e)){delete this._activeFields[e]}BX.Main.UF.EditManager.unRegisterField(e)},validate:function(t){var e=[];for(var i in this._activeFields){if(this._activeFields.hasOwnProperty(i)){e.push(i)}}if(e.length>0){this._validationResult=t;BX.Main.UF.EditManager.validate(e,BX.delegate(this.onValidationComplete,this))}else{window.setTimeout(BX.delegate(function(){if(this._validationPromise){this._validationPromise.fulfill();this._validationPromise=null}},this),0)}this._validationPromise=new BX.Promise;return this._validationPromise},onValidationComplete:function(t){var e;for(e in this._activeFields){if(this._activeFields.hasOwnProperty(e)){this._activeFields[e].clearError()}}for(e in t){if(!t.hasOwnProperty(e)){continue}if(this._activeFields.hasOwnProperty(e)){var i=this._activeFields[e];i.showError(t[e]);this._validationResult.addError(BX.Crm.EntityValidationError.create({field:i}))}}if(this._validationPromise){this._validationPromise.fulfill()}this._validationResult=null;this._validationPromise=null}};if(typeof BX.Crm.EntityUserFieldManager.messages==="undefined"){BX.Crm.EntityUserFieldManager.messages={}}BX.Crm.EntityUserFieldManager.items={};BX.Crm.EntityUserFieldManager.create=function(t,e){var i=new BX.Crm.EntityUserFieldManager;i.initialize(t,e);this.items[t]=i;return i}}if(typeof BX.Crm.EntityUserFieldLayoutLoader==="undefined"){BX.Crm.EntityUserFieldLayoutLoader=function(){this._id="";this._settings={};this._mode=BX.Crm.EntityEditorMode.view;this._enableBatchMode=true;this._items=[]};BX.Crm.EntityUserFieldLayoutLoader.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);this._enableBatchMode=BX.prop.getBoolean(this._settings,"enableBatchMode",true)},addItem:function(t){this._items.push(t)},run:function(){if(!this._enableBatchMode){this.startRequest()}},runBatch:function(){if(this._enableBatchMode){this.startRequest()}},startRequest:function(){if(this._items.length===0){return}var t=[];for(var e=0,i=this._items.length;e<i;e++){if(BX.prop.getString(this._items[e],"name","")!==""){t.push(BX.prop.getObject(this._items[e],"field",{}))}}if(t.length===0){return}var n={FIELDS:t,FORM:this._id,CONTEXT:"CRM_EDITOR"};if(this._mode===BX.Crm.EntityEditorMode.view){BX.Main.UF.Manager.getView(n,BX.delegate(this.onRequestComplete,this))}else{BX.Main.UF.Manager.getEdit(n,BX.delegate(this.onRequestComplete,this))}},onRequestComplete:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];var r=BX.prop.getString(n,"name","");var o=BX.prop.getFunction(n,"callback",null);if(r!==""&&o!==null){o(BX.prop.getObject(t,r,{}))}}}};BX.Crm.EntityUserFieldLayoutLoader.create=function(t,e){var i=new BX.Crm.EntityUserFieldLayoutLoader;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorDupManager==="undefined"){BX.Crm.EntityEditorDupManager=function(){this._id="";this._settings=null;this._groupInfos=null;this._isEnabled=false;this._serviceUrl="";this._entityTypeName="";this._form=null;this._controller=null};BX.Crm.EntityEditorDupManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._isEnabled=BX.prop.getBoolean(this._settings,"enabled","");if(!this._isEnabled){return}this._groupInfos=BX.prop.getObject(this._settings,"groups",{});this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","");this._form=BX.prop.get(this._settings,"form",null);this._controller=BX.CrmDupController.create(this._id,{serviceUrl:this._serviceUrl,entityTypeName:this._entityTypeName,form:this._form,searcSummaryPosition:"right"})},isEnabled:function(){return this._isEnabled},getGroupInfo:function(t){return this._groupInfos.hasOwnProperty(t)?this._groupInfos[t]:null},getGroup:function(t){return this._isEnabled?this._controller.getGroup(t):null},ensureGroupRegistered:function(t){if(!this._isEnabled){return null}var e=this.getGroup(t);if(!e){e=this._controller.registerGroup(t,this.getGroupInfo(t))}return e},registerField:function(t){if(!this._isEnabled){return null}var e=BX.prop.getString(t,"groupId","");var i=BX.prop.getObject(t,"field",null);if(e===""||!i){return null}var n=this.ensureGroupRegistered(e);if(!n){return null}return n.registerField(i)},unregisterField:function(t){if(!this._isEnabled){return}var e=BX.prop.getString(t,"groupId","");var i=BX.prop.getObject(t,"field",null);if(e===""||!i){return}var n=this.getGroup(e);if(!n){return}n.unregisterField(i)}};BX.Crm.EntityEditorDupManager.create=function(t,e){var i=new BX.Crm.EntityEditorDupManager;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorVisibilityPolicy==="undefined"){BX.Crm.EntityEditorVisibilityPolicy={always:0,view:1,edit:2,parse:function(t){t=t.toLowerCase();if(t==="view"){return this.view}else if(t==="edit"){return this.edit}return this.always},checkVisibility:function(t){var e=t.getMode();var i=t.getVisibilityPolicy();if(i===this.view){return e===BX.Crm.EntityEditorMode.view}else if(i===this.edit){return e===BX.Crm.EntityEditorMode.edit}return true}}}if(typeof BX.Crm.EntityEditorControl==="undefined"){BX.Crm.EntityEditorControl=function(){this._id="";this._settings={};this._editor=null;this._parent=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._model=null;this._schemeElement=null;this._container=null;this._wrapper=null;this._dragButton=null;this._dragItem=null;this._hasLayout=false;this._isValidLayout=false;this._isVisible=true;this._isActive=false;this._isChanged=false;this._isSchemeChanged=false;this._changeHandler=BX.delegate(this.onChange,this);this._contextMenuButton=null;this._isContextMenuOpened=false;this._draggableContextId=""};BX.Crm.EntityEditorControl.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor",null);this._parent=BX.prop.get(this._settings,"parent",null);this._model=BX.prop.get(this._settings,"model",null);this._schemeElement=BX.prop.get(this._settings,"schemeElement",null);this._container=BX.prop.getElementNode(this._settings,"container",null);var i=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);if(i===BX.Crm.EntityEditorMode.edit&&this._schemeElement&&!this._schemeElement.isEditable()){i=BX.Crm.EntityEditorMode.view}this._mode=i;this.doInitialize();this.bindModel()},doInitialize:function(){},bindModel:function(){},unbindModel:function(){},getMessage:function(t){var e=BX.Crm.EntityEditorControl.messages;return e.hasOwnProperty(t)?e[t]:t},getId:function(){return this._id},getEditor:function(){return this._editor},setEditor:function(t){this._editor=t},getParent:function(){return this._parent},setParent:function(t){this._parent=t},getChildCount:function(){return 0},getChildById:function(t){return null},editChild:function(t){},removeChild:function(t){},getChildren:function(){return[]},editChildConfiguration:function(t){},getType:function(){return this._schemeElement?this._schemeElement.getType():""},getName:function(){return this._schemeElement?this._schemeElement.getName():""},getTitle:function(){if(!this._schemeElement){return""}var t=this._schemeElement.getTitle();if(t===""){t=this._schemeElement.getName()}return t},setTitle:function(t){if(!this._schemeElement){return}this._schemeElement.setTitle(t);this.refreshTitleLayout()},getData:function(){return this._schemeElement?this._schemeElement.getData():{}},isVisible:function(){return this._isVisible&&BX.Crm.EntityEditorVisibilityPolicy.checkVisibility(this)},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;if(this._hasLayout){this._wrapper.style.display=this._isVisible?"":"none"}},isActive:function(){return this._isActive},setActive:function(t){t=!!t;if(this._isActive===t){return}this._isActive=t;this.doSetActive()},doSetActive:function(){},isEditable:function(){return this._schemeElement&&this._schemeElement.isEditable()},isRequired:function(){return this._schemeElement&&this._schemeElement.isRequired()},isRequiredConditionally:function(){return this._schemeElement&&this._schemeElement.isRequiredConditionally()},isHeading:function(){return this._schemeElement&&this._schemeElement.isHeading()},isReadOnly:function(){return this._editor&&this._editor.isReadOnly()},getVisibilityPolicy:function(){return this._schemeElement&&this._schemeElement.getVisibilityPolicy()},getEditPriority:function(){return BX.Crm.EntityEditorPriority.normal},getPosition:function(){return BX.pos(this._wrapper)},focus:function(){},save:function(){},validate:function(t){return true},rollback:function(){},isDragEnabled:function(){return this._parent?this._parent.isDragEnabled():this._mode===BX.Crm.EntityEditorMode.edit},isContextMenuEnabled:function(){return this._parent?this._parent.isContextMenuEnabled():this._mode===BX.Crm.EntityEditorMode.edit},getMode:function(){return this._mode},setMode:function(t,e){if(this._mode===t||!this.canChangeMode(t)){return}this.onBeforeModeChange();this._mode=t;this.doSetMode(this._mode);this.onAfterModeChange();e=!!e;if(e){if(this._parent){this._parent.processChildControlModeChange(this)}else if(this._editor){this._editor.processControlModeChange(this)}}this._isSchemeChanged=false;this._isChanged=false;if(this._hasLayout){this._isValidLayout=false}},onBeforeModeChange:function(){},doSetMode:function(t){},onAfterModeChange:function(){},canChangeMode:function(t){if(t===BX.Crm.EntityEditorMode.edit){return this.isEditable()}return true},isModeToggleEnabled:function(){return this._editor.isModeToggleEnabled()},toggleMode:function(t){if(!this.isModeToggleEnabled()){return false}this.setMode(this._mode===BX.Crm.EntityEditorMode.view?BX.Crm.EntityEditorMode.edit:BX.Crm.EntityEditorMode.view,t);this.refreshLayout();return true},isEditInViewEnabled:function(){return this._editor&&this._editor.isEditInViewEnabled()&&this._schemeElement&&this._schemeElement.getDataBooleanParam("enableEditInView",false)},getContextId:function(){return this._editor?this._editor.getContextId():""},getExternalContextId:function(){return this._editor?this._editor.getExternalContextId():""},processAvailableSchemeElementsChange:function(){},processChildControlModeChange:function(t){},processChildControlChange:function(t,e){},isChanged:function(){return this._isChanged},markAsChanged:function(t){if(this._isChanged||this._mode===BX.Crm.EntityEditorMode.view){return}this._isChanged=true;if(typeof t==="undefined"){t={}}this.notifyChanged(t)},isSchemeChanged:function(){return this._isSchemeChanged},markSchemeAsChanged:function(){if(this._isSchemeChanged){return}this._isSchemeChanged=true},saveScheme:function(){if(!this._isSchemeChanged){return}this.commitSchemeChanges();return this._editor.saveScheme()},commitSchemeChanges:function(){if(!this._isSchemeChanged){return}this._editor.updateSchemeElement(this._schemeElement);this._isSchemeChanged=false},getContainer:function(){return this._container},setContainer:function(t){this._container=t;if(this._hasLayout){this._hasLayout=false}},getWrapper:function(){return this._wrapper},getModel:function(){return this._model},getSchemeElement:function(){return this._schemeElement},hasScheme:function(){return!!this._schemeElement},layout:function(t){},registerLayout:function(t){if(!this._wrapper){return}this._wrapper.setAttribute("data-cid",this.getId());if(typeof t==="undefined"){t={}}if(!BX.prop.getBoolean(t,"preservePosision",false)){var e=BX.prop.getElementNode(t,"anchor",null);if(e){BX.addClass(this._wrapper,"crm-entity-widget-content-hide");this._container.insertBefore(this._wrapper,e);setTimeout(BX.delegate(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-hide");BX.addClass(this._wrapper,"crm-entity-widget-content-show")},this),1);setTimeout(BX.delegate(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-show")},this),310)}else{this._container.appendChild(this._wrapper)}}if(!this.isVisible()){this._wrapper.style.display="none"}this._isValidLayout=true},refreshLayout:function(t){if(!this._hasLayout){return}this.clearLayout({preservePosision:true});if(!BX.type.isPlainObject(t)){t={}}t["preservePosision"]=true;this.layout(t)},clearLayout:function(t){},refreshTitleLayout:function(){},release:function(){},hide:function(){if(this.isRequired()||this.isRequiredConditionally()){return}if(this._parent){BX.addClass(this._wrapper,"crm-entity-widget-content-hide");setTimeout(BX.delegate(function(){this._parent.removeChild(this)},this),350)}else{this.clearLayout()}},prepareSaveData:function(t){},onBeforeSubmit:function(){},onHideButtonClick:function(t){this.hide()},onContextButtonCliick:function(t){if(!this._isContextMenuOpened){this.openContextMenu()}else{this.closeContextMenu()}},openContextMenu:function(){if(this._isContextMenuOpened){return}var t=this.prepareContextMenuItems();if(BX.type.isArray(t)&&t.length>0){var e=BX.delegate(this.onContextMenuItemSelect,this);for(var i=0,n=t.length;i<n;i++){if(typeof t[i]["onclick"]==="undefined"){t[i]["onclick"]=e}}BX.PopupMenu.show(this._id,this._contextMenuButton,t,{angle:false,events:{onPopupShow:BX.delegate(this.onContextMenuShow,this),onPopupClose:BX.delegate(this.onContextMenuClose,this)}})}},prepareContextMenuItems:function(){return[]},processContextMenuCommand:function(t){},closeContextMenu:function(){var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}},onContextMenuShow:function(){this._isContextMenuOpened=true},onContextMenuClose:function(){BX.PopupMenu.destroy(this._id);this._isContextMenuOpened=false},onContextMenuItemSelect:function(t,e){this.processContextMenuCommand(BX.prop.getString(e,"value"));this.closeContextMenu()},onChange:function(t){this.markAsChanged()},notifyChanged:function(t){if(typeof t==="undefined"){t={}}if(this._parent){this._parent.processChildControlChange(this,t)}else if(this._editor){this._editor.processControlChange(this,t)}},getDraggableContextId:function(){return this._draggableContextId},setDraggableContextId:function(t){this._draggableContextId=t},createDragButton:function(){return this._dragButton},createHideButton:function(){var t=!this.isRequired()&&!this.isRequiredConditionally();var e=BX.create("div",{props:{className:"crm-entity-widget-content-block-hide-btn",title:this.getHideButtonHint(t)}});if(t){BX.bind(e,"click",BX.delegate(this.onHideButtonClick,this))}return e},createContextMenuButton:function(){this._contextMenuButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-context-menu"},events:{click:BX.delegate(this.onContextButtonCliick,this)}});return this._contextMenuButton},createGhostNode:function(){return null},getHideButtonHint:function(t){return""}};if(typeof BX.Crm.EntityEditorControl.messages==="undefined"){BX.Crm.EntityEditorControl.messages={}}}if(typeof BX.Crm.EntityEditorField==="undefined"){BX.Crm.EntityEditorField=function(){BX.Crm.EntityEditorField.superclass.constructor.apply(this);this._viewDoubleClickHandler=BX.delegate(this.onViewDoubleClick,this);this._titleWrapper=null;this._validators=null;this._hasError=false;this._errorContainer=null};BX.extend(BX.Crm.EntityEditorField,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorField.prototype.configure=function(){if(this._parent){this._parent.editChildConfiguration(this)}};BX.Crm.EntityEditorField.prototype.getDuplicateControlConfig=function(){return this._schemeElement?this._schemeElement.getDataObjectParam("duplicateControl",null):null};BX.Crm.EntityEditorField.prototype.markAsChanged=function(t){BX.Crm.EntityEditorField.superclass.markAsChanged.apply(this,arguments);if(this.hasError()){this.clearError()}var e=this.getValidators();for(var i=0,n=e.length;i<n;i++){e[i].processFieldChange(this)}};BX.Crm.EntityEditorField.prototype.bindModel=function(){this._model.addChangeListener(BX.delegate(this.onModelChange,this));this._model.addLockListener(BX.delegate(this.onModelLock,this))};BX.Crm.EntityEditorField.prototype.onModelChange=function(t,e){this.processModelChange(e)};BX.Crm.EntityEditorField.prototype.onModelLock=function(t,e){this.processModelLock(e)};BX.Crm.EntityEditorField.prototype.processModelChange=function(t){};BX.Crm.EntityEditorField.prototype.processModelLock=function(t){};BX.Crm.EntityEditorField.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorField.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorField.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorField.prototype.getHideButtonHint=function(t){return this.getMessage(t?"hideButtonHint":"hideButtonDisabledHint")};BX.Crm.EntityEditorField.prototype.createTitleNode=function(t){this._titleWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-title"}});if(!BX.type.isNotEmptyString(t)){t=this.getTitle()}this._titleWrapper.appendChild(document.createTextNode(t));var e=this.createTitleMarker();if(e){this._titleWrapper.appendChild(e)}return this._titleWrapper};BX.Crm.EntityEditorField.prototype.refreshTitleLayout=function(){if(!this._titleWrapper){return}BX.cleanNode(this._titleWrapper);this._titleWrapper.appendChild(document.createTextNode(this.getTitle()));var t=this.createTitleMarker();if(t){this._titleWrapper.appendChild(t)}};BX.Crm.EntityEditorField.prototype.createTitleMarker=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){if(this.isRequired()){return BX.create("span",{style:{color:"#f00"},text:"*"})}else if(this.isRequiredConditionally()){return BX.create("span",{text:"*"})}}return null};BX.Crm.EntityEditorField.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorField.prototype.createGhostNode=function(){if(!this._wrapper){return null}var t=BX.pos(this._wrapper);var e=this._wrapper.cloneNode(true);BX.addClass(e,"crm-entity-widget-content-block-drag");e.style.width=t.width+"px";e.style.height=t.height+"px";return e};BX.Crm.EntityEditorField.prototype.clearLayout=function(t){if(!this._hasLayout){return}BX.Crm.EntityEditorField.superclass.clearLayout.apply(this,arguments);if(!BX.type.isPlainObject(t)){t={}}this.releaseDragDropAbilities();if(BX.prop.getBoolean(t,"preservePosision",false)){this._wrapper=BX.cleanNode(this._wrapper);if(this.hasError()){this.clearError()}}else{this._wrapper=BX.remove(this._wrapper)}this.doClearLayout(t);this._hasLayout=false};BX.Crm.EntityEditorField.prototype.doClearLayout=function(t){};BX.Crm.EntityEditorField.prototype.registerLayout=function(t){if(this._mode===BX.Crm.EntityEditorMode.view){BX.addClass(this._wrapper,"crm-entity-widget-content-block-click-editable");BX.bind(this._wrapper,"dblclick",this._viewDoubleClickHandler)}BX.Crm.EntityEditorField.superclass.registerLayout.apply(this,arguments)};BX.Crm.EntityEditorField.prototype.getEditPriority=function(){return!this.hasValue()&&(this.isRequired()||this.isRequiredConditionally())?BX.Crm.EntityEditorPriority.high:BX.Crm.EntityEditorPriority.normal};BX.Crm.EntityEditorField.prototype.checkIfNotEmpty=function(t){return BX.util.trim(t)!==""};BX.Crm.EntityEditorField.prototype.hasValue=function(){return this.checkIfNotEmpty(this.getValue())};BX.Crm.EntityEditorField.prototype.getValue=function(t){if(!this._model){return""}return this._model.getField(this.getName(),t!==undefined?t:"")};BX.Crm.EntityEditorField.prototype.getStringValue=function(t){return this._model?this._model.getStringField(this.getName(),t):""};BX.Crm.EntityEditorField.prototype.getRuntimeValue=function(){return""};BX.Crm.EntityEditorField.prototype.prepareSaveData=function(t){t[this.getName()]=this.getValue()};BX.Crm.EntityEditorField.prototype.findValidatorIndex=function(t){if(!this._validators){return-1}for(var e=0,i=this._validators.length;e<i;e++){if(this._validators[e]===t){return e}}return-1};BX.Crm.EntityEditorField.prototype.addValidator=function(t){if(t&&this.findValidatorIndex(t)<0){if(!this._validators){this._validators=[]}this._validators.push(t)}};BX.Crm.EntityEditorField.prototype.removeValidator=function(t){if(!this._validators||!t){return}var e=this.findValidatorIndex(t);if(e>=0){this._validators.splice(e,1)}};BX.Crm.EntityEditorField.prototype.getValidators=function(){return this._validators?this._validators:[]};BX.Crm.EntityEditorField.prototype.hasValidators=function(){return this._validators&&this._validators.length>0};BX.Crm.EntityEditorField.prototype.executeValidators=function(t){if(!this._validators){return true}var e=true;for(var i=0,n=this._validators.length;i<n;i++){if(!this._validators[i].validate(t)){e=false}}return e};BX.Crm.EntityEditorField.prototype.hasError=function(){return this._hasError};BX.Crm.EntityEditorField.prototype.showError=function(t,e){if(!this._errorContainer){this._errorContainer=BX.create("div",{attrs:{className:"crm-entity-widget-content-error-text"}})}this._errorContainer.innerHTML=t;this._wrapper.appendChild(this._errorContainer);BX.addClass(this._wrapper,"crm-entity-widget-content-error");this._hasError=true};BX.Crm.EntityEditorField.prototype.showRequiredFieldError=function(t){this.showError(this.getMessage("requiredFieldError"),t)};BX.Crm.EntityEditorField.prototype.clearError=function(){if(!this._hasError){return}if(this._errorContainer&&this._errorContainer.parentNode){this._errorContainer.parentNode.removeChild(this._errorContainer)}BX.removeClass(this._wrapper,"crm-entity-widget-content-error");this._hasError=false};BX.Crm.EntityEditorField.prototype.scrollAnimate=function(){var t=this._wrapper;window.setTimeout(function(){new BX.easing({duration:300,start:{position:document.body.scrollTop},finish:{position:BX.pos(t).top-10},step:function(t){document.body.scrollTop=t.position}}).animate()},0)};BX.Crm.EntityEditorField.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.Crm.EditorDragItemController.create("field_"+this.getId(),{charge:BX.Crm.EditorFieldDragItem.create({control:this,contextId:this._draggableContextId}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorField.prototype.releaseDragDropAbilities=function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}};BX.Crm.EntityEditorField.prototype.onViewDoubleClick=function(t){if(this._parent){this._parent.editChild(this)}};BX.Crm.EntityEditorField.prototype.prepareContextMenuItems=function(){var t=[];if(!this.isRequired()&&!this.isRequiredConditionally()){t.push({text:this.getMessage("hide"),value:"hide"})}t.push({text:this.getMessage("configure"),value:"configure"});return t};BX.Crm.EntityEditorField.prototype.processContextMenuCommand=function(t){if(t==="hide"){this.hide()}else if(t==="configure"){this.configure()}};if(typeof BX.Crm.EntityEditorField.messages==="undefined"){BX.Crm.EntityEditorField.messages={}}}if(typeof BX.Crm.EntityEditorSection==="undefined"){BX.Crm.EntityEditorSection=function(){BX.Crm.EntityEditorSection.superclass.constructor.apply(this);this._fields=null;this._fieldConfigurator=null;this._userFieldConfigurator=null;this._titleEditButton=null;this._titleEditHandler=BX.delegate(this.onTitleEditButtonClick,this);this._titleView=null;this._titleInput=null;this._titleMode=BX.Crm.EntityEditorMode.intermediate;this._titleInputKeyHandler=BX.delegate(this.onTitleInputKeyPress,this);this._documentClickHandler=BX.delegate(this.onExternalClick,this);this._deleteButtonHandler=BX.delegate(this.onDeleteSectionBtnClick,this);this._detetionConfirmDlgId="section_deletion_confirm";this._enableToggling=true;this._toggleButton=null;this._addChildButton=null;this._childSelectMenu=null;this._buttonPanelWrapper=null;this._fieldTypeSelectMenu=null;this._deleteButton=null;this._dragContainerController=null;this._dragPlaceHolder=null;this._dropHandler=BX.delegate(this.onDrop,this);this._fieldSelector=null};BX.extend(BX.Crm.EntityEditorSection,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorSection.prototype.doSetActive=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].setActive(this._isActive)}};BX.Crm.EntityEditorSection.prototype.initialize=function(t,e){BX.Crm.EntityEditorSection.superclass.initialize.call(this,t,e);this.initializeFromModel();this._draggableContextId=BX.Crm.EditorFieldDragItem.contextId+"_"+this.getId()};BX.Crm.EntityEditorSection.prototype.initializeFromModel=function(){var t,e;if(this._fields){for(t=0,e=this._fields.length;t<e;t++){this._fields[t].release()}}this._fields=[];var i=this._schemeElement.getElements();for(t=0,e=i.length;t<e;t++){var n=i[t];var r=this._editor.createControl(n.getType(),n.getName(),{schemeElement:n,model:this._model,parent:this});if(!r){continue}n.setParent(this._schemeElement);r.setMode(this._mode,false);this._fields.push(r)}};BX.Crm.EntityEditorSection.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorSection.prototype.adjustDeleteButton=function(){if(this._deleteButton){if(!this.isRequired()&&!this.isRequiredConditionally()){BX.bind(this._deleteButton,"click",this._deleteButtonHandler);this._deleteButton.style.display=""}else{BX.unbind(this._deleteButton,"click",this._deleteButtonHandler);this._deleteButton.style.display="none"}}};BX.Crm.EntityEditorSection.prototype.createGhostNode=function(){if(!this._wrapper){return null}var t=BX.pos(this._wrapper);var e=BX.create("div",{props:{className:"crm-entity-card-widget-edit"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-inner"}})]})]}),BX.create("div",{props:{className:"crm-entity-card-widget-title"},children:[BX.create("span",{props:{className:"crm-entity-card-widget-title-text"},text:this._schemeElement.getTitle()})]})]});BX.addClass(e,"crm-entity-widget-card-drag");e.style.width=t.width+"px";return e};BX.Crm.EntityEditorSection.prototype.getEditPriority=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].getEditPriority()===BX.Crm.EntityEditorPriority.high){return BX.Crm.EntityEditorPriority.high}}return BX.Crm.EntityEditorPriority.normal};BX.Crm.EntityEditorSection.prototype.layout=function(t){var e=this._schemeElement.getTitle();this._contentContainer=BX.create("div",{props:{className:"crm-entity-widget-content"}});var i=this._mode===BX.Crm.EntityEditorMode.view;var n=i?"crm-entity-card-widget":"crm-entity-card-widget-edit";this._enableToggling=this.isModeToggleEnabled();this._toggleButton=BX.create("span",{attrs:{className:"crm-entity-widget-hide-btn"},events:{click:BX.delegate(this.onToggleBtnClick,this)},text:this.getMessage(i?"change":"cancel")});if(!this._enableToggling){this._toggleButton.style.display="none"}this._titleMode=BX.Crm.EntityEditorMode.view;this._titleEditButton=BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"},events:{click:this._titleEditHandler}});if(!this._editor.isSectionEditEnabled()){this._titleEditButton.style.display="none"}this._titleView=BX.create("span",{props:{className:"crm-entity-card-widget-title-text"},text:e});this._titleInput=BX.create("input",{props:{className:"crm-entity-card-widget-title-text"},style:{display:"none"}});this._wrapper=BX.create("div",{props:{className:n}});this._wrapper.appendChild(this.createDragButton());this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-card-widget-title"},children:[this._titleView,this._titleInput,this._titleEditButton,BX.create("div",{props:{className:"crm-entity-widget-actions-block"},children:[this._toggleButton]})]}));this._wrapper.appendChild(this._contentContainer);if(!BX.type.isPlainObject(t)){t={}}var r=BX.prop.getElementNode(t,"anchor",null);if(r){this._container.insertBefore(this._wrapper,r)}else{this._container.appendChild(this._wrapper)}var o=BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:this._mode,enableBatchMode:true});for(var s=0,a=this._fields.length;s<a;s++){var l=this._fields[s];l.setContainer(this._contentContainer);l.setDraggableContextId(this._draggableContextId);l.layout({userFieldLoader:o});if(!i&&l.isHeading()){l.focus()}}o.runBatch();this._addChildButton=this._createChildButton=null;if(!i){this._buttonPanelWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});this._addChildButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("selectField"),events:{click:BX.delegate(this.onAddChildBtnClick,this)}});if(!this._editor.hasAvailableSchemeElements()){this._addChildButton.style.display="none"}this._buttonPanelWrapper.appendChild(this._addChildButton);if(this._editor.getUserFieldManager().isCreationEnabled()){this._createChildButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("createField"),events:{click:BX.delegate(this.onCreateUserFieldBtnClick,this)}});this._buttonPanelWrapper.appendChild(this._createChildButton)}this._deleteButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-remove-btn"},text:this.getMessage("deleteSection")});this._buttonPanelWrapper.appendChild(this._deleteButton);this.adjustDeleteButton();this._contentContainer.appendChild(this._buttonPanelWrapper)}this._dragContainerController=BX.Crm.EditorDragContainerController.create("section_"+this.getId(),{charge:BX.Crm.EditorFieldDragContainer.create({section:this,context:this._draggableContextId}),node:this._wrapper});this._dragContainerController.addDragFinishListener(this._dropHandler);this.initializeDragDropAbilities();this._hasLayout=true};BX.Crm.EntityEditorSection.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();for(var t=0,e=this._fields.length;t<e;t++){var i=this._fields[t];i.clearLayout();i.setContainer(null);i.setDraggableContextId("")}this._addChildButton=BX.remove(this._addChildButton);this._buttonPanelWrapper=BX.remove(this._buttonPanelWrapper);this._deleteButton=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorSection.prototype.refreshLayout=function(t){var e=this._wrapper;var i={};if(e&&e.nextSibling){i["anchor"]=e.nextSibling}e.style.height=e.offsetHeight+"px";this.layout(i);var n=this._wrapper;n.style.position="absolute";n.style.top=e.offsetTop+"px";n.style.width=e.offsetWidth+"px";n.style.left=0;n.style.right=0;n.style.zIndex=10;n.style.opacity=0;var r=new BX.easing({duration:250,start:{opacity:0},finish:{opacity:100},transition:BX.easing.transitions.quart,step:BX.proxy(function(t){n.style.opacity=t.opacity/100},this),complete:BX.proxy(function(){n.style.opacity="";n.style.height="";n.style.width="";n.style.position="";n.style.top="";n.style.left="";n.style.right="";n.style.zIndex="";e.remove();if(BX.type.isFunction(t)){t()}},this)});var o=new BX.easing({duration:100,start:{height:e.offsetHeight},finish:{height:n.offsetHeight},transition:BX.easing.transitions.quart,step:BX.proxy(function(t){e.style.height=t.height+"px"},this),complete:BX.proxy(function(){r.animate()},this)});var s=new BX.easing({duration:250,start:{opacity:100},finish:{opacity:0},transition:BX.easing.transitions.quart,step:BX.proxy(function(t){e.style.opacity=t.opacity/100},this),complete:BX.proxy(function(){o.animate()},this)});s.animate()};BX.Crm.EntityEditorSection.prototype.setTitleMode=function(t){if(this._titleMode===t){return}this._titleMode=t;if(this._titleMode===BX.Crm.EntityEditorMode.view){this._titleView.style.display="";this._titleInput.style.display="none";this._titleEditButton.style.display="";var e=this._titleInput.value;this._titleView.innerHTML=BX.util.htmlspecialchars(e);this._schemeElement.setTitle(e);this.markSchemeAsChanged();this.saveScheme();BX.unbind(this._titleInput,"keyup",this._titleInputKeyHandler);BX.unbind(window.document,"click",this._documentClickHandler)}else{this._titleView.style.display="none";this._titleInput.style.display="";this._titleEditButton.style.display="none";this._titleInput.value=this._schemeElement.getTitle();BX.bind(this._titleInput,"keyup",this._titleInputKeyHandler);this._titleInput.focus();window.setTimeout(BX.delegate(function(){BX.bind(window.document,"click",this._documentClickHandler)},this),100)}};BX.Crm.EntityEditorSection.prototype.toggleTitleMode=function(){this.setTitleMode(this._titleMode===BX.Crm.EntityEditorMode.view?BX.Crm.EntityEditorMode.edit:BX.Crm.EntityEditorMode.view)};BX.Crm.EntityEditorSection.prototype.onTitleEditButtonClick=function(t){if(this._editor.isSectionEditEnabled()){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.onTitleInputKeyPress=function(t){if(!t){t=window.event}if(t.keyCode===13){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.onExternalClick=function(t){if(!t){t=window.event}if(this._titleInput!==BX.getEventTarget(t)){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.enableToggling=function(t){this._enableToggling=!!t;if(this._hasLayout){this._toggleButton.style.display=this._enableToggling?"":"none"}};BX.Crm.EntityEditorSection.prototype.onToggleBtnClick=function(t){if(this._enableToggling){this.toggleMode(true)}};BX.Crm.EntityEditorSection.prototype.onBeforeModeChange=function(){this.removeFieldConfigurator();this.removeUserFieldConfigurator()};BX.Crm.EntityEditorSection.prototype.doSetMode=function(t){if(this._titleMode===BX.Crm.EntityEditorMode.edit){this.toggleTitleMode()}for(var e=0,i=this._fields.length;e<i;e++){this._fields[e].setMode(t,false)}};BX.Crm.EntityEditorSection.prototype.processAvailableSchemeElementsChange=function(){if(this._hasLayout){this._addChildButton.style.display=this._editor.hasAvailableSchemeElements()?"":"none"}};BX.Crm.EntityEditorSection.prototype.validate=function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){return true}var e=BX.Crm.EntityValidationResult.create();for(var i=0,n=this._fields.length;i<n;i++){var r=this._fields[i];if(r.getMode()!==BX.Crm.EntityEditorMode.edit){continue}r.validate(e)}t.addResult(e);return e.getStatus()};BX.Crm.EntityEditorSection.prototype.commitSchemeChanges=function(){if(this._isSchemeChanged){var t=[];for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e].getSchemeElement();if(n){t.push(n)}}this._schemeElement.setElements(t)}return BX.Crm.EntityEditorSection.superclass.commitSchemeChanges.call(this)};BX.Crm.EntityEditorSection.prototype.save=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].save()}};BX.Crm.EntityEditorSection.prototype.rollback=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].rollback()}if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorSection.prototype.onBeforeSubmit=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].onBeforeSubmit()}};BX.Crm.EntityEditorSection.prototype.getChildIndex=function(t){for(var e=0,i=this._fields.length;e<i;e++){if(this._fields[e]===t){return e}}return-1};BX.Crm.EntityEditorSection.prototype.addChild=function(t,e){if(!BX.type.isPlainObject(e)){e={}}var i=BX.prop.get(e,"related",null);this._fields.push(t);if(t.hasScheme()){t.getSchemeElement().setParent(this._schemeElement)}t.setActive(this._isActive);if(this._hasLayout){t.setContainer(this._contentContainer);t.setDraggableContextId(this._draggableContextId);var n=BX.prop.getObject(e,"layout",{});if(i){n["anchor"]=i.getWrapper()}else{n["anchor"]=this._buttonPanelWrapper}t.layout(n)}if(t.hasScheme()){this._editor.processControlAdd(t);this.markSchemeAsChanged();if(BX.prop.getBoolean(e,"enableSaving",true)){this.saveScheme()}}this.adjustDeleteButton()};BX.Crm.EntityEditorSection.prototype.removeChild=function(t,e){if(!BX.type.isPlainObject(e)){e={}}var i=this.getChildIndex(t);if(i<0){return}if(t.isActive()){t.setActive(false)}this._fields.splice(i,1);var n=t.hasScheme();if(n){t.getSchemeElement().setParent(null)}if(this._hasLayout){t.clearLayout();t.setContainer(null);t.setDraggableContextId("")}if(n){this._editor.processControlRemove(t);this.markSchemeAsChanged();if(BX.prop.getBoolean(e,"enableSaving",true)){this.saveScheme()}}this.adjustDeleteButton()};BX.Crm.EntityEditorSection.prototype.moveChild=function(t,e){var i=this.getChildCount();var n=i-1;if(e<0||e>i){e=n}var r=this.getChildIndex(t);if(r<0||r===e){return false}if(this._hasLayout){t.clearLayout()}this._fields.splice(r,1);i--;var o=null;if(this._hasLayout){o=e<i?this._fields[e].getWrapper():this._buttonPanelWrapper}if(e<i){this._fields.splice(e,0,t)}else{this._fields.push(t)}if(this._hasLayout){if(o){t.layout({anchor:o})}else{t.layout()}}this._editor.processControlMove(t);this.markSchemeAsChanged();this.saveScheme();return true};BX.Crm.EntityEditorSection.prototype.editChild=function(t){if(this._mode===BX.Crm.EntityEditorMode.edit){t.focus()}else if(!this.isReadOnly()){this.setMode(BX.Crm.EntityEditorMode.edit,true);this.refreshLayout(function(){t.focus()})}};BX.Crm.EntityEditorSection.prototype.getChildById=function(t){for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e];if(n.getId()===t){return n}}return null};BX.Crm.EntityEditorSection.prototype.getChildCount=function(){return this._fields.length};BX.Crm.EntityEditorSection.prototype.getChildren=function(){return this._fields};BX.Crm.EntityEditorSection.prototype.processChildControlChange=function(t,e){if(this._isChanged){return}this.markAsChanged(e);this.enableToggling(false)};BX.Crm.EntityEditorSection.prototype.openAddChildMenu=function(){var t=this._editor.getAvailableSchemeElements();var e=t.length;if(e===0){return}var i=[];for(var n=0;n<e;n++){var r=t[n];i.push({text:r.getTitle(),value:r.getName()})}i.push({delimiter:true});i.push({text:this.getMessage("selectFieldFromOtherSection"),value:"ACTION.TRANSFER"});if(this._childSelectMenu){this._childSelectMenu.setupItems(i)}else{this._childSelectMenu=BX.CmrSelectorMenu.create(this._id,{items:i});this._childSelectMenu.addOnSelectListener(BX.delegate(this.onChildSelect,this))}this._childSelectMenu.open(this._addChildButton)};BX.Crm.EntityEditorSection.prototype.onAddChildBtnClick=function(t){this.openAddChildMenu()};BX.Crm.EntityEditorSection.prototype.openTransferDialog=function(){if(!this._fieldSelector){this._fieldSelector=BX.Crm.EntityEditorFieldSelector.create(this._id,{scheme:this._editor.getScheme(),excludedNames:[this.getSchemeElement().getName()],title:this.getMessage("transferDialogTitle")});this._fieldSelector.addClosingListener(BX.delegate(this.onTranferFieldSelect,this))}this._fieldSelector.open()};BX.Crm.EntityEditorSection.prototype.onTranferFieldSelect=function(t,e){if(BX.prop.getBoolean(e,"isCanceled")){return}var i=BX.prop.getArray(e,"items");if(i.length===0){return}for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"sectionName","");var a=BX.prop.getString(o,"fieldName","");var l=this._editor.getControlById(s);if(!l){continue}var d=l.getChildById(a);if(!d){continue}var h=d.getSchemeElement();l.removeChild(d,{enableSaving:false});var p=this._editor.createControl(h.getType(),h.getName(),{schemeElement:h,model:this._model,parent:this,mode:this._mode});this.addChild(p,{enableSaving:false})}this._editor.saveSchemeChanges()};BX.Crm.EntityEditorSection.prototype.onChildSelect=function(t,e){var i=e.getValue();if(i==="ACTION.TRANSFER"){this.openTransferDialog();return}var n=this._editor.getAvailableSchemeElementByName(i);if(!n){return}var r=this._editor.createControl(n.getType(),n.getName(),{schemeElement:n,model:this._model,parent:this,mode:this._mode});if(r){this.addChild(r)}};BX.Crm.EntityEditorSection.prototype.onCreateUserFieldBtnClick=function(t){if(!this._fieldTypeSelectMenu){var e=this._editor.getUserFieldManager().getTypeInfos();var i=[];for(var n=0,r=e.length;n<r;n++){var o=e[n];i.push({value:o.name,text:o.title,legend:o.legend})}this._fieldTypeSelectMenu=BX.Crm.UserFieldTypeMenu.create(this._id,{items:i,callback:BX.delegate(this.onUserFieldTypeSelect,this)})}this._fieldTypeSelectMenu.open(this._createChildButton)};BX.Crm.EntityEditorSection.prototype.onUserFieldTypeSelect=function(t,e){this._fieldTypeSelectMenu.close();var i=e.getValue();if(i===""){return}if(i==="custom"){window.open(this._editor.getUserFieldManager().getCreationPageUrl())}else{this.removeFieldConfigurator();this.removeUserFieldConfigurator();this.createUserFieldConfigurator({typeId:i})}};BX.Crm.EntityEditorSection.prototype.createUserFieldConfigurator=function(t){if(!BX.type.isPlainObject(t)){throw"EntityEditorSection: The 'params' argument must be object."}var e="";var i=BX.prop.get(t,"field",null);if(i){if(!(i instanceof BX.Crm.EntityEditorUserField)){throw"EntityEditorSection: The 'field' param must be EntityEditorUserField."}e=i.getFieldType();i.setVisible(false)}else{e=BX.prop.get(t,"typeId",BX.Crm.EntityUserFieldType.string)}this._userFieldConfigurator=BX.Crm.EntityEditorUserFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:this._model,mode:BX.Crm.EntityEditorMode.edit,parent:this,typeId:e,field:i});this.addChild(this._userFieldConfigurator,{related:i});BX.addCustomEvent(this._userFieldConfigurator,"onSave",BX.delegate(this.onUserFieldConfigurationSave,this));BX.addCustomEvent(this._userFieldConfigurator,"onCancel",BX.delegate(this.onUserFieldConfigurationCancel,this))};BX.Crm.EntityEditorSection.prototype.removeUserFieldConfigurator=function(){if(this._userFieldConfigurator){var t=this._userFieldConfigurator.getField();if(t){t.setVisible(true)}this.removeChild(this._userFieldConfigurator);this._userFieldConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onUserFieldConfigurationSave=function(t,e){if(t!==this._userFieldConfigurator){return}this._userFieldConfigurator.setLocked(true);var i=BX.prop.getString(e,"typeId");if(i===BX.Crm.EntityUserFieldType.datetime&&!BX.prop.getBoolean(e,"enableTime",false)){i=BX.Crm.EntityUserFieldType.date}var n={USER_TYPE_ID:i};var r=BX.prop.get(e,"field",null);if(r){var o=BX.prop.getString(e,"label","");if(o!==""){r.setTitle(o);this.markSchemeAsChanged();this.saveScheme()}n["FIELD"]=r.getName();n["ENTITY_VALUE_ID"]=r.getEntityValueId();n["MANDATORY"]=BX.prop.getBoolean(e,"mandatory",false)?"Y":"N";n["VALUE"]=r.getFieldValue();if(i===BX.Crm.EntityUserFieldType.enumeration){n["ENUM"]=BX.prop.getArray(e,"enumeration",[])}r.adjustFieldParams(n);this._editor.getUserFieldManager().updateField(n,this._mode).then(BX.delegate(this.onUserFieldUpdate,this))}else{n["EDIT_FORM_LABEL"]=BX.prop.getString(e,"label");n["MANDATORY"]=BX.prop.getBoolean(e,"mandatory",false)?"Y":"N";n["MULTIPLE"]=BX.prop.getBoolean(e,"multiple",false)?"Y":"N";if(i===BX.Crm.EntityUserFieldType.enumeration){n["ENUM"]=BX.prop.getArray(e,"enumeration",[])}this._editor.getUserFieldManager().createField(n,this._mode).then(BX.delegate(this.onUserFieldCreate,this))}};BX.Crm.EntityEditorSection.prototype.onUserFieldConfigurationCancel=function(t,e){if(t!==this._userFieldConfigurator){return}this.removeUserFieldConfigurator()};BX.Crm.EntityEditorSection.prototype.onUserFieldCreate=function(t){if(!BX.type.isPlainObject(t)){return}this.removeUserFieldConfigurator();var e=this._editor.getUserFieldManager();for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var r=BX.prop.getObject(n,"FIELD",null);if(!r){continue}var o=e.createSchemeElement(r);if(!o){continue}this._model.setField(o.getName(),{VALUE:"",SIGNATURE:BX.prop.getString(r,"SIGNATURE","")});var s=this._editor.createControl(o.getType(),o.getName(),{schemeElement:o,model:this._model,parent:this,mode:this._mode});this.addChild(s,{layout:{html:BX.prop.getString(n,"HTML","")}})}};BX.Crm.EntityEditorSection.prototype.onUserFieldUpdate=function(t){if(!BX.type.isPlainObject(t)){return}this.removeUserFieldConfigurator();var e=this._editor.getUserFieldManager();for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var r=BX.prop.getObject(n,"FIELD",null);if(!r){continue}var o=this.getChildById(i);if(!o){continue}var s=o.getSchemeElement();if(!s){continue}e.updateSchemeElement(s,r);var a={};var l=BX.prop.getString(n,"HTML","");if(l!==""){a["html"]=l}o.refreshLayout(a)}};BX.Crm.EntityEditorSection.prototype.editChildConfiguration=function(t){this.removeFieldConfigurator();this.removeUserFieldConfigurator();if(t.getType()==="userField"&&this._editor.getUserFieldManager().isModificationEnabled()){this.createUserFieldConfigurator({field:t})}else{this.createFieldConfigurator(t)}};BX.Crm.EntityEditorSection.prototype.createFieldConfigurator=function(t){t.setVisible(false);this._fieldConfigurator=BX.Crm.EntityEditorFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:this._model,mode:BX.Crm.EntityEditorMode.edit,parent:this,field:t});this.addChild(this._fieldConfigurator,{related:t});BX.addCustomEvent(this._fieldConfigurator,"onSave",BX.delegate(this.onFieldConfigurationSave,this));BX.addCustomEvent(this._fieldConfigurator,"onCancel",BX.delegate(this.onFieldConfigurationCancel,this))};BX.Crm.EntityEditorSection.prototype.removeFieldConfigurator=function(){if(this._fieldConfigurator){var t=this._fieldConfigurator.getField();if(t){t.setVisible(true)}this.removeChild(this._fieldConfigurator);this._fieldConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onFieldConfigurationSave=function(t,e){if(t!==this._fieldConfigurator){return}var i=BX.prop.get(e,"field",null);if(!i){throw"EntityEditorSection. Could not find target field."}var n=BX.prop.getString(e,"label","");if(n===""){this.removeFieldConfigurator();return}this._fieldConfigurator.setLocked(true);i.setTitle(n);this.markSchemeAsChanged();this.saveScheme().then(BX.delegate(function(){this.removeFieldConfigurator()},this))};BX.Crm.EntityEditorSection.prototype.onFieldConfigurationCancel=function(t,e){if(t!==this._fieldConfigurator){return}var i=BX.prop.get(e,"field",null);if(!i){throw"EntityEditorSection. Could not find target field."}this.removeFieldConfigurator()};BX.Crm.EntityEditorSection.prototype.onDeleteConfirm=function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this._editor.removeSchemeElement(this.getSchemeElement());this._editor.removeControl(this);this._editor.saveScheme()};BX.Crm.EntityEditorSection.prototype.onDeleteSectionBtnClick=function(t){if(this.isRequired()||this.isRequiredConditionally()){return}var e=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!e){e=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("deleteSection"),content:this.getMessage("deleteSectionConfirm")})}e.open().then(BX.delegate(this.onDeleteConfirm,this))};BX.Crm.EntityEditorSection.prototype.hasPlaceHolder=function(){return!!this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.createPlaceHolder=function(t){var e=this.getChildCount();if(t<0||t>e){t=e>0?e:0}if(this._dragPlaceHolder){if(this._dragPlaceHolder.getIndex()===t){return this._dragPlaceHolder}this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}this._dragPlaceHolder=BX.Crm.EditorDragFieldPlaceholder.create({container:this._contentContainer,anchor:t<e?this._fields[t].getWrapper():this._buttonPanelWrapper,index:t});this._dragPlaceHolder.layout();return this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.getPlaceHolder=function(){return this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.removePlaceHolder=function(){if(this._dragPlaceHolder){this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}};BX.Crm.EntityEditorSection.prototype.processDraggedItemDrop=function(t,e){var i=t.getCharge();if(!(i instanceof BX.Crm.EditorFieldDragContainer&&i.getSection()===this)){return}var n=e.getContextData();var r=BX.type.isNotEmptyString(n["contextId"])?n["contextId"]:"";if(r!==this.getDraggableContextId()){return}var o=typeof n["charge"]!=="undefined"?n["charge"]:null;if(!(o instanceof BX.Crm.EditorFieldDragItem)){return}var s=o.getControl();if(!s){return}var a=this.getChildIndex(s);if(a<0){return}var l=this.getPlaceHolder();var d=l?l.getIndex():-1;if(d<0){return}var h=d<=a?d:d-1;if(h!==a){this.moveChild(s,h)}};BX.Crm.EntityEditorSection.prototype.onDrop=function(t,e,i,n){this.processDraggedItemDrop(t,e)};BX.Crm.EntityEditorSection.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.Crm.EditorDragItemController.create("section_"+this.getId(),{charge:BX.Crm.EditorSectionDragItem.create({control:this}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorSection.prototype.releaseDragDropAbilities=function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}};BX.Crm.EntityEditorSection.prototype.isRequired=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].isRequired()){return true}}return false};BX.Crm.EntityEditorSection.prototype.isRequiredConditionally=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].isRequiredConditionally()){return true}}return false};BX.Crm.EntityEditorSection.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorSection.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.EntityEditorSection.messages==="undefined"){BX.Crm.EntityEditorSection.messages={}}BX.Crm.EntityEditorSection.create=function(t,e){var i=new BX.Crm.EntityEditorSection;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorText==="undefined"){BX.Crm.EntityEditorText=function(){BX.Crm.EntityEditorText.superclass.constructor.apply(this);this._input=null;this._view=null};BX.extend(BX.Crm.EntityEditorText,BX.Crm.EntityEditorField);BX.Crm.EntityEditorText.prototype.focus=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){this._input.focus();this.scrollAnimate()}};BX.Crm.EntityEditorText.prototype.getLineCount=function(){return this._schemeElement.getDataIntegerParam("lineCount",1)};BX.Crm.EntityEditorText.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-text"}});this._input=null;this._view=null;var r=this.isDragEnabled();if(r){this._wrapper.appendChild(this.createDragButton())}var o=this.isContextMenuEnabled();if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));var s=this.getLineCount();if(s>1){this._input=BX.create("textarea",{props:{className:"crm-entity-widget-content-textarea",name:e,rows:s,value:n}})}else{this._input=BX.create("input",{attrs:{name:e,className:"crm-entity-widget-content-input",type:"text",value:n}})}BX.bind(this._input,"input",this._changeHandler);if(s>1){this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-textarea"},children:[this._input]}))}else{this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._input]}))}if(this._editor.isDuplicateControlEnabled()){var a=this.getDuplicateControlConfig();if(a){if(!BX.type.isPlainObject(a["field"])){a["field"]={}}a["field"]["id"]=this.getId();a["field"]["element"]=this._input;this._editor.getDuplicateManager().registerField(a)}}}else if(this._mode===BX.Crm.EntityEditorMode.view&&this.checkIfNotEmpty(n)){this._wrapper.appendChild(this.createTitleNode(i));this._view=null;if(this.getLineCount()>1){this._view=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},html:BX.util.nl2br(BX.util.htmlspecialchars(n))})}else{this._view=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:n});if(o||r){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-small")}}this._wrapper.appendChild(this._view)}if(o){this._wrapper.appendChild(this.createContextMenuButton())}if(r){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorText.prototype.clearLayout=function(){if(!this._hasLayout){return}if(this._editor.isDuplicateControlEnabled()){var t=this.getDuplicateControlConfig();if(t){if(!BX.type.isPlainObject(t["field"])){t["field"]={}}t["field"]["id"]=this.getId();this._editor.getDuplicateManager().unregisterField(t)}}this.releaseDragDropAbilities();this._wrapper=BX.remove(this._wrapper);this._input=null;this._view=null;this._hasLayout=false};BX.Crm.EntityEditorText.prototype.refreshLayout=function(){if(!this._hasLayout){return}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._input){this._input.value=this.getValue()}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._view){this._view.innerHTML=BX.util.htmlspecialchars(this.getValue())}};BX.Crm.EntityEditorText.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?BX.util.trim(this._input.value):""};BX.Crm.EntityEditorText.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorText. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorText.prototype.showError=function(t,e){BX.Crm.EntityEditorText.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorText.prototype.clearError=function(){BX.Crm.EntityEditorText.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorText.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.value,{originator:this})}};BX.Crm.EntityEditorText.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorText.create=function(t,e){var i=new BX.Crm.EntityEditorText;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorNumber==="undefined"){BX.Crm.EntityEditorNumber=function(){BX.Crm.EntityEditorNumber.superclass.constructor.apply(this);this._input=null};BX.extend(BX.Crm.EntityEditorNumber,BX.Crm.EntityEditorField);BX.Crm.EntityEditorNumber.prototype.focus=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){this.scrollAnimate();this._input.focus()}};BX.Crm.EntityEditorNumber.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-number"}});this._input=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{attrs:{name:e,className:"crm-entity-widget-content-input",type:"text",value:n}});BX.bind(this._input,"input",this._changeHandler);this._wrapper.appendChild(this.createDragButton());this._wrapper.appendChild(this.createTitleNode(i));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._input]}));this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}else if(this._mode===BX.Crm.EntityEditorMode.view&&this.checkIfNotEmpty(n)){this._wrapper.appendChild(this.createTitleNode(i));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:n}))}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorNumber.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();this._wrapper=BX.remove(this._wrapper);this._input=null;this._hasLayout=false};BX.Crm.EntityEditorNumber.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorNumber. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorNumber.prototype.showError=function(t,e){BX.Crm.EntityEditorNumber.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorNumber.prototype.clearError=function(){BX.Crm.EntityEditorNumber.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorNumber.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.value)}};BX.Crm.EntityEditorNumber.create=function(t,e){var i=new BX.Crm.EntityEditorNumber;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorDatetime==="undefined"){BX.Crm.EntityEditorDatetime=function(){BX.Crm.EntityEditorDatetime.superclass.constructor.apply(this);this._input=null;this._inputClickHandler=BX.delegate(this.onInputClick,this)};BX.extend(BX.Crm.EntityEditorDatetime,BX.Crm.EntityEditorField);BX.Crm.EntityEditorDatetime.prototype.focus=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){this.scrollAnimate();this._input.focus()}};BX.Crm.EntityEditorDatetime.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-date"}});this._input=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{attrs:{name:e,className:"crm-entity-widget-content-input",type:"text",value:n}});BX.bind(this._input,"click",this._inputClickHandler);BX.bind(this._input,"change",this._changeHandler);BX.bind(this._input,"input",this._changeHandler);this._wrapper.appendChild(this.createDragButton());this._wrapper.appendChild(this.createTitleNode(i));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-field-half-width"},children:[this._input]}));this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}else if(this._mode===BX.Crm.EntityEditorMode.view&&this.checkIfNotEmpty(n)){n=BX.date.format("j F Y",BX.parseDate(n));this._wrapper.appendChild(this.createTitleNode(i));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:n}))}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorDatetime.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();this._wrapper=BX.remove(this._wrapper);this._input=null;this._hasLayout=false};BX.Crm.EntityEditorDatetime.prototype.onInputClick=function(t){BX.calendar({node:this._input,field:this._input,bTime:false,bSetFocus:false})};BX.Crm.EntityEditorDatetime.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorDatetime. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorDatetime.prototype.showError=function(t,e){BX.Crm.EntityEditorDatetime.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorDatetime.prototype.clearError=function(){BX.Crm.EntityEditorDatetime.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorDatetime.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.value)}};BX.Crm.EntityEditorDatetime.create=function(t,e){var i=new BX.Crm.EntityEditorDatetime;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorBoolean==="undefined"){BX.Crm.EntityEditorBoolean=function(){BX.Crm.EntityEditorBoolean.superclass.constructor.apply(this);this._input=null};BX.extend(BX.Crm.EntityEditorBoolean,BX.Crm.EntityEditorField);BX.Crm.EntityEditorBoolean.prototype.doInitialize=function(){BX.Crm.EntityEditorBoolean.superclass.doInitialize.apply(this);this._selectedValue=this._model.getField(this._schemeElement.getName())};BX.Crm.EntityEditorBoolean.prototype.hasValue=function(){return BX.util.trim(this.getValue())!==""};BX.Crm.EntityEditorBoolean.prototype.getValue=function(t){if(!this._model){return""}if(t===undefined){t="N"}var e=this._model.getStringField(this.getName(),t);if(e!=="Y"&&e!=="N"){e="N"}return e};BX.Crm.EntityEditorBoolean.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-checkbox"}});this._input=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createDragButton());this._wrapper.appendChild(BX.create("input",{attrs:{name:e,type:"hidden",value:"N"}}));this._input=BX.create("input",{attrs:{className:"crm-entity-widget-content-checkbox",name:e,type:"checkbox",value:"Y",checked:n==="Y"}});BX.bind(this._input,"change",this._changeHandler);this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("label",{attrs:{className:"crm-entity-widget-content-block-checkbox-label"},children:[this._input,BX.create("span",{props:{className:"crm-entity-widget-content-block-checkbox-description"},text:i})]})]}));this.initializeDragDropAbilities();this._wrapper.appendChild(this.createContextMenuButton())}else{this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},text:i}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage(n==="Y"?"yes":"no")}))}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorBoolean.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();this._wrapper=BX.remove(this._wrapper);this._input=null;this._hasLayout=false};BX.Crm.EntityEditorBoolean.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorBoolean. Invalid validation context"}if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));BX.addClass(this._input,"crm-entity-widget-content-error");this.showRequiredFieldError(this._input)}else{BX.removeClass(this._input,"crm-entity-widget-content-error");this.clearError()}return e};BX.Crm.EntityEditorBoolean.prototype.showError=function(t,e){BX.Crm.EntityEditorBoolean.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorBoolean.prototype.clearError=function(){BX.Crm.EntityEditorBoolean.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorBoolean.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.checked?"Y":"N",{originator:this})}};BX.Crm.EntityEditorBoolean.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorBoolean.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorUser.superclass.getMessage.apply(this,arguments)};if(typeof BX.Crm.EntityEditorBoolean.messages==="undefined"){BX.Crm.EntityEditorBoolean.messages={}}BX.Crm.EntityEditorBoolean.create=function(t,e){var i=new BX.Crm.EntityEditorBoolean;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorList==="undefined"){BX.Crm.EntityEditorList=function(){BX.Crm.EntityEditorList.superclass.constructor.apply(this);this._items=null;this._input=null;this._selectContainer=null;this._selectedValue="";this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._view=null;this._isOpened=false};BX.extend(BX.Crm.EntityEditorList,BX.Crm.EntityEditorField);BX.Crm.EntityEditorList.prototype.checkIfNotEmpty=function(t){return t!==""&&t!=="0"};BX.Crm.EntityEditorList.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this.getTitle();var n=this.getValue();var r=this.getItemByValue(n);if(!r){r=this.getFirstItem();if(r){n=r["VALUE"]}}this._selectedValue=n;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-select"}});this._selectContainer=null;this._input=null;this._view=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:r?r["NAME"]:n});BX.bind(this._selectContainer,"click",this._selectorClickHandler);this._wrapper.appendChild(this.createDragButton());this._wrapper.appendChild(this.createTitleNode(i));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-select"},children:[this._selectContainer]}));this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}else if(this._mode===BX.Crm.EntityEditorMode.view&&this.checkIfNotEmpty(n)){this._wrapper.appendChild(this.createTitleNode(i));this._view=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:r?r["NAME"]:n});this._wrapper.appendChild(this._view)}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorList.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();this._wrapper=BX.remove(this._wrapper);this._input=null;this._selectContainer=null;this._hasLayout=false};BX.Crm.EntityEditorList.prototype.refreshLayout=function(){if(!this._hasLayout){return}var t=this.getValue();var e=this.getItemByValue(t);var i=e?BX.prop.getString(e,"NAME",t):t;if(this._mode===BX.Crm.EntityEditorMode.edit){this._selectedValue=t;if(this._input){this._input.value=t}if(this._selectContainer){this._selectContainer.innerHTML=BX.util.htmlspecialchars(i)}}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._view){this._view.innerHTML=BX.util.htmlspecialchars(i)}};BX.Crm.EntityEditorList.prototype.validate=function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){throw"BX.Crm.EntityEditorList. Invalid validation context"}if(!this.isEditable()){return true}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorList.prototype.showError=function(t,e){BX.Crm.EntityEditorList.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorList.prototype.clearError=function(){BX.Crm.EntityEditorList.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorList.prototype.onSelectorClick=function(t){if(!this._isOpened){this.openMenu()}else{this.closeMenu()}};BX.Crm.EntityEditorList.prototype.openMenu=function(){if(this._isOpened){return}var t=[];var e=this.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(!BX.prop.getBoolean(r,"IS_EDITABLE",true)){continue}var o=BX.prop.getString(r,"VALUE",i);var s=BX.prop.getString(r,"NAME",o);t.push({text:s,value:o,onclick:BX.delegate(this.onItemSelect,this)})}BX.PopupMenu.show(this._id,this._selectContainer,t,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._selectContainer)["width"])};BX.Crm.EntityEditorList.prototype.closeMenu=function(){var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorList.prototype.onMenuShow=function(){BX.addClass(this._selectContainer,"active");this._isOpened=true};BX.Crm.EntityEditorList.prototype.onMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isOpened=false};BX.Crm.EntityEditorList.prototype.onItemSelect=function(t,e){this.closeMenu();this._selectedValue=this._input.value=e.value;this._selectContainer.innerHTML=BX.util.htmlspecialchars(e.text);this.markAsChanged();BX.PopupMenu.destroy(this._id)};BX.Crm.EntityEditorList.prototype.getItems=function(){if(!this._items){this._items=BX.prop.getArray(this._schemeElement.getData(),"items")}return this._items};BX.Crm.EntityEditorList.prototype.getItemByValue=function(t){var e=this.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(t===BX.prop.getString(r,"VALUE","")){return r}}return null};BX.Crm.EntityEditorList.prototype.getFirstItem=function(){var t=this.getItems();return t.length>0?t[0]:null};BX.Crm.EntityEditorList.prototype.save=function(){if(!this.isEditable()){return}this._model.setField(this.getName(),this._selectedValue)};BX.Crm.EntityEditorList.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorList.create=function(t,e){var i=new BX.Crm.EntityEditorList;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorHtml==="undefined"){BX.Crm.EntityEditorHtml=function(){BX.Crm.EntityEditorHtml.superclass.constructor.apply(this);this._htmlEditorContainer=null;this._htmlEditor=null;this._input=null;this._editorInitializationHandler=BX.delegate(this.onEditorInitialized,this);this._viewClickHandler=BX.delegate(this.onViewClick,this)};BX.extend(BX.Crm.EntityEditorHtml,BX.Crm.EntityEditorField);BX.Crm.EntityEditorHtml.prototype.checkIfNotEmpty=function(t){return BX.Crm.EntityEditorHtml.isNotEmptyValue(t)};BX.Crm.EntityEditorHtml.prototype.layout=function(t){if(this._hasLayout){return}this.release();var e=this.getName();var i=this.getTitle();var n=this.getValue();this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-html"}});this._input=null;if(this._mode===BX.Crm.EntityEditorMode.edit){if(!this._editor){throw"BX.Crm.EntityEditorHtml: Editor instance is required for create layout."}var r=this._editor.getHtmlEditorConfig();if(!r){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor config."}this._htmlEditorContainer=BX(BX.prop.getString(r,"containerId"));if(!BX.type.isElementNode(this._htmlEditorContainer)){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor container."}this._htmlEditor=BXHtmlEditor.Get(BX.prop.getString(r,"id"));if(!this._htmlEditor){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor instance."}this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);this._wrapper.appendChild(this.createDragButton());this._wrapper.appendChild(this.createTitleNode(i));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._htmlEditorContainer]}));this._wrapper.appendChild(this.createContextMenuButton())}else if(this._mode===BX.Crm.EntityEditorMode.view&&this.checkIfNotEmpty(n)){this._wrapper.appendChild(this.createTitleNode(i));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},html:n}));BX.bindDelegate(this._wrapper,"mousedown",BX.delegate(this._filterViewNode,this),this._viewClickHandler)}this.registerLayout(t);if(this._mode===BX.Crm.EntityEditorMode.edit){if(!!this._htmlEditor.inited){this.prepareEditor()}else{BX.addCustomEvent(this._htmlEditor,"OnCreateIframeAfter",this._editorInitializationHandler);this._htmlEditor.Init()}window.top.setTimeout(BX.delegate(this.bindChangeEvent,this),1e3);this.initializeDragDropAbilities()}this._hasLayout=true};BX.Crm.EntityEditorHtml.prototype._filterViewNode=function(t){return true};BX.Crm.EntityEditorHtml.prototype.onViewClick=function(t){var e=null;var i=BX.getEventTarget(t);if(i.tagName==="A"){e=i}else{e=BX.findParent(i,{tagName:"a"},this._wrapper)}if(e&&e.target!=="_blank"){e.target="_blank"}};BX.Crm.EntityEditorHtml.prototype.onEditorInitialized=function(){BX.removeCustomEvent(this._htmlEditor,"OnCreateIframeAfter",this._editorInitializationHandler);this.prepareEditor()};BX.Crm.EntityEditorHtml.prototype.prepareEditor=function(){this._htmlEditorContainer.style.display="";this._htmlEditor.CheckAndReInit();this._htmlEditor.ResizeSceleton("100%",200);this._htmlEditor.SetContent(this.getStringValue(""),true)};BX.Crm.EntityEditorHtml.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();this.release();this._wrapper=BX.remove(this._wrapper);this._htmlEditorWrapper=null;this._input=null;this._hasLayout=false};BX.Crm.EntityEditorHtml.prototype.release=function(){if(this._htmlEditorContainer){var t=this._htmlEditorContainer.parentNode;var e=BX.create("div",{style:{height:this._htmlEditorContainer.offsetHeight+"px",border:"1px solid #bbc4cd",boxSizing:"border-box"}});t.insertBefore(e,this._htmlEditorContainer);document.body.appendChild(this._htmlEditorContainer);this._htmlEditorContainer.style.display="none";this._htmlEditorContainer=null}if(this._htmlEditor){this.unbindChangeEvent();this._htmlEditor.SetContent("");this._htmlEditor=null}};BX.Crm.EntityEditorHtml.prototype.bindChangeEvent=function(){if(this._htmlEditor){BX.addCustomEvent(this._htmlEditor,"OnContentChanged",this._changeHandler)}};BX.Crm.EntityEditorHtml.prototype.unbindChangeEvent=function(){if(this._htmlEditor){BX.removeCustomEvent(this._htmlEditor,"OnContentChanged",this._changeHandler)}};BX.Crm.EntityEditorHtml.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._htmlEditor)){throw"BX.Crm.EntityEditorHtml. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.Crm.EntityEditorHtml.isNotEmptyValue(this._htmlEditor.GetContent());if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._htmlEditorContainer)}return e};BX.Crm.EntityEditorHtml.prototype.showError=function(t,e){BX.Crm.EntityEditorHtml.superclass.showError.apply(this,arguments);if(this._htmlEditorContainer){BX.addClass(this._htmlEditorContainer,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorHtml.prototype.clearError=function(){BX.Crm.EntityEditorHtml.superclass.clearError.apply(this);if(this._htmlEditorContainer){BX.removeClass(this._htmlEditorContainer,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorHtml.prototype.save=function(){if(this._htmlEditor){var t=this._input.value=this._htmlEditor.GetContent();this._model.setField(this.getName(),t)}};BX.Crm.EntityEditorHtml.isNotEmptyValue=function(t){return BX.util.trim(t.replace(/<br\/?>|&nbsp;/gi,""))!==""};BX.Crm.EntityEditorHtml.create=function(t,e){var i=new BX.Crm.EntityEditorHtml;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMoney==="undefined"){BX.Crm.EntityEditorMoney=function(){BX.Crm.EntityEditorMoney.superclass.constructor.apply(this);this._currencyEditor=null;this._amountInput=null;this._currencyInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._selectedCurrencyValue="";this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._isCurrencyMenuOpened=false};BX.extend(BX.Crm.EntityEditorMoney,BX.Crm.EntityEditorField);BX.Crm.EntityEditorMoney.prototype.focus=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){this.scrollAnimate();this._amountInput.focus()}};BX.Crm.EntityEditorMoney.prototype.getValue=function(t){if(!this._model){return""}return this._model.getStringField(this.getAmountFieldName(),t!==undefined?t:"")};BX.Crm.EntityEditorMoney.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this.getTitle();var n=this.getData();var r=BX.prop.getString(n,"amount");var o=BX.prop.getString(BX.prop.getObject(n,"currency"),"name");var s=this._model.getField(BX.prop.getString(BX.prop.getObject(n,"currency"),"name",""));if(!BX.type.isNotEmptyString(s)){s=BX.Currency.Editor.getBaseCurrencyId()}this._selectedCurrencyValue=s;var a=this._editor.findOption(s,BX.prop.getArray(BX.prop.getObject(n,"currency"),"items"));var l=this.getAmountFieldName();var d=this._model.getField(l,"");var h=this._model.getField(BX.prop.getString(n,"formatted"),"");var p=this._model.getField(BX.prop.getString(n,"formattedWithCurrency"),"");this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-money"}});this._amountValue=null;this._amountInput=null;this._currencyInput=null;this._selectContainer=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._amountValue=BX.create("input",{attrs:{name:r,type:"hidden",value:d}});this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:d}});BX.bind(this._amountInput,"input",this._changeHandler);if(this._model.isFieldLocked(l)){this._amountInput.disabled=true}this._currencyInput=BX.create("input",{attrs:{name:o,type:"hidden",value:s}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:a});BX.bind(this._selectContainer,"click",this._selectorClickHandler);this._wrapper.appendChild(this.createDragButton());this._wrapper.appendChild(this.createTitleNode(i));this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._amountValue,this._amountInput,this._currencyInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"},children:[this._selectContainer]})]});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[this._inputWrapper]}));this._currencyEditor=new BX.Currency.Editor({input:this._amountInput,currency:s,callback:BX.delegate(this.onAmountValueChange,this)});this._currencyEditor.changeValue();this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}else{this._sumElement=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-wallet"}});this._sumElement.innerHTML=this.renderMoney();this._wrapper.appendChild(this.createTitleNode(i));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-colums-block"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-colums"},children:[this._sumElement]})]})]}))}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMoney.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();BX.PopupMenu.destroy(this._id);if(this._currencyEditor){this._currencyEditor.clean();this._currencyEditor=null}this._wrapper=BX.remove(this._wrapper);this._amountValue=null;this._amountInput=null;this._currencyInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._hasLayout=false};BX.Crm.EntityEditorMoney.prototype.refreshLayout=function(){if(!(this._hasLayout&&this._isValidLayout)){return}var t;if(this._mode===BX.Crm.EntityEditorMode.edit&&this._amountInput){t=this.getAmountFieldName();this._amountInput.value=this._model.getField(t,"");this._amountInput.disabled=this._model.isFieldLocked(t)}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._sumElement){this._sumElement.innerHTML=this.renderMoney()}};BX.Crm.EntityEditorMoney.prototype.onAmountValueChange=function(t){if(this._amountValue){this._amountValue.value=t}};BX.Crm.EntityEditorMoney.prototype.getAmountFieldName=function(){return this._schemeElement.getDataStringParam("amount","")};BX.Crm.EntityEditorMoney.prototype.getCurrencyFieldName=function(){return BX.prop.getString(this._schemeElement.getDataObjectParam("currency",{}),"name","")};BX.Crm.EntityEditorMoney.prototype.onSelectorClick=function(t){this.openCurrencyMenu()};BX.Crm.EntityEditorMoney.prototype.openCurrencyMenu=function(){if(this._isCurrencyMenuOpened){return}var t=this._schemeElement.getData();var e=BX.prop.getArray(BX.prop.getObject(t,"currency"),"items");var i=0;var n=[];while(i<e.length){n.push({text:e[i]["NAME"],value:e[i]["VALUE"],onclick:BX.delegate(this.onCurrencySelect,this)});i++}BX.PopupMenu.show(this._id,this._selectContainer,n,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onCurrencyMenuOpen,this),onPopupClose:BX.delegate(this.onCurrencyMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._selectContainer)["width"])};BX.Crm.EntityEditorMoney.prototype.closeCurrencyMenu=function(){if(!this._isCurrencyMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorMoney.prototype.onCurrencyMenuOpen=function(){BX.addClass(this._selectContainer,"active");this._isCurrencyMenuOpened=true};BX.Crm.EntityEditorMoney.prototype.onCurrencyMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isCurrencyMenuOpened=false};BX.Crm.EntityEditorMoney.prototype.onCurrencySelect=function(t,e){this.closeCurrencyMenu();this._selectedCurrencyValue=this._currencyInput.value=e.value;this._selectContainer.innerHTML=BX.util.htmlspecialchars(e.text);if(this._currencyEditor){this._currencyEditor.setCurrency(this._selectedCurrencyValue)}this.markAsChanged({fieldName:this.getCurrencyFieldName(),fieldValue:this._selectedCurrencyValue})};BX.Crm.EntityEditorMoney.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.this.getAmountFieldName()){return}this.refreshLayout()};BX.Crm.EntityEditorMoney.prototype.processModelLock=function(t){var e=BX.prop.getString(t,"name","");if(this.getAmountFieldName()===e){this.refreshLayout()}};BX.Crm.EntityEditorMoney.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._amountInput&&this._amountValue)){throw"BX.Crm.EntityEditorMoney. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._amountValue.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._inputWrapper)}return e};BX.Crm.EntityEditorMoney.prototype.showError=function(t,e){BX.Crm.EntityEditorMoney.superclass.showError.apply(this,arguments);if(this._amountInput){BX.addClass(this._amountInput,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorMoney.prototype.clearError=function(){BX.Crm.EntityEditorMoney.superclass.clearError.apply(this);if(this._amountInput){BX.removeClass(this._amountInput,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorMoney.prototype.save=function(){var t=this._schemeElement.getData();this._model.setField(BX.prop.getString(BX.prop.getObject(t,"currency"),"name"),this._selectedCurrencyValue);if(this._amountValue){this._model.setField(BX.prop.getString(t,"amount"),this._amountValue.value);this._model.setField(BX.prop.getString(t,"formatted"),this._amountValue.value);this._editor.formatMoney(this._amountValue.value,this._selectedCurrencyValue,BX.delegate(this.onMoneyFormatRequestSuccess,this))}};BX.Crm.EntityEditorMoney.prototype.onMoneyFormatRequestSuccess=function(t){var e=this._schemeElement.getData();var i=BX.type.isNotEmptyString(t["FORMATTED_SUM_WITH_CURRENCY"])?t["FORMATTED_SUM_WITH_CURRENCY"]:"";this._model.setField(BX.prop.getString(e,"formattedWithCurrency"),i);var n=BX.type.isNotEmptyString(t["FORMATTED_SUM"])?t["FORMATTED_SUM"]:"";this._model.setField(BX.prop.getString(e,"formatted"),n);if(this._sumElement){while(this._sumElement.firstChild){this._sumElement.removeChild(this._sumElement.firstChild)}this._sumElement.innerHTML=this.renderMoney()}};BX.Crm.EntityEditorMoney.prototype.renderMoney=function(){var t=this._schemeElement.getData();var e=this._model.getField(BX.prop.getString(t,"formattedWithCurrency"),"");var i=this._model.getField(BX.prop.getString(t,"formatted"),"");var n=BX.Currency.Editor.trimTrailingZeros(i,this._selectedCurrencyValue);return e.replace(i,'<span class="crm-entity-widget-content-block-colums-right">'+n+"</span>")};BX.Crm.EntityEditorMoney.create=function(t,e){var i=new BX.Crm.EntityEditorMoney;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorImage==="undefined"){BX.Crm.EntityEditorImage=function(){BX.Crm.EntityEditorImage.superclass.constructor.apply(this);this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorImage,BX.Crm.EntityEditorField);BX.Crm.EntityEditorImage.prototype.layout=function(t){if(this._hasLayout){return}var e=this._mode===BX.Crm.EntityEditorMode.view;var i=this.getName();var n=this.getTitle();var r=this._model.getMappedField(this.getData(),"showUrl","");this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-file"}});this._fileInput=null;if(!e){this._wrapper.appendChild(this.createDragButton());this._wrapper.appendChild(this.createTitleNode(n));this._fileInput=BX.create("input",{props:{type:"file",name:i}});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);this._editor.loadCustomHtml("RENDER_IMAGE_INPUT",{FIELD_NAME:i},BX.delegate(this.onEditorHtmlLoad,this));this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}else if(r!==""){this._wrapper.appendChild(this.createTitleNode(n));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);this._innerWrapper.appendChild(BX.create("img",{props:{className:"crm-entity-widget-content-block-photo",src:r}}))}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorImage.prototype.onEditorHtmlLoad=function(t){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._innerWrapper){this._innerWrapper.innerHTML=t}};BX.Crm.EntityEditorImage.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();this._innerWrapper=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorImage.create=function(t,e){var i=new BX.Crm.EntityEditorImage;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUser==="undefined"){BX.Crm.EntityEditorUser=function(){BX.Crm.EntityEditorUser.superclass.constructor.apply(this);this._input=null;this._editButton=null;this._photoElement=null;this._nameElement=null;this._positionElement=null;this._userSelector=null;this._selectedData={};this._editButtonClickHandler=BX.delegate(this.onEditBtnClick,this)};BX.extend(BX.Crm.EntityEditorUser,BX.Crm.EntityEditorField);BX.Crm.EntityEditorUser.prototype.layout=function(t){if(this._hasLayout){return}var e=this._schemeElement.getName();var i=this._schemeElement.getTitle();var n=this._model.getField(e);var r=this._model.getSchemeField(this._schemeElement,"formated","");var o=this._model.getSchemeField(this._schemeElement,"position","");var s=this._model.getSchemeField(this._schemeElement,"showUrl","","");var a=this._model.getSchemeField(this._schemeElement,"photoUrl","");var l=this._mode===BX.Crm.EntityEditorMode.view;var d=this.isEditInViewEnabled()&&!this.isReadOnly();this._photoElement=BX.create("a",{props:{className:"crm-widget-employee-avatar-container",href:s,target:"_blank"},style:{backgroundImage:a!==""?"url('"+a+"')":"",backgroundSize:a!==""?"30px":""}});this._nameElement=BX.create("a",{props:{className:"crm-widget-employee-name",href:s,target:"_blank"},text:r});this._positionElement=BX.create("SPAN",{props:{className:"crm-widget-employee-position"},text:o});this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});if(!l){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));this.registerLayout(t);var h=BX.create("div",{props:{className:"crm-widget-employee-container"}});this._editButton=null;this._input=null;if(!l||d){this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);this._editButton=BX.create("span",{props:{className:"crm-widget-employee-change"},text:this.getMessage("change")});BX.bind(this._editButton,"click",this._editButtonClickHandler);h.appendChild(this._editButton)}h.appendChild(this._photoElement);h.appendChild(BX.create("span",{props:{className:"crm-widget-employee-info"},children:[this._nameElement,this._positionElement]}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-text"},children:[h]}));if(!l){this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}this._hasLayout=true};BX.Crm.EntityEditorUser.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();this._wrapper=BX.remove(this._wrapper);this._input=null;this._editButton=null;this._photoElement=null;this._nameElement=null;this._positionElement=null;this._hasLayout=false};BX.Crm.EntityEditorUser.prototype.onEditBtnClick=function(t){if(!this._userSelector){this._userSelector=BX.Crm.EntityEditorUserSelector.create(this._id,{callback:BX.delegate(this.processItemSelect,this)})}this._userSelector.open(this._editButton)};BX.Crm.EntityEditorUser.prototype.processItemSelect=function(t,e){var i=this._mode===BX.Crm.EntityEditorMode.view;var n=this.isEditInViewEnabled();if(i&&!n){return}this._selectedData={id:BX.prop.getInteger(e,"entityId",0),photoUrl:BX.prop.getString(e,"avatar",""),formattedNameHtml:BX.prop.getString(e,"name",""),positionHtml:BX.prop.getString(e,"desc","")};this._input.value=this._selectedData["id"];this._photoElement.style.backgroundImage=this._selectedData["photoUrl"]!==""?"url('"+this._selectedData["photoUrl"]+"')":"";this._photoElement.style.backgroundSize=this._selectedData["photoUrl"]!==""?"30px":"";this._nameElement.innerHTML=this._selectedData["formattedNameHtml"];this._positionElement.innerHTML=this._selectedData["positionHtml"];this._userSelector.close();if(!i){this.markAsChanged()}else{this._editor.saveControl(this)}};BX.Crm.EntityEditorUser.prototype.save=function(){var t=this._schemeElement.getData();if(this._selectedData["id"]>0){var e=this._selectedData["id"];this._model.setField(this.getName(),e);this._model.setField(BX.prop.getString(t,"formated"),BX.util.htmlspecialcharsback(this._selectedData["formattedNameHtml"]));this._model.setField(BX.prop.getString(t,"position"),this._selectedData["positionHtml"]!=="&nbsp;"?BX.util.htmlspecialcharsback(this._selectedData["positionHtml"]):"");this._model.setField(BX.prop.getString(t,"showUrl"),BX.prop.getString(t,"pathToProfile").replace(/#user_id#/gi,e));this._model.setField(BX.prop.getString(t,"photoUrl"),this._selectedData["photoUrl"])}};BX.Crm.EntityEditorUser.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorUser.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorUser.superclass.getMessage.apply(this,arguments)};if(typeof BX.Crm.EntityEditorUser.messages==="undefined"){BX.Crm.EntityEditorUser.messages={}}BX.Crm.EntityEditorUser.create=function(t,e){var i=new BX.Crm.EntityEditorUser;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorAddress==="undefined"){BX.Crm.EntityEditorAddress=function(){BX.Crm.EntityEditorAddress.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorAddress,BX.Crm.EntityEditorField);BX.Crm.EntityEditorAddress.prototype.layout=function(t){if(this._hasLayout){return}var e=this._mode===BX.Crm.EntityEditorMode.view;var i=this._schemeElement.getName();var n=this.getTitle();var r=this._schemeElement.getDataObjectParam("fields",{});var o=this._schemeElement.getDataObjectParam("labels",{});this._wrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block"}});if(!e){this._wrapper.appendChild(this.createDragButton());this._wrapper.appendChild(this.createTitleNode(n));var s=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-inner-address"}});this._wrapper.appendChild(s);for(var a in r){if(!r.hasOwnProperty(a)){return}var l=r[a];var d=BX.prop.getString(o,a,a);this.layoutField(a,l,d,s)}this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}else{var h=this._schemeElement.getDataStringParam("view","");if(h===""){h=i+"_HML"}var p=this._model.getStringField(h,"");if(p!==""){this._wrapper.appendChild(this.createTitleNode(n));this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},html:p}))}}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorAddress.prototype.layoutField=function(t,e,i,n){var r=BX.prop.getString(e,"NAME",t);var o=this._model.getStringField(r,"");n.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},text:i}));if(BX.prop.getBoolean(e,"IS_MULTILINE",false)){n.appendChild(BX.create("textarea",{props:{className:"crm-entity-widget-content-input",name:r,type:"text",value:o}}))}else{n.appendChild(BX.create("input",{props:{className:"crm-entity-widget-content-input",name:r,type:"text",value:o}}))}};BX.Crm.EntityEditorAddress.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorAddress.create=function(t,e){var i=new BX.Crm.EntityEditorAddress;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifieldItem==="undefined"){BX.Crm.EntityEditorMultifieldItem=function(){this._id="";this._settings={};this._parent=null;this._editor=null;this._mode=BX.Crm.EntityEditorMode.view;this._data=null;this._typeId="";this._valueTypeItems=null;this._container=null;this._wrapper=null;this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;this._hasLayout=false};BX.Crm.EntityEditorMultifieldItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._parent=BX.prop.get(this._settings,"parent",null);this._editor=this._parent.getEditor();this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);this._typeId=BX.prop.getString(this._settings,"typeId","");this._data=BX.prop.getObject(this._settings,"data",{});this._valueTypeItems=BX.prop.getArray(this._settings,"valueTypeItems",[]);this._container=BX.prop.getElementNode(this._settings,"container",null)},getId:function(){return this._id},isEmpty:function(){return BX.util.trim(this.getValue())===""},getTypeId:function(){return this._typeId},getValue:function(){return BX.prop.getString(this._data,"VALUE","")},getValueId:function(){return BX.prop.getString(this._data,"ID","")},getValueTypeId:function(){var t=BX.prop.getString(this._data,"VALUE_TYPE","");return t!==""?t:this.getDefaultValueTypeId()},getDefaultValueTypeId:function(){return this._valueTypeItems.length>0?BX.prop.getString(this._valueTypeItems[0],"VALUE"):""},getViewData:function(){return BX.prop.getObject(this._data,"VIEW_DATA",{})},resolveValueTypeName:function(t){if(t===""){return""}for(var e=0,i=this._valueTypeItems.length;e<i;e++){var n=this._valueTypeItems[e];if(t===BX.prop.getString(n,"VALUE","")){return BX.prop.getString(n,"NAME",t)}}return t},prepareControlName:function(t){return this.getTypeId()+"["+this.getValueId()+"]"+"["+t+"]"},getMode:function(){return this._mode},setMode:function(t){this._mode=t},getContainer:function(){return this._container},setContainer:function(t){this._container=t;if(this._hasLayout){this.clearLayout()}},layout:function(){if(this._hasLayout){return}this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;var t=this.getValueTypeId();var e=this.getValue();this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"}});this._container.appendChild(this._wrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){this._valueInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:this.prepareControlName("VALUE"),type:"text",value:e}});BX.bind(this._valueInput,"input",BX.delegate(this.onValueChange,this));this._wrapper.appendChild(this._valueInput);this._valueTypeInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE_TYPE"),type:"hidden",value:t}});this._wrapper.appendChild(this._valueTypeInput);this._valueTypeSelector=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:this.resolveValueTypeName(t),events:{click:BX.delegate(this.onValueTypeSelectorClick,this)}});this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-select"},children:[this._valueTypeSelector]}));if(this._editor.isDuplicateControlEnabled()){var i=this._parent.getDuplicateControlConfig();if(i){if(!BX.type.isPlainObject(i["field"])){i["field"]={}}i["field"]["id"]=this.getValueId();i["field"]["element"]=this._valueInput;this._editor.getDuplicateManager().registerField(i)}}}else if(this._mode===BX.Crm.EntityEditorMode.view){var n=this.getViewData();var r=BX.prop.getString(n,"value","");if(r===""){r=BX.util.htmlspecialchars(e)}this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-type"},text:this.resolveValueTypeName(t)}));var o=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-value"},html:r});this._wrapper.appendChild(o);if(this._parent.getMultifieldType()==="EMAIL"){var s=o.querySelector("a.crm-entity-email");if(s){BX.bind(s,"click",BX.delegate(this.onEmailClick,this))}}}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._editor.isDuplicateControlEnabled()){var t=this._parent.getDuplicateControlConfig();if(t){if(!BX.type.isPlainObject(t["field"])){t["field"]={}}t["field"]["id"]=this.getValueId();this._editor.getDuplicateManager().unregisterField(t)}}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},onValueChange:function(t){this._parent.processItemChange(this)},onValueTypeSelectorClick:function(t){var e=[];for(var i=0,n=this._valueTypeItems.length;i<n;i++){var r=this._valueTypeItems[i];e.push({text:r["NAME"],value:r["VALUE"],onclick:BX.delegate(this.onValueTypeSelect,this)})}BX.addClass(this._valueTypeSelector,"active");BX.PopupMenu.destroy(this._id);BX.PopupMenu.show(this._id,this._valueTypeSelector,e,{angle:false,width:this._valueTypeSelector.offsetWidth+"px",events:{onPopupClose:BX.delegate(this.onValuTypeMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._valueTypeSelector)["width"])},onValuTypeMenuClose:function(t){BX.removeClass(this._valueTypeSelector,"active")},onValueTypeSelect:function(t,e){BX.removeClass(this._valueTypeSelector,"active");this._valueTypeInput.value=e.value;this._valueTypeSelector.innerHTML=BX.util.htmlspecialchars(e.text);this._parent.processItemChange(this);BX.PopupMenu.destroy(this._id)},onEmailClick:function(t){if(BX.CrmActivityEditor){var e=this._editor.getOwnerInfo();var i={ownerType:e["ownerType"],ownerID:e["ownerID"],communications:[{entityType:e["ownerType"],entityId:e["ownerID"],type:"EMAIL",value:this.getValue()}]};BX.CrmActivityEditor.addEmail(i)}return BX.PreventDefault(t)}};BX.Crm.EntityEditorMultifieldItem.create=function(t,e){var i=new BX.Crm.EntityEditorMultifieldItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifieldItemPhone==="undefined"){BX.Crm.EntityEditorMultifieldItemPhone=function(){this._maskedPhone=null;this._maskedValueInput=null;this._countryFlagNode=null};BX.extend(BX.Crm.EntityEditorMultifieldItemPhone,BX.Crm.EntityEditorMultifieldItem);BX.Crm.EntityEditorMultifieldItemPhone.prototype.layout=function(){var t=this;if(this._hasLayout){return}this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;var e=this.getValueTypeId();var i=this.getValue();this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"}});this._container.appendChild(this._wrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){this._valueInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE"),type:"hidden",value:i}});this._wrapper.appendChild(this._valueInput);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-input-phone-wrapper"},children:[this._countryFlagNode=BX.create("span",{props:{className:"crm-entity-widget-content-country-flag"}}),this._maskedValueInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input crm-entity-widget-content-input-phone",type:"text",value:i}})]}));this._maskedPhone=new BX.PhoneNumber.Input({node:this._maskedValueInput,flagNode:this._countryFlagNode,flagSize:24,onChange:function(e){t._valueInput.value=e.value;t.onValueChange()}});this._valueTypeInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE_TYPE"),type:"hidden",value:e}});this._wrapper.appendChild(this._valueTypeInput);this._valueTypeSelector=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:this.resolveValueTypeName(e),events:{click:BX.delegate(this.onValueTypeSelectorClick,this)}});this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-select"},children:[this._valueTypeSelector]}));if(this._editor.isDuplicateControlEnabled()){var n=this._parent.getDuplicateControlConfig();if(n){if(!BX.type.isPlainObject(n["field"])){n["field"]={}}n["field"]["id"]=this.getValueId();n["field"]["element"]=this._maskedValueInput;this._editor.getDuplicateManager().registerField(n)}}}else if(this._mode===BX.Crm.EntityEditorMode.view){var r=this.getViewData();var o=BX.prop.getString(r,"value","");if(o===""){o=BX.util.htmlspecialchars(i)}this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-type"},text:this.resolveValueTypeName(e)}));this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-value"},html:o}))}this._hasLayout=true};BX.Crm.EntityEditorMultifieldItemPhone.create=function(t,e){var i=new BX.Crm.EntityEditorMultifieldItemPhone;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifield==="undefined"){BX.Crm.EntityEditorMultifield=function(){BX.Crm.EntityEditorMultifield.superclass.constructor.apply(this);this._items=null;this._itemWrapper=null};BX.extend(BX.Crm.EntityEditorMultifield,BX.Crm.EntityEditorField);BX.Crm.EntityEditorMultifield.prototype.doInitialize=function(){this.initializeItems()};BX.Crm.EntityEditorMultifield.prototype.initializeItems=function(){var t=this.getName();var e=this._model.getField(t,[]);if(e.length===0){e.push({ID:"n0"})}for(var i=0,n=e.length;i<n;i++){this.addItem(e[i])}};BX.Crm.EntityEditorMultifield.prototype.resetItems=function(){if(this._hasLayout){for(var t=0,e=this._items.length;t<e;t++){this._items[t].clearLayout()}}this._items=[]};BX.Crm.EntityEditorMultifield.prototype.hasValue=function(){var t=this._items.length;if(t===0){return false}for(var e=0;e<t;e++){if(!this._items[e].isEmpty()){return true}}return false};BX.Crm.EntityEditorMultifield.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorMultifield.prototype.prepareItemsLayout=function(){for(var t=0,e=this._items.length;t<e;t++){var i=this._items[t];i.setMode(this._mode);i.setContainer(this._itemWrapper);i.layout()}};BX.Crm.EntityEditorMultifield.prototype.refreshLayout=function(){if(!this._hasLayout){return}this.resetItems();this.initializeItems();this.prepareItemsLayout()};BX.Crm.EntityEditorMultifield.prototype.layout=function(t){if(this._hasLayout){return}var e=this._schemeElement.getTitle();this._wrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-field-multifield"}});if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._itemWrapper=BX.create("div",{});this._wrapper.appendChild(this._itemWrapper);this.prepareItemsLayout();this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-add-field"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-add-field"},text:this.getMessage("add"),events:{click:BX.delegate(this.onAddButtonClick,this)}})]}));this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}else if(this._mode===BX.Crm.EntityEditorMode.view&&this.hasValue()){this._wrapper.appendChild(this.createTitleNode(e));this._itemWrapper=BX.create("div",{});this._wrapper.appendChild(this._itemWrapper);this.prepareItemsLayout()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMultifield.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();for(var t=0,e=this._items.length;t<e;t++){var i=this._items[t];i.clearLayout();i.setContainer(null)}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorMultifield.prototype.getMultifieldType=function(){return this._schemeElement.getDataStringParam("type","")};BX.Crm.EntityEditorMultifield.prototype.addItem=function(t){var e;var i=this._schemeElement.getName();if(i==="PHONE"){e=BX.Crm.EntityEditorMultifieldItemPhone.create("",{parent:this,typeId:this._schemeElement.getName(),valueTypeItems:this._schemeElement.getDataArrayParam("items",[]),data:t})}else{e=BX.Crm.EntityEditorMultifieldItem.create("",{parent:this,typeId:this._schemeElement.getName(),valueTypeItems:this._schemeElement.getDataArrayParam("items",[]),data:t})}if(this._items===null){this._items=[]}this._items.push(e);if(this._hasLayout){e.setMode(this._mode);e.setContainer(this._itemWrapper);e.layout()}return e};BX.Crm.EntityEditorMultifield.prototype.onAddButtonClick=function(t){this.addItem({ID:"n"+this._items.length.toString()})};BX.Crm.EntityEditorMultifield.prototype.processItemChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorMultifield.create=function(t,e){var i=new BX.Crm.EntityEditorMultifield;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorClient==="undefined"){BX.Crm.EntityEditorClient=function(){BX.Crm.EntityEditorClient.superclass.constructor.apply(this);this._info=null;this._enablePrimaryEntity=true;this._primaryEntityTypeName="";this._primaryEntityInfo=null;this._primaryEntityBindingInfos=null;this._primaryEntityEditor=null;this._secondaryEntityTypeName="";this._secondaryEntityInfos=null;this._secondaryEntityEditor=null;this._dataElements=null;this._map=null;this._bindingTracker=null};BX.extend(BX.Crm.EntityEditorClient,BX.Crm.EntityEditorField);BX.Crm.EntityEditorClient.prototype.doInitialize=function(){BX.Crm.EntityEditorClient.superclass.doInitialize.apply(this);this._map=this._schemeElement.getDataObjectParam("map",{});this.initializeFromModel()};BX.Crm.EntityEditorClient.prototype.initializeFromModel=function(){this._info=this._model.getSchemeField(this._schemeElement,"info",{});this._enablePrimaryEntity=this._schemeElement.getDataBooleanParam("enablePrimaryEntity",true);if(this._enablePrimaryEntity){var t=BX.prop.getObject(this._info,"PRIMARY_ENTITY_DATA",null);var e=t?BX.CrmEntityInfo.create(t):null;if(e){this.setPrimaryEntity(e)}else{this.setPrimaryEntityTypeName(this._schemeElement.getDataStringParam("primaryEntityTypeName",BX.CrmEntityType.names.company))}}this.setSecondaryEntityTypeName(this._schemeElement.getDataStringParam("secondaryEntityTypeName",BX.CrmEntityType.names.contact));var i=null;var n=this._schemeElement.getDataStringParam("secondaryEntityInfo","");if(n!==""){i=this._model.getField(n,[])}else{i=BX.prop.getArray(this._info,"SECONDARY_ENTITY_DATA",[])}this._secondaryEntityInfos=BX.Collection.create();this._primaryEntityBindingInfos=BX.Collection.create();var r=e&&e.getTypeName()===BX.CrmEntityType.names.company?e.getId():0;var o,s,a;for(o=0,s=i.length;o<s;o++){a=BX.CrmEntityInfo.create(i[o]);if(a.getId()<=0){continue}if(r>0&&a.checkEntityBinding(BX.CrmEntityType.names.company,r)){this._primaryEntityBindingInfos.add(a)}else{this._secondaryEntityInfos.add(a)}}this._bindingTracker=BX.Crm.EntityBindingTracker.create()};BX.Crm.EntityEditorClient.prototype.getEntityCreateUrl=function(t){return this._editor.getEntityCreateUrl(t)};BX.Crm.EntityEditorClient.prototype.getEntityRequisiteSelectUrl=function(t,e){return this._editor.getEntityRequisiteSelectUrl(t,e)};BX.Crm.EntityEditorClient.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorClient.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorClient.prototype.createDataElement=function(t,e){var i=BX.prop.getString(this._map,t,"");if(i===""){return}var n=BX.create("input",{attrs:{name:i,type:"hidden",value:e}});if(!this._dataElements){this._dataElements={}}this._dataElements[t]=n;if(this._wrapper){this._wrapper.appendChild(n)}};BX.Crm.EntityEditorClient.prototype.layout=function(t){if(this._hasLayout){return}var e=this._schemeElement.getTitle();var i=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});if(!i){this._wrapper.appendChild(this.createDragButton())}else if(!this._primaryEntityInfo&&this._secondaryEntityInfos.length()===0){this.registerLayout(t);this._hasLayout=true;return}var n=BX.create("div",{props:{className:"crm-entity-widget-clients-block"}});this._wrapper.appendChild(n);n.appendChild(this.createTitleNode(e));this._dataElements={};if(!i){if(this._enablePrimaryEntity){this.createDataElement("primaryEntityType",this.getPrimaryEntityTypeName());this.createDataElement("primaryEntityId",this.getPrimaryEntityId());this.createDataElement("unboundSecondaryEntityIds","");this.createDataElement("boundSecondaryEntityIds","")}this.createDataElement("secondaryEntityType",this.getSecondaryEntityTypeName());this.createDataElement("secondaryEntityIds",this.getAllSecondaryEntityIds().join(","))}var r=BX.create("div",{props:{className:!i?"crm-entity-widget-content-block-clients":""}});n.appendChild(r);var o=BX.create("div",{});r.appendChild(o);var s=this._schemeElement.getDataObjectParam("loaders",{});var a=BX.prop.getObject(s,"primary",{});var l=BX.prop.getObject(s,"secondary",{});if(this._enablePrimaryEntity){this._primaryEntityEditor=BX.Crm.PrimaryClientEditor.create(this._id+"_PRIMARY",{entityInfo:this._primaryEntityInfo,entityTypeName:this._primaryEntityTypeName,loaderConfig:a,requisiteBinding:this._model.getField("REQUISITE_BINDING",{}),editor:this,mode:this._mode,onChange:BX.delegate(this.onPrimaryEntityChange,this),onDelete:BX.delegate(this.onPrimaryEntityDelete,this),onBindingAdd:BX.delegate(this.onPrimaryEntityBindingAdd,this),onBindingDelete:BX.delegate(this.onPrimaryEntityBindingDelete,this),onBindingRelease:BX.delegate(this.onPrimaryEntityBindingRelease,this),container:r,achor:o});this._primaryEntityEditor.layout()}var d=BX.create("div",{props:{className:"crm-entity-widget-participants-container"}});r.appendChild(d);this._secondaryEntityEditor=BX.Crm.SecondaryClientEditor.create(this._id+"_SECONDARY",{entityInfos:this._secondaryEntityInfos.getItems(),entityTypeName:this._secondaryEntityTypeName,entityLegend:this._schemeElement.getDataStringParam("secondaryEntityLegend",""),primaryLoader:a,secondaryLoader:l,mode:this._mode,onAdd:BX.delegate(this.onSecondaryEntityAdd,this),onDelete:BX.delegate(this.onSecondaryEntityDelete,this),onBeforeAdd:BX.delegate(this.onSecondaryEntityBeforeAdd,this),editor:this,container:d});this._secondaryEntityEditor.layout();if(!i){this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorClient.prototype.clearLayout=function(){if(!this._hasLayout){return}this.releaseDragDropAbilities();if(this._primaryEntityEditor){this._primaryEntityEditor.clearLayout();this._primaryEntityEditor=null}this._secondaryEntityEditor.clearLayout();this._secondaryEntityEditor=null;for(var t in this._dataElements){if(this._dataElements.hasOwnProperty(t)){BX.remove(this._dataElements[t])}}this._dataElements=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorClient.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorClient.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorClient.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityTypeName=function(){return this._primaryEntityTypeName};BX.Crm.EntityEditorClient.prototype.setPrimaryEntityTypeName=function(t){if(this._primaryEntityTypeName!==t){this._primaryEntityTypeName=t}};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityId=function(){return this._primaryEntityInfo?this._primaryEntityInfo.getId():0};BX.Crm.EntityEditorClient.prototype.getPrimaryEntity=function(){return this._primaryEntityInfo};BX.Crm.EntityEditorClient.prototype.setPrimaryEntity=function(t){if(t instanceof BX.CrmEntityInfo){this._primaryEntityInfo=t;this.setPrimaryEntityTypeName(t.getTypeName())}else{this._primaryEntityInfo=null}this.markAsChanged()};BX.Crm.EntityEditorClient.prototype.getSecondaryEntityTypeName=function(){return this._secondaryEntityTypeName};BX.Crm.EntityEditorClient.prototype.setSecondaryEntityTypeName=function(t){if(this._secondaryEntityTypeName!==t){this._secondaryEntityTypeName=t}};BX.Crm.EntityEditorClient.prototype.getSecondaryEntities=function(){return this._secondaryEntityInfos.getItems()};BX.Crm.EntityEditorClient.prototype.getSecondaryEntityById=function(t){if(!this._secondaryEntityInfos){return null}return this._secondaryEntityInfos.search(function(e){return e.getId()===t})};BX.Crm.EntityEditorClient.prototype.removeSecondaryEntity=function(t){if(this._secondaryEntityInfos){this._secondaryEntityInfos.remove(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.addSecondaryEntity=function(t){if(this._secondaryEntityInfos){this._secondaryEntityInfos.add(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityDelete=function(t,e){this.removeSecondaryEntity(e);if(this._primaryEntityEditor){this._primaryEntityEditor.adjustLayout()}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityBeforeAdd=function(t,e,i){if(this._primaryEntityEditor&&this._primaryEntityInfo&&this._primaryEntityInfo.getTypeName()===BX.CrmEntityType.names.company){var n=this._primaryEntityInfo.getId();if(e.checkEntityBinding(BX.CrmEntityType.names.company,n)&&!this._bindingTracker.isUnbound(e)){this._primaryEntityEditor.addBinding(this._primaryEntityEditor.createBinding(e));i["cancel"]=true}}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityAdd=function(t,e){this.addSecondaryEntity(e);if(this._primaryEntityEditor){this._primaryEntityEditor.adjustLayout()}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityBind=function(t,e){this._secondaryEntityEditor.removeItem(this._secondaryEntityEditor.getItemById(e.getId()));if(this._primaryEntityEditor){this._primaryEntityEditor.addBinding(this._primaryEntityEditor.createBinding(e))}this._bindingTracker.bind(e)};BX.Crm.EntityEditorClient.prototype.getAllSecondaryEntityIds=function(){var t=this.getAllSecondaryEntityInfos();var e=[];for(var i=0,n=t.length;i<n;i++){e.push(t[i].getId())}return e};BX.Crm.EntityEditorClient.prototype.getAllSecondaryEntityInfos=function(){return[].concat(this._primaryEntityBindingInfos.getItems(),this._secondaryEntityInfos.getItems())};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindings=function(){return this._primaryEntityBindingInfos.getItems()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindingById=function(t){if(!this._primaryEntityBindingInfos){return null}return this._primaryEntityBindingInfos.search(function(e){return e.getId()===t})};BX.Crm.EntityEditorClient.prototype.addPrimaryEntityBinding=function(t){if(this._primaryEntityBindingInfos){this._primaryEntityBindingInfos.add(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.removePrimaryEntityBinding=function(t){if(this._primaryEntityBindingInfos){this._primaryEntityBindingInfos.remove(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingAdd=function(t,e){this.addPrimaryEntityBinding(e)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingDelete=function(t,e){this.removePrimaryEntityBinding(e)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingRelease=function(t,e){this._bindingTracker.unbind(e);this._secondaryEntityEditor.addItem(this._secondaryEntityEditor.createItem(e))};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityDelete=function(t,e){var i=[].concat(this._primaryEntityBindingInfos.getItems(),this._secondaryEntityInfos.getItems());this._secondaryEntityInfos=BX.Collection.create();this._primaryEntityBindingInfos=BX.Collection.create();var n=null;if(i.length>0){n=i.shift()}this.setPrimaryEntity(n);this._primaryEntityEditor.setEntity(n);this._secondaryEntityEditor.setEntities(i)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityChange=function(t,e){this.setPrimaryEntity(e);if(this._primaryEntityTypeName===BX.CrmEntityType.names.company){this._bindingTracker.reset();this._primaryEntityBindingInfos=BX.Collection.create();this._secondaryEntityInfos=BX.Collection.create();this._secondaryEntityEditor.clearItems();this._secondaryEntityEditor.reloadEntities()}};BX.Crm.EntityEditorClient.prototype.save=function(){var t,e,i;var n=this._schemeElement.getDataObjectParam("map",{});if(this._enablePrimaryEntity){this._model.setMappedField(n,"primaryEntityType",this._primaryEntityTypeName);var r=this._primaryEntityInfo?this._primaryEntityInfo.getId():0;this._model.setMappedField(n,"primaryEntityId",r);if(this._primaryEntityInfo){this._info["PRIMARY_ENTITY_DATA"]=this._primaryEntityInfo.getSettings()}else{delete this._info["PRIMARY_ENTITY_DATA"]}if(r>0){var o=this._bindingTracker.getUnboundEntities();var s=[];for(t=0,e=o.length;t<e;t++){s.push(o[t].getId())}if(s.length>0){for(t=0,e=s.length;t<e;t++){i=this.getSecondaryEntityById(s[t]);if(i){i.removeEntityBinding(this._primaryEntityTypeName,r)}}}this._model.setMappedField(n,"unboundSecondaryEntityIds",s.join(","));var a=this._bindingTracker.getBoundEntities();var l=[];for(t=0,e=a.length;t<e;t++){l.push(a[t].getId())}if(l.length>0){for(t=0,e=l.length;t<e;t++){i=this.getPrimaryEntityBindingById(l[t]);if(i){i.addEntityBinding(this._primaryEntityTypeName,r)}}}this._model.setMappedField(n,"boundSecondaryEntityIds",l.join(","));this._bindingTracker.reset()}}this._model.setMappedField(n,"secondaryEntityType",this._secondaryEntityTypeName);var d=this.getAllSecondaryEntityInfos();var h=[];var p=[];for(t=0,e=d.length;t<e;t++){i=d[t];h.push(i.getSettings());p.push(i.getId())}this._model.setMappedField(n,"secondaryEntityIds",p.join(","));this._info["SECONDARY_ENTITY_DATA"]=h};BX.Crm.EntityEditorClient.prototype.onBeforeSubmit=function(){if(!this._dataElements){return}for(var t in this._dataElements){if(!this._dataElements.hasOwnProperty(t)){continue}var e=BX.prop.getString(this._map,t,"");if(e!==""){this._dataElements[t].value=this._model.getField(e,"")}}};BX.Crm.EntityEditorClient.create=function(t,e){var i=new BX.Crm.EntityEditorClient;i.initialize(t,e);return i}}if(typeof BX.Crm.PrimaryClientEditor==="undefined"){BX.Crm.PrimaryClientEditor=function(){this._id="";this._settings={};this._editor=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._entityInfo=null;this._entityTypeName="";this._container=null;this._wrapper=null;this._actionWrapper=null;this._bindingWrapper=null;this._entityTypeSelectButton=null;this._entitySelectButton=null;this._entityBindButton=null;this._entityTypeSelectClickHandler=BX.delegate(this.onEntityTypeSelectClick,this);this._entityTypeSelectHandler=BX.delegate(this.onEntityTypeSelect,this);this._entitySelectClickHandler=BX.delegate(this.onEntitySelectClick,this);this._entityBindClickHandler=BX.delegate(this.onEntityBindClick,this);this._entityBindingSelectHandler=BX.delegate(this.onEntityBindingSelect,this);this._entityCreateButtonHandler=BX.delegate(this.onEntityCreateButtonClick,this);this._externalEventHandler=null;this._externalContext=null;this._entityTypeMenu=null;this._entitySelector=null;this._entityBindSelector=null;this._item=null;this._itemBindings=null;this._skeleton=null;this._loaderConfig=null;this._hasLayout=false};BX.Crm.PrimaryClientEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._mode=BX.prop.getInteger(this._settings,"mode",0);this._container=BX.prop.getElementNode(this._settings,"container",null);this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);if(this._entityInfo){this.setEntity(this._entityInfo)}else{this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","")}this._loaderConfig=BX.prop.getObject(this._settings,"loaderConfig",{})},layout:function(){var t=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-clients-container"}});this._actionWrapper=null;this._bindingWrapper=null;this._entitySelectButton=null;this._entityTypeSelectButton=null;this._entityBindButton=null;if(!t){this._entityTypeSelectButton=BX.create("span",{attrs:{className:"crm-entity-widget-actions-client-type"},text:BX.CrmEntityType.getCaptionByName(this._entityTypeName),events:{click:this._entityTypeSelectClickHandler}});this._entitySelectButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-select"},text:this.getMessage("select"),events:{click:this._entitySelectClickHandler}});this._entityBindButton=BX.create("span",{props:{className:"crm-entity-widget-client-connect-btn"},style:{display:"none"},events:{click:this._entityBindClickHandler},text:this.getMessage("bind")});this._entityCreateButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-create"},text:this.getMessage("create"),events:{click:this._entityCreateButtonHandler}});this._actionWrapper=BX.create("div",{props:{className:"crm-entity-widget-clients-actions-block"},children:[this._entityTypeSelectButton,this._entitySelectButton,this._entityCreateButton,this._entityBindButton]});this._wrapper.appendChild(this._actionWrapper)}this._wrapper.appendChild(BX.create("div",{style:{clear:"both"}}));if(this._item){this._item.setContainer(this._wrapper);this._item.layout();this._bindingWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-block-children"}});this._wrapper.appendChild(this._bindingWrapper);var e=this._editor.getPrimaryEntityBindings();this._itemBindings=[];var i,n;for(i=0,n=e.length;i<n;i++){var r=e[i];var o=BX.Crm.ClientEditorEntityBindingPanel.create(this._id+"_"+r.getId().toString(),{entityInfo:r,editor:this._editor,mode:this._mode,container:this._bindingWrapper,onChange:BX.delegate(this.onItemBindingChange,this)});o.layout();this._itemBindings.push(o)}this.adjustLayout()}var s=BX.prop.getElementNode(this._settings,"achor",null);if(s){this._container.insertBefore(this._wrapper,s)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},clearLayout:function(){if(this._item){this._item.clearLayout()}if(this._itemBindings){for(var t=0,e=this._itemBindings.length;t<e;t++){this._itemBindings[t].clearLayout()}this._itemBindings=null}this._wrapper=BX.remove(this._wrapper);this._actionWrapper=null;this._bindingWrapper=null;this._entitySelectButton=null;this._entityTypeSelectButton=null;this._entityCreateButton=null;this._entityBindButton=null;this._hasLayout=false},adjustLayout:function(){if(this._entityBindButton&&this._entityInfo&&this._entityInfo.getTypeId()===BX.CrmEntityType.enumeration.company){this._entityBindButton.style.display=BX.util.array_diff(this._editor.getSecondaryEntities(),this.getBindingEntities(),BX.CrmEntityInfo.getHashCode).length>0?"":"none"}},getEntityTypeName:function(){return this._entityTypeName},setEntityTypeName:function(t){if(this._entityTypeName===t){return}this._entityTypeName=t;if(this._hasLayout){this._entityTypeSelectButton.innerHTML=BX.util.htmlspecialchars(BX.CrmEntityType.getCaptionByName(this._entityTypeName))}if(this._entitySelector){this._entitySelector=null}},setEntity:function(t){if(this._item){if(this._hasLayout){this._item.clearLayout()}this._item=null}if(!(t instanceof BX.CrmEntityInfo)){this._entityInfo=null}else{this._entityInfo=t;this.setEntityTypeName(this._entityInfo.getTypeName());this._item=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+this._entityInfo.getId().toString(),{editor:this._editor,entityInfo:this._entityInfo,enableEntityTypeCaption:true,enableRequisite:true,requisiteBinding:BX.prop.getObject(this._settings,"requisiteBinding",{}),mode:this._mode,onDelete:BX.delegate(this.onItemDelete,this)});if(this._hasLayout){this._item.setContainer(this._wrapper);this._item.layout()}}if(this._itemBindings){for(var e=0,i=this._itemBindings.length;e<i;e++){this._itemBindings[e].clearLayout()}this._itemBindings=null}},setupEntity:function(t){if(this._entityInfo&&this._entityInfo.getId()===t){return}this.setEntity(null);var e=BX.prop.getFunction(this._settings,"onChange");if(e){e(this,this._entityInfo)}var i=BX.prop.getObject(this._loaderConfig,this._entityTypeName,null);if(i){this.showSkeleton();BX.CrmDataLoader.create(this._id,{serviceUrl:i["url"],action:i["action"],params:{ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:t}}).load(BX.delegate(this.onEntityInfoLoad,this))}},showSkeleton:function(){if(!this._skeleton){this._skeleton=BX.Crm.ClientEditorEntitySkeleton.create(this._id,{container:this._wrapper})}this._skeleton.layout()},hideSkeleton:function(){if(this._skeleton){this._skeleton.clearLayout()}},onEntityTypeSelectClick:function(t){if(this._entityTypeMenu&&this._entityTypeMenu.isOpened()){this._entityTypeMenu.close();return}if(!this._entityTypeMenu){this._entityTypeMenu=BX.CmrSelectorMenu.create(this._id,{items:[{text:BX.CrmEntityType.getCaption(BX.CrmEntityType.enumeration.company),value:BX.CrmEntityType.names.company},{text:BX.CrmEntityType.getCaption(BX.CrmEntityType.enumeration.contact),value:BX.CrmEntityType.names.contact}]});this._entityTypeMenu.addOnSelectListener(this._entityTypeSelectHandler)}if(!this._entityTypeMenu.isOpened()){this._entityTypeMenu.open(this._entityTypeSelectButton)}},onEntityTypeSelect:function(t,e){this.setEntityTypeName(e.getValue());if(this._entityTypeMenu.isOpened()){this._entityTypeMenu.close()}},onEntitySelectClick:function(t){if(this._entitySelector&&this._entitySelector.isOpened()){this._entitySelector.close();return}if(!this._entitySelector){this._entitySelector=BX.Crm.EntityEditorCrmSelector.create(this._id,{entityTypeIds:[BX.CrmEntityType.resolveId(this._entityTypeName)],callback:BX.delegate(this.onEntitySelect,this)})}this._entitySelector.open(this._entitySelectButton)},onEntitySelect:function(t,e){var i=BX.prop.getInteger(e,"entityId",0);if(this._entityInfo&&this._entityInfo.getId()===i){return}this._entitySelector.close();this.setupEntity(i)},onEntityInfoLoad:function(t,e){var i=BX.prop.getObject(e,"DATA",null);if(i){var n=this._hasLayout;if(n){this.clearLayout()}this.hideSkeleton();var r=BX.CrmEntityInfo.create(i);this.setEntity(r);var o=BX.prop.getFunction(this._settings,"onChange");if(o){o(this,this._entityInfo)}if(n){this.layout()}}},onEntityBindClick:function(t){if(this._entityBindSelector&&this._entityBindSelector.isOpened()){this._entityBindSelector.close();return}if(!this._entityBindSelector){this._entityBindSelector=BX.CmrSelectorMenu.create(this._id,{items:[]});this._entityBindSelector.addOnSelectListener(this._entityBindingSelectHandler)}var e=[];var i,n;for(i=0,n=this._itemBindings.length;i<n;i++){e.push(this._itemBindings[i].getEntity())}var r=BX.util.array_diff(this._editor.getSecondaryEntities(),e,BX.CrmEntityInfo.getHashCode);var o=[];for(i=0,n=r.length;i<n;i++){var s=r[i];o.push({text:s.getTitle(),value:s.getId()})}this._entityBindSelector.setupItems(o);this._entityBindSelector.open(this._entityBindButton)},onEntityBindingSelect:function(t,e){this._editor.onSecondaryEntityBind(this,this._editor.getSecondaryEntityById(e.getValue()))},getEntityCreateUrl:function(t){return this._editor.getEntityCreateUrl(t)},onEntityCreateButtonClick:function(){var t=this.getEntityCreateUrl(this.getEntityTypeName());if(t===""){return""}var e=this._editor.getContextId();t=BX.util.add_url_param(t,{external_context_id:e});if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalContext){this._externalContext={}}this._externalContext[e]=t;BX.Crm.Page.open(t)},onExternalEvent:function(t){var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var n=i["entityTypeName"];var r=i["entityId"];var o=i["context"];if(e==="onCrmEntityCreate"&&n===this.getEntityTypeName()&&this._externalContext&&typeof this._externalContext[o]!=="undefined"){this.setupEntity(r);BX.Crm.Page.close(this._externalContext[o]);delete this._externalContext[o]}},onItemBindingChange:function(t,e){if(e==="unbind"){var i=BX.prop.getFunction(this._settings,"onBindingRelease");if(i){i(this,t.getEntity())}this.removeBinding(t)}else if(e==="delete"){this.removeBinding(t)}},onItemDelete:function(t){var e=this._entityInfo;var i=this._hasLayout;if(i){this.clearLayout()}this.setEntity(null);if(i){this.layout()}var n=BX.prop.getFunction(this._settings,"onDelete");if(n){n(this,e)}},createBinding:function(t){return BX.Crm.ClientEditorEntityBindingPanel.create(this._id+"_"+t.getId().toString(),{entityInfo:t,editor:this._editor,mode:this._mode,onChange:BX.delegate(this.onItemBindingChange,this)})},finfBindingById:function(t){for(var e=0,i=this._itemBindings.length;e<i;e++){var n=this._itemBindings[e];if(n.getEntity().getId()===t){return n}}return null},getBindingIndex:function(t){for(var e=0,i=this._itemBindings.length;e<i;e++){if(this._itemBindings[e]===t){return e}}return-1},addBinding:function(t){this._itemBindings.push(t);if(this._hasLayout){t.setContainer(this._bindingWrapper);t.layout()}var e=BX.prop.getFunction(this._settings,"onBindingAdd");if(e){e(this,t.getEntity())}},removeBinding:function(t){var e=this.getBindingIndex(t);if(e<0){return}t.clearLayout();this._itemBindings.splice(e,1);var i=BX.prop.getFunction(this._settings,"onBindingDelete");if(i){i(this,t.getEntity())}},getBindingEntities:function(){var t=[];if(this._itemBindings){for(var e=0,i=this._itemBindings.length;e<i;e++){t.push(this._itemBindings[e].getEntity())}}return t}};BX.Crm.PrimaryClientEditor.prototype.getMessage=function(t){var e=BX.Crm.PrimaryClientEditor.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.PrimaryClientEditor.messages==="undefined"){BX.Crm.PrimaryClientEditor.messages={}}BX.Crm.PrimaryClientEditor.create=function(t,e){var i=new BX.Crm.PrimaryClientEditor;i.initialize(t,e);return i}}if(typeof BX.Crm.SecondaryClientEditor==="undefined"){BX.Crm.SecondaryClientEditor=function(){this._id="";this._settings={};this._mode=BX.Crm.EntityEditorMode.intermediate;this._container=null;this._wrapper=null;this._entityTypeName="";this._entityInfos=null;this._items=null;this._entitySelectClickHandler=BX.delegate(this.onEntitySelectClick,this);this._entitySelectButton=null;this._entitySelector=null;this._entityCreateButtonHandler=BX.delegate(this.onEntityCreateButtonClick,this);this._entityCreateButton=null;this._externalEventHandler=null;this._externalContext=null;this._isMultiple=true;this._primaryLoaderConfig=null;this._secondaryLoaderConfig=null;this._editor=null;this._hasLayout=false};BX.Crm.SecondaryClientEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._mode=BX.prop.getInteger(this._settings,"mode",0);this._editor=BX.prop.get(this._settings,"editor",null);this._container=BX.prop.getElementNode(this._settings,"container",null);this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","");this._entityInfos=BX.prop.getArray(this._settings,"entityInfos","");this._isMultiple=BX.prop.getBoolean(this._settings,"isMultiple",true);this._items=[];var i=this._entityInfos.length;if(!this._isMultiple&&i>1){i=1}for(var n=0;n<i;n++){var r=this.createItem(this._entityInfos[n]);this._items.push(r)}this._primaryLoaderConfig=BX.prop.getObject(this._settings,"primaryLoader",{});this._secondaryLoaderConfig=BX.prop.getObject(this._settings,"secondaryLoader",{})},getEntityTypeName:function(){return this._entityTypeName},getEntities:function(){return this._entityInfos},setEntities:function(t){this._entityInfos=t;this.clearItems();var e=this._entityInfos.length;if(!this._isMultiple&&e>1){e=1}for(var i=0;i<e;i++){this.addItem(this.createItem(this._entityInfos[i]))}},findItemIndex:function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1},getFirstItem:function(){return this._items.length>0?this._items[0]:null},getItemById:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getEntity().getId()===t){return n}}return null},getItems:function(){return this._items},getItemCount:function(){return this._items.length},createItem:function(t){return BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+t.getId().toString(),{editor:this._editor,entityInfo:t,mode:this._mode,onDelete:BX.delegate(this.onItemDelete,this)})},clearItems:function(){for(var t=0,e=this._items.length;t<e;t++){var i=this._items[t];i.clearLayout();i.setContainer(null)}this._items=[]},addItemById:function(t){var e=BX.prop.getObject(this._primaryLoaderConfig,this._entityTypeName,null);if(!e){return}BX.CrmDataLoader.create(this._id,{serviceUrl:e["url"],action:e["action"],params:{ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:t}}).load(BX.delegate(this.onEntityInfoLoad,this))},addItem:function(t){var e=BX.prop.getFunction(this._settings,"onBeforeAdd");if(e){var i={cancel:false};e(this,t.getEntity(),i);if(i["cancel"]){return false}}if(!this._isMultiple){this.clearItems()}this._items.push(t);if(this._hasLayout){t.setContainer(this._wrapper);t.layout()}var n=BX.prop.getFunction(this._settings,"onAdd");if(n){n(this,t.getEntity())}return true},removeItem:function(t){var e=this.findItemIndex(t);if(e<0){return}this._items.splice(e,1);if(this._hasLayout){t.clearLayout();t.setContainer(null)}var i=BX.prop.getFunction(this._settings,"onDelete");if(i){i(this,t.getEntity())}},reloadEntities:function(){if(!this._editor){return}var t=this._editor.getPrimaryEntity();if(!t){return}var e=BX.prop.getObject(this._secondaryLoaderConfig,t.getTypeName(),null);if(e){BX.CrmDataLoader.create(this._id,{serviceUrl:e["url"],action:e["action"],params:{PRIMARY_TYPE_NAME:t.getTypeName(),PRIMARY_ID:t.getId(),SECONDARY_TYPE_NAME:this._entityTypeName,OWNER_TYPE_NAME:this._editor.getOwnerTypeName()}}).load(BX.delegate(this.onEntityInfosReload,this))}},layout:function(){var t=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{});this._container.appendChild(this._wrapper);var e=BX.prop.getString(this._settings,"entityLegend","");this._entitySelectButton=null;if(t){this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},text:e}))}else{this._entitySelectButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-select"},text:this.getMessage("select"),events:{click:this._entitySelectClickHandler}});this._entityCreateButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-create"},text:this.getMessage("create"),events:{click:this._entityCreateButtonHandler}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-participants-title"},children:[BX.create("div",{props:{className:"crm-entity-widget-clients-actions-block"},children:[BX.create("span",{props:{className:"crm-entity-widget-actions-btn-participants"},children:[BX.create("span",{props:{className:"crm-entity-widget-participants-title-text"},text:e})]}),this._entitySelectButton,this._entityCreateButton]})]}))}for(var i=0,n=this._items.length;i<n;i++){this._items[i].setContainer(this._wrapper);this._items[i].layout()}this._hasLayout=true},clearLayout:function(){for(var t=0,e=this._items.length;t<e;t++){this._items[t].clearLayout();this._items[t].setContainer(null)}this._entitySelectButton=null;this._entityCreateButton=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},onEntitySelectClick:function(t){this.openEntitySelector()},openEntitySelector:function(){if(!this._entitySelector){this._entitySelector=BX.Crm.EntityEditorCrmSelector.create(this._id,{entityTypeIds:[BX.CrmEntityType.resolveId(this._entityTypeName)],callback:BX.delegate(this.onEntitySelect,this)})}this._entitySelector.open(this._entitySelectButton)},onEntitySelect:function(t,e){var i=BX.prop.getInteger(e,"entityId",0);this._entitySelector.close();this.addItemById(i)},onEntityInfoLoad:function(t,e){var i=BX.prop.getObject(e,"DATA",null);if(!i){return}var n=BX.CrmEntityInfo.create(i);if(this.getItemById(n.getId())!==null){return}this.addItem(this.createItem(n))},onEntityInfosReload:function(t,e){var i=BX.type.isArray(e["ENTITY_INFOS"])?e["ENTITY_INFOS"]:[];var n=[];for(var r=0;r<i.length;r++){n.push(BX.CrmEntityInfo.create(i[r]))}this.setEntities(n)},onItemDelete:function(t){this.removeItem(t)},getEntityCreateUrl:function(t){return this._editor.getEntityCreateUrl(t)},onEntityCreateButtonClick:function(){var t=this.getEntityCreateUrl(this.getEntityTypeName());if(t===""){return""}var e=this._editor.getContextId();t=BX.util.add_url_param(t,{external_context_id:e});if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalContext){this._externalContext={}}this._externalContext[e]=t;BX.Crm.Page.open(t)},onExternalEvent:function(t){if(!this._externalContext){return}var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";if(e!=="onCrmEntityCreate"){return}var i=BX.prop.getObject(t,"value",{});if(BX.prop.getString(i,"entityTypeName","")!==this.getEntityTypeName()){return}var n=BX.prop.getInteger(i,"entityId",0);var r=BX.prop.getString(i,"context","");if(typeof this._externalContext[r]!=="undefined"){this.addItemById(n);BX.Crm.Page.close(this._externalContext[r]);delete this._externalContext[r]}}};BX.Crm.SecondaryClientEditor.prototype.getMessage=function(t){var e=BX.Crm.SecondaryClientEditor.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.SecondaryClientEditor.messages==="undefined"){BX.Crm.SecondaryClientEditor.messages={}}BX.Crm.SecondaryClientEditor.create=function(t,e){var i=new BX.Crm.SecondaryClientEditor;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorFieldConfigurator==="undefined"){BX.Crm.EntityEditorFieldConfigurator=function(){BX.Crm.EntityEditorFieldConfigurator.superclass.constructor.apply(this);this._field=null;this._name=null;this._isLocked=false;this._labelInput=null;this._saveButton=null;this._cancelButton=null};BX.extend(BX.Crm.EntityEditorFieldConfigurator,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorFieldConfigurator.prototype.doInitialize=function(){BX.Crm.EntityEditorFieldConfigurator.superclass.doInitialize.apply(this);this._field=BX.prop.get(this._settings,"field",null);this._name=BX.prop.getString(this._fieldData,"name","")};BX.Crm.EntityEditorFieldConfigurator.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorFieldConfigurator.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorFieldConfigurator.prototype.layout=function(t){if(this._hasLayout){return}if(this._mode===BX.Crm.EntityEditorMode.view){throw"EntityEditorFieldConfigurator. View mode is not supported by this control type."}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields"}});this._labelInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:this._field.getTitle()}});this._saveButton=BX.create("span",{props:{className:"webform-small-button webform-small-button-blue"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}});this._cancelButton=BX.create("span",{props:{className:"webform-small-button webform-small-button-transparent"},text:BX.message("CRM_EDITOR_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},text:this.getMessage("labelField")}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._labelInput]})]}));this._wrapper.appendChild(BX.create("div",{children:[this._saveButton,this._cancelButton]}));this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorFieldConfigurator.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._labelInput=null;this._saveButton=null;this._cancelButton=null;this._hasLayout=false};BX.Crm.EntityEditorFieldConfigurator.prototype.onSaveButtonClick=function(t){if(this._isLocked){return}var e={field:this._field,label:this._labelInput.value};BX.onCustomEvent(this,"onSave",[this,e])};BX.Crm.EntityEditorFieldConfigurator.prototype.onCancelButtonClick=function(t){if(this._isLocked){return}var e={field:this._field};BX.onCustomEvent(this,"onCancel",[this,e])};BX.Crm.EntityEditorFieldConfigurator.prototype.setLocked=function(t){t=!!t;if(this._isLocked===t){return}this._isLocked=t;if(this._isLocked){BX.addClass(this._saveButton,"webform-small-button-wait")}else{BX.removeClass(this._saveButton,"webform-small-button-wait")}};BX.Crm.EntityEditorFieldConfigurator.prototype.getField=function(){return this._field};if(typeof BX.Crm.EntityEditorFieldConfigurator.messages==="undefined"){BX.Crm.EntityEditorFieldConfigurator.messages={}}BX.Crm.EntityEditorFieldConfigurator.create=function(t,e){var i=new BX.Crm.EntityEditorFieldConfigurator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserFieldConfigurator==="undefined"){BX.Crm.EntityEditorUserFieldConfigurator=function(){BX.Crm.EntityEditorUserFieldConfigurator.superclass.constructor.apply(this);this._field=null;this._typeId="";this._isLocked=false;this._labelInput=null;this._saveButton=null;this._cancelButton=null;this._isTimeEnabledCheckBox=null;this._isRequiredCheckBox=null;this._isMultipleCheckBox=null;this._enumItemWrapper=null;this._enumButtonWrapper=null;this._enumItems=null};BX.extend(BX.Crm.EntityEditorUserFieldConfigurator,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorUserFieldConfigurator.prototype.doInitialize=function(){BX.Crm.EntityEditorUserFieldConfigurator.superclass.doInitialize.apply(this);this._field=BX.prop.get(this._settings,"field",null);if(this._field&&!(this._field instanceof BX.Crm.EntityEditorUserField)){throw"EntityEditorUserFieldConfigurator. The 'field' param must be EntityEditorUserField."}this._typeId=BX.prop.getString(this._settings,"typeId","");this._enumItems=[]};BX.Crm.EntityEditorUserFieldConfigurator.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorUserFieldConfigurator.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorUserFieldConfigurator.prototype.layout=function(t){if(this._hasLayout){return}if(this._mode===BX.Crm.EntityEditorMode.view){throw"EntityEditorUserFieldConfigurator. View mode is not supported by this control type."}var e=this._field===null;var i=this.getMessage("labelField");var n=this._editor.getUserFieldManager();var r=this._field?this._field.getTitle():n.getDefaultFieldLabel(this._typeId);this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields"}});this._labelInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:r}});this._saveButton=BX.create("span",{props:{className:"webform-small-button webform-small-button-blue"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}});this._cancelButton=BX.create("span",{props:{className:"webform-small-button webform-small-button-transparent"},text:BX.message("CRM_EDITOR_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},text:i}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._labelInput]})]}));if(this._typeId==="enumeration"){this._wrapper.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this._enumItemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});this._wrapper.appendChild(this._enumItemWrapper);this._enumItemWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},text:this.getMessage("enumItems")}));this._enumButtonWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-add-field"}});this._enumItemWrapper.appendChild(this._enumButtonWrapper);this._enumButtonWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-widget-content-add-field"},events:{click:BX.delegate(this.onEnumerationItemAddButtonClick,this)},text:this.getMessage("add")}));if(this._field){var o=this._field.getFieldInfo();var s=BX.prop.getArray(o,"ENUM",[]);for(var a=0,l=s.length;a<l;a++){this.createEnumerationItem(s[a])}}this.createEnumerationItem()}var d=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-checkbox"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[d]}));var h=0;if(e&&(this._typeId==="datetime"||this._typeId==="date")){this._isTimeEnabledCheckBox=BX.create("input",{props:{type:"checkbox"}});d.appendChild(BX.create("label",{children:[this._isTimeEnabledCheckBox,BX.create("span",{text:this.getMessage("enableTime")})]}));h++}if(this._typeId!=="boolean"){this._isRequiredCheckBox=BX.create("input",{props:{type:"checkbox",checked:this._field&&this._field.isRequired()}});this._isMultipleCheckBox=BX.create("input",{props:{type:"checkbox"}});if(h>0){d.appendChild(BX.create("br"))}d.appendChild(BX.create("label",{children:[this._isRequiredCheckBox,BX.create("span",{text:this.getMessage("isRequiredField")})]}));h++;if(e){d.appendChild(BX.create("br"));d.appendChild(BX.create("label",{children:[this._isMultipleCheckBox,BX.create("span",{text:this.getMessage("isMultipleField")})]}));h++}}if(h>0){this._wrapper.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}))}this._wrapper.appendChild(BX.create("div",{children:[this._saveButton,this._cancelButton]}));this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorUserFieldConfigurator.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._labelInput=null;this._saveButton=null;this._cancelButton=null;this._isTimeEnabledCheckBox=null;this._isRequiredCheckBox=null;this._isMultipleCheckBox=null;this._enumItemWrapper=null;this._enumButtonWrapper=null;this._enumItems=[];this._hasLayout=false};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onEnumerationItemAddButtonClick=function(t){this.createEnumerationItem().focus()};BX.Crm.EntityEditorUserFieldConfigurator.prototype.createEnumerationItem=function(t){var e=BX.Crm.EntityEditorUserFieldListItem.create("",{configurator:this,container:this._enumItemWrapper,anchor:this._enumButtonWrapper,data:t});this._enumItems.push(e);e.layout();return e};BX.Crm.EntityEditorUserFieldConfigurator.prototype.removeEnumerationItem=function(t){for(var e=0,i=this._enumItems.length;e<i;e++){if(this._enumItems[e]===t){this._enumItems[e].clearLayout();this._enumItems.splice(e,1);break}}};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onSaveButtonClick=function(t){if(this._isLocked){return}var e={typeId:this._typeId,label:this._labelInput.value};if(this._field){e["field"]=this._field;if(this._typeId!=="boolean"){e["mandatory"]=this._isRequiredCheckBox.checked}}else{if(this._typeId==="boolean"){e["multiple"]=false}else{e["multiple"]=this._isMultipleCheckBox.checked;e["mandatory"]=this._isRequiredCheckBox.checked}if(this._typeId==="datetime"){e["enableTime"]=this._isTimeEnabledCheckBox.checked}}if(this._typeId==="enumeration"){e["enumeration"]=[];var i=[];for(var n=0,r=this._enumItems.length;n<r;n++){var o=this._enumItems[n].prepareData();if(!o){continue}var s=BX.util.hashCode(o["VALUE"]);if(BX.util.in_array(s,i)){continue}i.push(s);o["SORT"]=(e["enumeration"].length+1)*100;e["enumeration"].push(o)}}BX.onCustomEvent(this,"onSave",[this,e])};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onCancelButtonClick=function(t){if(this._isLocked){return}var e={typeId:this._typeId};if(this._field){e["field"]=this._field}BX.onCustomEvent(this,"onCancel",[this,e])};BX.Crm.EntityEditorUserFieldConfigurator.prototype.setLocked=function(t){t=!!t;if(this._isLocked===t){return}this._isLocked=t;if(this._isLocked){BX.addClass(this._saveButton,"webform-small-button-wait")}else{BX.removeClass(this._saveButton,"webform-small-button-wait")}};BX.Crm.EntityEditorUserFieldConfigurator.prototype.getField=function(){return this._field};if(typeof BX.Crm.EntityEditorUserFieldConfigurator.messages==="undefined"){BX.Crm.EntityEditorUserFieldConfigurator.messages={}}BX.Crm.EntityEditorUserFieldConfigurator.create=function(t,e){var i=new BX.Crm.EntityEditorUserFieldConfigurator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserFieldListItem==="undefined"){BX.Crm.EntityEditorUserFieldListItem=function(){this._id="";this._settings=null;this._data=null;this._configurator=null;this._container=null;this._labelInput=null;this._hasLayout=false};BX.Crm.EntityEditorUserFieldListItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=BX.type.isPlainObject(e)?e:{};this._data=BX.prop.getObject(this._settings,"data",{});this._configurator=BX.prop.get(this._settings,"configurator");this._container=BX.prop.getElementNode(this._settings,"container")},layout:function(){if(this._hasLayout){return}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._labelInput=BX.create("input",{props:{className:"crm-entity-widget-content-input",type:"input",value:BX.prop.getString(this._data,"VALUE","")}});this._wrapper.appendChild(this._labelInput);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-remove-block"},events:{click:BX.delegate(this.onDeleteButtonClick,this)}}));var t=BX.prop.getElementNode(this._settings,"anchor");if(t){this._container.insertBefore(this._wrapper,t)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},focus:function(){if(this._labelInput){this._labelInput.focus()}},prepareData:function(){var t=this._labelInput?BX.util.trim(this._labelInput.value):"";if(t===""){return null}var e={VALUE:t};var i=BX.prop.getInteger(this._data,"ID",0);if(i>0){e["ID"]=i}var n=BX.prop.getString(this._data,"XML_ID","");if(i>0){e["XML_ID"]=n}return e},onDeleteButtonClick:function(t){this._configurator.removeEnumerationItem(this)}};BX.Crm.EntityEditorUserFieldListItem.create=function(t,e){var i=new BX.Crm.EntityEditorUserFieldListItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserField==="undefined"){BX.Crm.EntityEditorUserField=function(){BX.Crm.EntityEditorUserField.superclass.constructor.apply(this);this._loader=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorUserField,BX.Crm.EntityEditorField);BX.Crm.EntityEditorUserField.prototype.doInitialize=function(){BX.Crm.EntityEditorUserField.superclass.doInitialize.apply(this);this._manager=this._editor.getUserFieldManager()};BX.Crm.EntityEditorUserField.prototype.getFieldInfo=function(){return this._schemeElement.getDataParam("fieldInfo",{})};BX.Crm.EntityEditorUserField.prototype.getFieldType=function(){return BX.prop.getString(this.getFieldInfo(),"USER_TYPE_ID","")};BX.Crm.EntityEditorUserField.prototype.getFieldSettings=function(){return BX.prop.getObject(this.getFieldInfo(),"SETTINGS",{})};BX.Crm.EntityEditorUserField.prototype.isMultiple=function(){return BX.prop.getString(this.getFieldInfo(),"MULTIPLE","N")==="Y"};BX.Crm.EntityEditorUserField.prototype.getEntityValueId=function(){return BX.prop.getString(this.getFieldInfo(),"ENTITY_VALUE_ID","")};BX.Crm.EntityEditorUserField.prototype.getFieldValue=function(){var t=this.getValue();var e=BX.prop.getArray(t,"VALUE",null);if(e===null){e=BX.prop.getString(t,"VALUE","")}return e};BX.Crm.EntityEditorUserField.prototype.getFieldSignature=function(){return BX.prop.getString(this.getValue(),"SIGNATURE","")};BX.Crm.EntityEditorUserField.prototype.isTitleEnabled=function(){var t=this.getFieldInfo();var e=BX.prop.getString(t,"USER_TYPE_ID","");if(e!=="boolean"){return true}return BX.prop.getString(BX.prop.getObject(t,"SETTINGS",{}),"DISPLAY","")!=="CHECKBOX"};BX.Crm.EntityEditorUserField.prototype.getFieldNode=function(){return this._innerWrapper};BX.Crm.EntityEditorUserField.prototype.checkIfNotEmpty=function(t){var e=BX.prop.getArray(t,"VALUE",null);if(e===null){e=BX.prop.getString(t,"VALUE","")}return BX.type.isArray(e)?e.length>0:e!==""};BX.Crm.EntityEditorUserField.prototype.getValue=function(t){if(t===undefined){t=null}if(!this._model){return t}return this._model.getField(this.getName(),t)};BX.Crm.EntityEditorUserField.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this.getTitle();var n=this.getFieldInfo();var r=this.getValue();var o=BX.prop.getArray(r,"VALUE",null);if(o===null){o=BX.prop.getString(r,"VALUE","")}var s=this.checkIfNotEmpty(r);var a=BX.prop.getString(r,"SIGNATURE","");if(this._wrapper){this._wrapper=BX.cleanNode(this._wrapper)}else{this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}})}var l=this.getFieldType();if(l===BX.Crm.EntityUserFieldType.string){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-text")}else if(l===BX.Crm.EntityUserFieldType.integer||l===BX.Crm.EntityUserFieldType.double){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-number")}else if(l===BX.Crm.EntityUserFieldType.money){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-money")}else if(l===BX.Crm.EntityUserFieldType.date||l===BX.Crm.EntityUserFieldType.datetime){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-date")}else if(l===BX.Crm.EntityUserFieldType.boolean){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-checkbox");s=o!==""&&o!=="0"}else if(l===BX.Crm.EntityUserFieldType.enumeration){BX.addClass(this._wrapper,this.isMultiple()?"crm-entity-widget-content-block-field-custom-multiselect":"crm-entity-widget-content-block-field-custom-select")}else if(l===BX.Crm.EntityUserFieldType.file){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-file")}else if(l===BX.Crm.EntityUserFieldType.url){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-link")}this._innerWrapper=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createDragButton());if(this.isTitleEnabled()){this._wrapper.appendChild(this.createTitleNode(i))}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}else if(this._mode===BX.Crm.EntityEditorMode.view&&s){this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper)}this.registerLayout(t);if(this._innerWrapper){var d=BX.prop.getString(t,"html","");if(d!==""){this.setupContentHtml(d)}else{var h=this._loader;if(!h){h=BX.prop.get(t,"userFieldLoader",null);if(!h){h=BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:this._mode,enableBatchMode:false})}}var p=BX.clone(n);p["SIGNATURE"]=a;if(s){p["VALUE"]=o}this.adjustFieldParams(p);h.addItem({name:e,field:p,callback:BX.delegate(this.onLayoutLoaded,this)});h.run()}}this._hasLayout=true};BX.Crm.EntityEditorUserField.prototype.adjustFieldParams=function(t){var e=this.getFieldType();if(e===BX.Crm.EntityUserFieldType.boolean){if(!BX.type.isPlainObject(t["SETTINGS"])){t["SETTINGS"]={}}t["SETTINGS"]["LABEL_CHECKBOX"]=this.getTitle()}if(typeof t["VALUE"]!=="undefined"&&this._mode===BX.Crm.EntityEditorMode.edit&&BX.prop.getInteger(t,"ENTITY_VALUE_ID")<=0){if(this._mode===BX.Crm.EntityEditorMode.edit&&BX.prop.getInteger(t,"ENTITY_VALUE_ID")<=0){t["ENTITY_VALUE_ID"]=1}}};BX.Crm.EntityEditorUserField.prototype.doClearLayout=function(t){this._innerWrapper=null};BX.Crm.EntityEditorUserField.prototype.validate=function(){return true};BX.Crm.EntityEditorUserField.prototype.save=function(){};BX.Crm.EntityEditorUserField.prototype.focus=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){this.scrollAnimate();BX.Main.UF.Factory.focus(this.getName())}};BX.Crm.EntityEditorUserField.prototype.setLayoutLoader=function(t){this._loader=t};BX.Crm.EntityEditorUserField.prototype.getLayoutLoader=function(){return this._loader};BX.Crm.EntityEditorUserField.prototype.setupContentHtml=function(t){if(this._innerWrapper){BX.html(this._innerWrapper,t).then(BX.delegate(this.onLayoutSuccess,this))}};BX.Crm.EntityEditorUserField.prototype.doSetActive=function(){if(!this._isActive){this._manager.unregisterActiveField(this)}};BX.Crm.EntityEditorUserField.prototype.rollback=function(){this._manager.unregisterActiveField(this)};BX.Crm.EntityEditorUserField.prototype.onLayoutSuccess=function(){if(this._isActive){this._manager.registerActiveField(this)}BX.bindDelegate(this._innerWrapper,"bxchange",{tag:["input","select","textarea"]},this._changeHandler);if(!this._hasLayout){this._hasLayout=true}};BX.Crm.EntityEditorUserField.prototype.onLayoutLoaded=function(t){var e=BX.prop.getString(t,"HTML","");if(e!==""){this.setupContentHtml(e)}};BX.Crm.EntityEditorUserField.create=function(t,e){var i=new BX.Crm.EntityEditorUserField;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorProductRowSummary==="undefined"){BX.Crm.EntityEditorProductRowSummary=function(){BX.Crm.EntityEditorProductRowSummary.superclass.constructor.apply(this);this._loader=null;this._table=null;this._itemCount=0;this._totalCount=0;this._moreButton=null;this._moreButtonRow=null;this._moreButtonClickHandler=BX.delegate(this._onMoreButtonClick,this)};BX.extend(BX.Crm.EntityEditorProductRowSummary,BX.Crm.EntityEditorField);BX.Crm.EntityEditorProductRowSummary.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorProductRowSummary.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorProductRowSummary.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getValue();if(!BX.type.isPlainObject(e)){return}var i=BX.prop.getArray(e,"items",[]);this._totalCount=BX.prop.getInteger(e,"count",0);this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});this._table=BX.create("table",{props:{className:"crm-entity-widget-content-block-products-list"}});var n=this._itemCount=i.length;var r=0;if(n>5){r=this._totalCount-5;n=5}for(var o=0;o<n;o++){this.addProductRow(i[o],-1)}var s,a;this._moreButton=null;if(r>0){s=this._moreButtonRow=this._table.insertRow(-1);s.className="crm-entity-widget-content-block-products-item";a=s.insertCell(-1);a.className="crm-entity-widget-content-block-products-item-name";this._moreButton=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-products-show-more"},events:{click:this._moreButtonClickHandler},text:this.getMessage("notShown").replace(/#COUNT#/gi,r.toString())});a.appendChild(this._moreButton);a=s.insertCell(-1);a.className="crm-entity-widget-content-block-products-price"}s=this._table.insertRow(-1);s.className="crm-entity-widget-content-block-products-item";a=s.insertCell(-1);a.className="crm-entity-widget-content-block-products-item-name";a.innerHTML=this.getMessage("total");a=s.insertCell(-1);a.className="crm-entity-widget-content-block-products-price";a.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-products-price-value"},html:e["total"]}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-products"},children:[this._table]}));this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorProductRowSummary.prototype._onMoreButtonClick=function(t){if(this._totalCount>10){BX.onCustomEvent(window,"OpenEntityDetailTab",["tab_products"]);return}this._moreButtonRow.style.display="none";var e=this.getValue();var i=BX.prop.getArray(e,"items",[]);for(var n=5;n<this._itemCount;n++){this.addProductRow(i[n],n)}};BX.Crm.EntityEditorProductRowSummary.prototype.clearLayout=function(){if(!this._hasLayout){return}this._table=null;this._moreButton=null;this._moreButtonRow=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorProductRowSummary.prototype.addProductRow=function(t,e){if(typeof e==="undefined"){e=-1}var i,n;i=this._table.insertRow(e);i.className="crm-entity-widget-content-block-products-item";n=i.insertCell(-1);n.className="crm-entity-widget-content-block-products-item-name";var r=BX.prop.getString(t,"URL","");if(r!==""){n.appendChild(BX.create("a",{attrs:{target:"_blank",href:r},text:t["PRODUCT_NAME"]}))}else{n.innerHTML=BX.util.htmlspecialchars(t["PRODUCT_NAME"])}n=i.insertCell(-1);n.className="crm-entity-widget-content-block-products-price";n.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-products-price-value"},html:t["SUM"]}))};if(typeof BX.Crm.EntityEditorProductRowSummary.messages==="undefined"){BX.Crm.EntityEditorProductRowSummary.messages={}}BX.Crm.EntityEditorProductRowSummary.create=function(t,e){var i=new BX.Crm.EntityEditorProductRowSummary;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteSelector==="undefined"){BX.Crm.EntityEditorRequisiteSelector=function(){BX.Crm.EntityEditorRequisiteSelector.superclass.constructor.apply(this);this._requisiteId=0;this._bankDetailId=0;this._itemWrappers={};this._itemButtons={};this._itemBankDetailButtons={}};BX.extend(BX.Crm.EntityEditorRequisiteSelector,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRequisiteSelector.prototype.doInitialize=function(){this._requisiteId=this._model.getIntegerField("REQUISITE_ID",0);this._bankDetailId=this._model.getIntegerField("BANK_DETAIL_ID",0)};BX.Crm.EntityEditorRequisiteSelector.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRequisiteSelector.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRequisiteSelector.prototype.getPrefix=function(){return this._id.toLowerCase()+"_"};BX.Crm.EntityEditorRequisiteSelector.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getData();this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:this._requisiteId,bankDetailId:this._bankDetailId,data:BX.prop.getArray(e,"data",{})});var i=this._requisiteInfo.getItems();this._wrapper=BX.create("div",{props:{className:"crm-entity-requisites-slider-wrapper"}});var n=BX.create("div",{props:{className:"crm-entity-requisites-slider-content"}});this._wrapper.appendChild(n);var r=BX.create("div",{props:{className:"crm-entity-requisites-slider-widget-content"}});n.appendChild(r);var o=BX.create("div",{props:{className:"crm-entity-requisites-select-container"}});r.appendChild(o);for(var s=0,a=i.length;s<a;s++){o.appendChild(this.prepareItemLayout(i[s]))}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRequisiteSelector.prototype.getItemData=function(t){var e=this._requisiteInfo.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(t===BX.prop.getInteger(r,"requisiteId",0)){return r}}return null};BX.Crm.EntityEditorRequisiteSelector.prototype.prepareItemLayout=function(t){var e=BX.prop.getObject(t,"viewData",null);if(!e){return}var i=BX.prop.getBoolean(t,"selected",false);var n=this.getPrefix();var r=BX.prop.getInteger(t,"requisiteId",0);var o=BX.create("label",{props:{className:"crm-entity-requisites-select-item"}});o.appendChild(BX.create("strong",{text:BX.prop.getString(e,"title","")}));if(i){BX.addClass(o,"crm-entity-requisites-select-item-selected")}this._itemWrappers[r]=o;var s,a;var l=BX.prop.getArray(e,"fields",[]);for(s=0,a=l.length;s<a;s++){var d=l[s];var h=BX.prop.getString(d,"title","");var p=BX.prop.getString(d,"textValue","");if(h!==""&&p!==""){o.appendChild(BX.create("br"));o.appendChild(BX.create("span",{text:h+": "+p}))}}var c=BX.create("input",{props:{type:"radio",name:n+"requisite",checked:i,className:"crm-entity-requisites-select-item-field"},attrs:{"data-requisiteid":r}});o.appendChild(c);this._itemButtons[r]=c;BX.bind(c,"change",BX.delegate(this.onItemChange,this));var u=BX.prop.getArray(t,"bankDetailViewDataList",[]);if(u.length>0){var m=BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-container"}});o.appendChild(m);m.appendChild(BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-title"},html:this.getMessage("bankDetails")}));var g=BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-field-container"}});m.appendChild(g);this._itemBankDetailButtons[r]={};for(s=0,a=u.length;s<a;s++){var y=u[s];var _=BX.prop.getInteger(y,"pseudoId",0);var f=BX.prop.getObject(y,"viewData",null);if(!f){continue}var E=i&&BX.prop.getBoolean(y,"selected",false);var B=BX.create("label",{props:{className:"crm-entity-requisites-select-item-bank-requisites-field-item"}});g.appendChild(B);var C=BX.create("input",{props:{type:"radio",name:n+"bankrequisite"+r,checked:E,className:"crm-entity-requisites-select-item-bank-requisites-field"},attrs:{"data-requisiteid":r,"data-bankdetailid":_}});B.appendChild(C);BX.bind(C,"change",BX.delegate(this.onItemBankDetailChange,this));this._itemBankDetailButtons[r][_]=C;B.appendChild(document.createTextNode(BX.prop.getString(f,"title","")))}o.appendChild(BX.create("span",{style:{display:"block",clear:"both"}}))}return o};BX.Crm.EntityEditorRequisiteSelector.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._itemWrappers={};this._itemButtons={};this._itemBankDetailButtons={};this._hasLayout=false};BX.Crm.EntityEditorRequisiteSelector.prototype.save=function(){this._model.setField("REQUISITE_ID",this._requisiteId,{originator:this});this._model.setField("BANK_DETAIL_ID",this._bankDetailId,{originator:this})};BX.Crm.EntityEditorRequisiteSelector.prototype.onItemChange=function(t){var e=BX.getEventTarget(t);if(!e.checked){return}var i=parseInt(e.getAttribute("data-requisiteid"));if(isNaN(i)||i<=0){return}this._requisiteId=i;this._bankDetailId=0;var n=this.getItemData(this._requisiteId);var r=BX.prop.getArray(n,"bankDetailViewDataList",[]);for(var o=0,s=r.length;o<s;o++){var a=r[o];var l=BX.prop.getInteger(a,"pseudoId",0);if(l>0&&BX.prop.getBoolean(a,"selected",false)){this._bankDetailId=l;break}}for(var d in this._itemWrappers){if(!this._itemWrappers.hasOwnProperty(d)){continue}var h=this._itemWrappers[d];var p=this._requisiteId===parseInt(d);if(p){BX.addClass(h,"crm-entity-requisites-select-item-selected")}else{BX.removeClass(h,"crm-entity-requisites-select-item-selected")}if(this._itemButtons.hasOwnProperty(d)){var c=this._itemButtons[d];if(c.checked!==p){c.checked=p}}if(this._itemBankDetailButtons.hasOwnProperty(d)){var u=this._itemBankDetailButtons[d];for(var m in u){if(!u.hasOwnProperty(m)){continue}var g=p&&this._bankDetailId===parseInt(m);var y=u[m];if(y.checked!==g){y.checked=g}}}}};BX.Crm.EntityEditorRequisiteSelector.prototype.onItemBankDetailChange=function(t){var e=BX.getEventTarget(t);if(!e.checked){return}var i=parseInt(e.getAttribute("data-requisiteid"));if(isNaN(i)||i<=0){return}if(this._requisiteId!==i){return}var n=parseInt(e.getAttribute("data-bankdetailid"));if(isNaN(n)||n<=0){return}this._bankDetailId=n};if(typeof BX.Crm.EntityEditorRequisiteSelector.messages==="undefined"){BX.Crm.EntityEditorRequisiteSelector.messages={}}BX.Crm.EntityEditorRequisiteSelector.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteSelector;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteListItem==="undefined"){BX.Crm.EntityEditorRequisiteListItem=function(){this._id="";this._settings=null;this._owner=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._data=null;this._requisiteId=0;this._container=null;this._wrapper=null;this._innerWrapper=null;this._editButton=null;this._deleteButton=null;this._hasLayout=false};BX.Crm.EntityEditorRequisiteListItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=BX.type.isPlainObject(e)?e:{};this._owner=BX.prop.get(this._settings,"owner",null);this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.intermediate);this._data=BX.prop.getObject(this._settings,"data",{});this._requisiteId=BX.prop.getInteger(this._data,"requisiteId",0);this._container=BX.prop.getElementNode(this._settings,"container")},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityEditorRequisiteListItem.messages,t,t)},getRequisiteId:function(){return this._requisiteId},getData:function(){return this._data},setData:function(t){this._data=t},layout:function(t){if(this._hasLayout){return}var e=BX.prop.getObject(this._data,"viewData",null);if(!e){e={}}var i=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-container crm-entity-widget-client-requisites-container-opened"}});this._innerWrapper=BX.create("dl",{props:{className:"crm-entity-widget-client-requisites-list"}});this.prepareViewLayout(e,["RQ_ADDR"]);this.prepareFieldViewLayout(e,"RQ_ADDR");var n=BX.prop.getArray(this._data,"bankDetailViewDataList",[]);for(var r=0,o=n.length;r<o;r++){var s=n[r];if(!BX.prop.getBoolean(s,"isDeleted",false)){this.prepareViewLayout(BX.prop.getObject(s,"viewData",null),[])}}if(!i){this._deleteButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-remove-icon"},events:{click:BX.delegate(this.onRemoveButtonClick,this)}});this._editButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-edit-icon"},events:{click:BX.delegate(this.onEditButtonClick,this)}})}this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-inner-container"},children:[this._deleteButton,this._editButton,this._innerWrapper]}));var a=BX.prop.getElementNode(t,"anchor",null);if(a){this._container.insertBefore(this._wrapper,a)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},prepareViewLayout:function(t,e){if(!t){return}var i=BX.prop.getString(t,"title","");if(i!==""){this._innerWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:i}))}var n,r;var o={};if(BX.type.isArray(e)){for(n=0,r=e.length;n<r;n++){o[e[n]]=true}}var s=[];var a=BX.prop.getArray(t,"fields",[]);for(n=0,r=a.length;n<r;n++){var l=a[n];var d=BX.prop.getString(l,"name","");if(o.hasOwnProperty(d)){continue}var h=BX.prop.getString(l,"title","");var p=BX.prop.getString(l,"textValue","");if(h!==""&&p!==""){s.push(h+": "+p)}}this._innerWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:s.join(", ")}))},prepareFieldViewLayout:function(t,e){if(!t){return}var i=BX.prop.getArray(t,"fields",[]);for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"name","");if(s!==e){continue}var a=BX.prop.getString(o,"title","");var l=BX.prop.getString(o,"textValue","");if(a===""||l===""){continue}this._innerWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:a}));this._innerWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:l}))}},clearLayout:function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._innerWrapper=null;this._editButton=null;this._deleteButton=null;this._hasLayout=false},getContainer:function(){return this._container},setContainer:function(t){this._container=t},getWrapper:function(){return this._wrapper},prepareData:function(){var t=this._labelInput?BX.util.trim(this._labelInput.value):"";if(t===""){return null}var e={VALUE:t};var i=BX.prop.getInteger(this._data,"ID",0);if(i>0){e["ID"]=i}var n=BX.prop.getString(this._data,"XML_ID","");if(i>0){e["XML_ID"]=n}return e},onEditButtonClick:function(t){this._owner.processItemEditing(this)},onRemoveButtonClick:function(t){var e=BX.Crm.EditorDialog.create(this._id,{title:this.getMessage("deleteTitle"),content:this.getMessage("deleteConfirm"),buttons:[{id:"accept",type:BX.Crm.EditorDialogButtonType.accept,text:BX.message("CRM_EDITOR_DELETE"),callback:BX.delegate(this.onRemovalConfirmationDialogButtonClick,this)},{id:"cancel",type:BX.Crm.EditorDialogButtonType.cancel,text:BX.message("CRM_EDITOR_CANCEL"),callback:BX.delegate(this.onRemovalConfirmationDialogButtonClick,this)}]});e.open()}};BX.Crm.EntityEditorRequisiteListItem.prototype.onRemovalConfirmationDialogButtonClick=function(t){var e=t.getDialog();if(t.getId()==="accept"){this._owner.processItemRemoval(this)}e.close()};if(typeof BX.Crm.EntityEditorRequisiteListItem.messages==="undefined"){BX.Crm.EntityEditorRequisiteListItem.messages={}}BX.Crm.EntityEditorRequisiteListItem.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteListItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteList==="undefined"){BX.Crm.EntityEditorRequisiteList=function(){BX.Crm.EntityEditorRequisiteList.superclass.constructor.apply(this);this._items=null;this._data=null;this._externalContext=null;this._externalEventHandler=null;this._createButton=null;this._dataInputs={};this._dataSignInputs={};this._itemWrapper=null;this._dataWrapper=null;this._isPresetMenuOpened=false;this._newItemIndex=-1;this._sliderUrls={}};BX.extend(BX.Crm.EntityEditorRequisiteList,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRequisiteList.prototype.doInitialize=function(){this.initializeFromModel()};BX.Crm.EntityEditorRequisiteList.prototype.initializeFromModel=function(){var t=this.getValue();this._data=BX.type.isArray(t)?BX.clone(t,true):[];for(var e=0,i=this._data.length;e<i;e++){this.prepareRequisiteData(this._data[e])}this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:0,bankDetailId:0,data:this._data})};BX.Crm.EntityEditorRequisiteList.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.initializeFromModel();this.refreshLayout()};BX.Crm.EntityEditorRequisiteList.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}for(var t in this._sliderUrls){if(this._sliderUrls.hasOwnProperty(t)){BX.Crm.Page.closeSlider(this._sliderUrls[t])}}this._sliderUrls={}};BX.Crm.EntityEditorRequisiteList.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorRequisiteList.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRequisiteList.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorRequisiteList.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorRequisiteList.prototype.prepareDataInputName=function(t,e){return this.getName()+"["+t.toString()+"]"+"["+e+"]"};BX.Crm.EntityEditorRequisiteList.prototype.prepareRequisiteData=function(t){var e=BX.prop.getInteger(t,"requisiteId",0);var i=BX.prop.getString(t,"pseudoId","");if(e>0){t["key"]=e.toString();t["isNew"]=false;t["isChanged"]=BX.prop.getBoolean(t,"isChanged",false)}else{t["key"]=i;t["isNew"]=true;t["isChanged"]=BX.prop.getBoolean(t,"isChanged",true)}t["isDeleted"]=false};BX.Crm.EntityEditorRequisiteList.prototype.findRequisiteDataIndexByKey=function(t){for(var e=0,i=this._data.length;e<i;e++){if(BX.prop.getString(this._data[e],"key",0)===t){return e}}return-1};BX.Crm.EntityEditorRequisiteList.prototype.getRequisiteDataByKey=function(t){var e=this.findRequisiteDataIndexByKey(t);return e>=0?this._data[e]:null};BX.Crm.EntityEditorRequisiteList.prototype.setupRequisiteData=function(t){var e=BX.prop.getString(t,"key","");if(e===""){return}var i=this.findRequisiteDataIndexByKey(e);if(i>=0){this._data[i]=t}else{this._data.push(t)}this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:0,bankDetailId:0,data:this._data})};BX.Crm.EntityEditorRequisiteList.prototype.refreshRequisiteDataInputs=function(){if(!this._hasLayout){return}BX.cleanNode(this._dataWrapper);for(var t=0,e=this._data.length;t<e;t++){var i=this._data[t];var n=BX.prop.getString(i,"key","");if(n===""){continue}var r=BX.prop.getBoolean(i,"isChanged",false);var o=BX.prop.getBoolean(i,"isDeleted",false);if(!r&&!o){continue}if(o){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"DELETED"),value:"Y"}}))}else{var s=BX.prop.getString(i,"requisiteDataSign","");if(s!==""){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"SIGN"),value:s}}))}var a=BX.prop.getString(i,"requisiteData","");if(a!==""){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"DATA"),value:a}}))}}}};BX.Crm.EntityEditorRequisiteList.prototype.layout=function(t){if(this._hasLayout){return}var e,i;this._items=[];var n=this._requisiteInfo.getItems();for(e=0,i=n.length;e<i;e++){var r=n[e];var o=BX.Crm.EntityEditorRequisiteListItem.create(BX.prop.getString(r,"key",""),{owner:this,mode:this._mode,data:r});this._items.push(o)}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});var s=this._mode===BX.Crm.EntityEditorMode.view;if(!s){this._dataWrapper=BX.create("div");this._wrapper.appendChild(this._dataWrapper);this._wrapper.appendChild(this.createDragButton())}if(!s){this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-requisites"}});this._wrapper.appendChild(this._itemWrapper);for(e=0,i=this._items.length;e<i;e++){this._items[e].setContainer(this._itemWrapper);this._items[e].layout()}this._createButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-add-btn"},text:BX.message("CRM_EDITOR_ADD")});this._itemWrapper.appendChild(this._createButton);BX.bind(this._createButton,"click",BX.delegate(this.onCreateButtonClick,this));this._wrapper.appendChild(this.createContextMenuButton());this.initializeDragDropAbilities()}else if(this._items.length>0){this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-colums-block"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._itemWrapper]}));this._wrapper.appendChild(this._itemWrapper);for(e=0,i=this._items.length;e<i;e++){this._items[e].setContainer(this._itemWrapper);this._items[e].layout()}}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRequisiteList.prototype.clearLayout=function(){for(var t=0,e=this._items.length;t<e;t++){this._items[t].clearLayout()}this._items=[];this._itemWrapper=null;this._createButton=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorRequisiteList.prototype.getItemByIndex=function(t){return t>=0&&t<=this._items.length-1?this._items[t]:null};BX.Crm.EntityEditorRequisiteList.prototype.getItemById=function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getId()===t){return n}}return null};BX.Crm.EntityEditorRequisiteList.prototype.getItemCount=function(){return this._items.length};BX.Crm.EntityEditorRequisiteList.prototype.getItemIndex=function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.Crm.EntityEditorRequisiteList.prototype.removeItemByIndex=function(t){if(t<this._items.length){this._items.splice(t,1)}};BX.Crm.EntityEditorRequisiteList.prototype.removeItem=function(t){var e=this.getItemIndex(t);if(e<0){return}var i=this.getRequisiteDataByKey(t.getId());if(i){i["isDeleted"]=true}t.clearLayout();this.removeItemByIndex(e);this.refreshRequisiteDataInputs();this.markAsChanged()};BX.Crm.EntityEditorRequisiteList.prototype.openEditor=function(t){var e=BX.prop.getInteger(t,"requisiteId",0);var i=this._editor.getContextId();var n={etype:this._editor.getEntityTypeId(),eid:this._editor.getEntityId(),external_context_id:i};var r=BX.prop.getInteger(t,"presetId",0);if(r>0){n["pid"]=r}var o="";if(e<=0){this._newItemIndex++;o="n"+this._newItemIndex.toString();n["pseudo_id"]=o}var s=BX.util.add_url_param(this._editor.getRequisiteEditUrl(e),n);if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalContext){this._externalContext={}}if(e>0){this._externalContext[e]={requisiteId:e,url:s}}else{this._externalContext[o]={pseudoId:o,url:s}}if(e>0){this._sliderUrls[e]=s}BX.Crm.Page.openSlider(s,{width:950})};BX.Crm.EntityEditorRequisiteList.prototype.processItemEditing=function(t){this.openEditor({requisiteId:t.getRequisiteId()})};BX.Crm.EntityEditorRequisiteList.prototype.processItemRemoval=function(t){this.removeItem(t)};BX.Crm.EntityEditorRequisiteList.prototype.onExternalEvent=function(t){var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";if(e!=="BX.Crm.RequisiteSliderEditor:onSave"){return}var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var n=BX.prop.getString(i,"context","");if(n!==this._editor.getContextId()){return}var r=BX.prop.getInteger(i,"presetId",0);var o=BX.prop.getString(i,"pseudoId","");var s=BX.prop.getInteger(i,"requisiteId",0);var a=BX.prop.getString(i,"requisiteDataSign","");var l=BX.prop.getString(i,"requisiteData","");var d={entityTypeId:this._editor.getEntityTypeId(),entityId:this._editor.getEntityId(),presetId:r,pseudoId:o,requisiteId:s,requisiteData:l,requisiteDataSign:a,isChanged:true};this.prepareRequisiteData(d);this.setupRequisiteData(d);this.refreshRequisiteDataInputs();this.markAsChanged();var h=BX.prop.getString(d,"key","");var p=BX.prop.getObject(this._externalContext,h,null);if(!p){return}var c=this.getItemById(h);var u;if(c){c.setData(d);c.clearLayout();u={};var m=this.getItemIndex(c);if(m<this.getItemCount()-1){u["anchor"]=this.getItemByIndex(m+1).getWrapper()}else if(this._createButton){u["anchor"]=this._createButton}c.layout(u)}else{c=BX.Crm.EntityEditorRequisiteListItem.create(h,{owner:this,mode:this._mode,data:d,container:this._itemWrapper});this._items.push(c);u={};if(this._createButton){u["anchor"]=this._createButton}c.layout(u)}var g=BX.prop.getString(p,"url","");if(g!==""){BX.Crm.Page.closeSlider(g,true)}delete this._externalContext[s]};BX.Crm.EntityEditorRequisiteList.prototype.onCreateButtonClick=function(t){this.togglePresetMenu()};BX.Crm.EntityEditorRequisiteList.prototype.togglePresetMenu=function(){if(this._isPresetMenuOpened){this.closePresetMenu()}else{this.openPresetMenu()}};BX.Crm.EntityEditorRequisiteList.prototype.openPresetMenu=function(){if(this._isPresetMenuOpened){return}var t=[];var e=BX.prop.getArray(this._schemeElement.getData(),"presets");for(var i=0,n=e.length;i<n;i++){var r=e[i];var o=BX.prop.getString(r,"VALUE",i);var s=BX.prop.getString(r,"NAME",o);t.push({text:s,value:o,onclick:BX.delegate(this.onPresetSelect,this)})}BX.PopupMenu.show(this._id,this._createButton,t,{angle:false,events:{onPopupShow:BX.delegate(this.onPresetMenuShow,this),onPopupClose:BX.delegate(this.onPresetMenuClose,this)}})};BX.Crm.EntityEditorRequisiteList.prototype.closePresetMenu=function(){if(!this._isPresetMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorRequisiteList.prototype.onPresetMenuShow=function(){this._isPresetMenuOpened=true};BX.Crm.EntityEditorRequisiteList.prototype.onPresetMenuClose=function(){BX.PopupMenu.destroy(this._id);this._isPresetMenuOpened=false};BX.Crm.EntityEditorRequisiteList.prototype.onPresetSelect=function(t,e){this.openEditor({presetId:e.value});this.closePresetMenu()};BX.Crm.EntityEditorRequisiteList.prototype.save=function(){};if(typeof BX.Crm.EntityEditorRequisiteList.messages==="undefined"){BX.Crm.EntityEditorRequisiteList.messages={}}BX.Crm.EntityEditorRequisiteList.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteList;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorEntityRequisitePanel==="undefined"){BX.Crm.ClientEditorEntityRequisitePanel=function(){this._id="";this._settings={};this._editor=null;this._entityInfo=null;this._requisiteInfo=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._selectedRequisiteId=0;this._selectedBankDetailId=0;this._container=null;this._wrapper=null;this._contentWrapper=null;this._requisiteInput=null;this._bankDetailInput=null;this._toggleButton=null;this._editButton=null;this._toggleButtonHandler=BX.delegate(this.onToggleButtonClick,this);this._editButtonHandler=BX.delegate(this.onEditButtonClick,this);this._isExpanded=false;this._hasLayout=false;this._externalEventHandler=BX.delegate(this.onExternalEvent,this)};BX.Crm.ClientEditorEntityRequisitePanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._container=BX.prop.getElementNode(this._settings,"container",null);this._mode=BX.prop.getInteger(this._settings,"mode",0);this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._requisiteInfo=BX.prop.get(this._settings,"requisiteInfo",null);this._selectedRequisiteId=this._requisiteInfo.getRequisiteId();this._selectedBankDetailId=this._requisiteInfo.getBankDetailId();if(BX.Crm.ClientEditorEntityRequisitePanel.options.hasOwnProperty(this._id)){this._isExpanded=BX.prop.getBoolean(BX.Crm.ClientEditorEntityRequisitePanel.options[this._id],"expanded",false)}},getMessage:function(t){var e=BX.Crm.ClientEditorEntityRequisitePanel.messages;return e.hasOwnProperty(t)?e[t]:t},getContainer:function(){return this._container},setContainer:function(t){this._container=t},isExpanded:function(){return this._isExpanded},setExpanded:function(t){t=!!t;if(this._isExpanded===t){return}this._isExpanded=t;if(!BX.Crm.ClientEditorEntityRequisitePanel.options.hasOwnProperty(this._id)){BX.Crm.ClientEditorEntityRequisitePanel.options[this._id]={}}BX.Crm.ClientEditorEntityRequisitePanel.options[this._id]["expanded"]=this._isExpanded;if(t){BX.addClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}else{BX.removeClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}},toggle:function(){this.setExpanded(!this._isExpanded)},layout:function(){if(this._hasLayout){return}var t=null;var e=null;var i=this._selectedRequisiteId;var n=this._selectedBankDetailId;if(i>0){t=this._requisiteInfo.getItemById(i)}if(!t){t=this._requisiteInfo.getSelectedItem()}if(!t){t=this._requisiteInfo.getFirstItem()}if(t){if(n>0){e=this._requisiteInfo.getItemBankDetailById(i,n)}if(!e){e=this._requisiteInfo.getSelectedItemBankDetail(i)}if(!e){e=this._requisiteInfo.getFirstItemBankDetail(i)}}var r=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-container"}});this._container.appendChild(this._wrapper);if(this._isExpanded){BX.addClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}if(!r){this._requisiteInput=BX.create("input",{props:{type:"hidden",name:"REQUISITE_ID",value:i}});this._wrapper.appendChild(this._requisiteInput);this._bankDetailInput=BX.create("input",{props:{type:"hidden",name:"BANK_DETAIL_ID",value:n}});this._wrapper.appendChild(this._bankDetailInput)}if(t){this._toggleButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-show-btn"},text:this.getMessage("toggle").toLowerCase()});this._wrapper.appendChild(this._toggleButton);BX.bind(this._toggleButton,"click",this._toggleButtonHandler);var o=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-inner-container"}});this._wrapper.appendChild(o);if(!r){this._editButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-edit-icon"}});o.appendChild(this._editButton);BX.bind(this._editButton,"click",this._editButtonHandler)}this._contentWrapper=BX.create("dl",{props:{className:"crm-entity-widget-client-requisites-list"}});o.appendChild(this._contentWrapper);var s=BX.prop.getObject(t,"viewData",null);this.prepareItemView(s,["RQ_ADDR"]);this.prepareItemFieldView(s,"RQ_ADDR");if(e){this.prepareItemView(BX.prop.getObject(e,"viewData",null))}}this._hasLayout=true},prepareItemView:function(t,e){if(!t){return}var i=BX.prop.getString(t,"title","");if(i!==""){this._contentWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:i}))}var n,r;var o={};if(BX.type.isArray(e)){for(n=0,r=e.length;n<r;n++){o[e[n]]=true}}var s=[];var a=BX.prop.getArray(t,"fields",[]);for(n=0,r=a.length;n<r;n++){var l=a[n];var d=BX.prop.getString(l,"name","");if(o.hasOwnProperty(d)){continue}var h=BX.prop.getString(l,"title","");var p=BX.prop.getString(l,"textValue","");if(h!==""&&p!==""){s.push(h+": "+p)}}this._contentWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:s.join(", ")}))},prepareItemFieldView:function(t,e){if(!t){return}var i=BX.prop.getArray(t,"fields",[]);for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"name","");if(s!==e){continue}var a=BX.prop.getString(o,"title","");var l=BX.prop.getString(o,"textValue","");if(a===""||l===""){continue}this._contentWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:a}));this._contentWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:l}))}},clearLayout:function(){if(!this._hasLayout){return}if(this._toggleButton){BX.unbind(this._toggleButton,"click",this._toggleButtonHandler);this._toggleButton=null}if(this._editButton){BX.unbind(this._editButton,"click",this._editButtonHandler);this._editButton=null}this._isExpanded=false;this._requisiteInput=null;this._bankDetailInput=null;this._contentWrapper=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},refreshLayout:function(){var t=this.isExpanded();this.clearLayout();this.layout();this.setExpanded(t)},onToggleButtonClick:function(t){this.toggle()},onEditButtonClick:function(t){if(!this._editor){return}var e=this._editor.getEntityRequisiteSelectUrl(this._entityInfo.getTypeName(),this._entityInfo.getId());if(e===""){return}e=BX.util.add_url_param(e,{external_context_id:this._editor.getContextId(),requisite_id:this._selectedRequisiteId,bank_detail_id:this._selectedBankDetailId});BX.Crm.Page.openSlider(e);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)},onExternalEvent:function(t){if(this._mode===BX.Crm.EntityEditorMode.view){return}var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};if(!(this._editor&&this._editor.getContextId()===BX.prop.getString(i,"context"))){return}if(e==="BX.Crm.EntityRequisiteSelector:onCancel"){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}else if(e==="BX.Crm.EntityRequisiteSelector:onSave"){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler);var n=BX.prop.getInteger(i,"requisiteId");if(n>0){this._selectedRequisiteId=n;if(this._requisiteInput){this._requisiteInput.value=this._selectedRequisiteId}}var r=BX.prop.getInteger(i,"bankDetailId");if(r){this._selectedBankDetailId=r;if(this._bankDetailInput){this._bankDetailInput.value=this._selectedBankDetailId}}this.refreshLayout()}}};if(typeof BX.Crm.ClientEditorEntityRequisitePanel.messages==="undefined"){BX.Crm.ClientEditorEntityRequisitePanel.messages={}}BX.Crm.ClientEditorEntityRequisitePanel.options={};BX.Crm.ClientEditorEntityRequisitePanel.create=function(t,e){var i=new BX.Crm.ClientEditorEntityRequisitePanel;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityBindingTracker==="undefined"){BX.Crm.EntityBindingTracker=function(){this._id="";this._settings={};this._boundEntityInfos=null;this._unboundEntityInfos=null};BX.Crm.EntityBindingTracker.prototype={initialize:function(){this._boundEntityInfos=[];this._unboundEntityInfos=[]},bind:function(t){if(this.findIndex(t,this._boundEntityInfos)>=0){return}var e=this.findIndex(t,this._unboundEntityInfos);if(e>=0){this._unboundEntityInfos.splice(e,1)}else{this._boundEntityInfos.push(t)}},unbind:function(t){if(this.findIndex(t,this._unboundEntityInfos)>=0){return}var e=this.findIndex(t,this._boundEntityInfos);if(e>=0){this._boundEntityInfos.splice(e,1)}else{this._unboundEntityInfos.push(t)}},getBoundEntities:function(){return this._boundEntityInfos},getUnboundEntities:function(){return this._unboundEntityInfos},isBound:function(t){return this.findIndex(t,this._boundEntityInfos)>=0},isUnbound:function(t){return this.findIndex(t,this._unboundEntityInfos)>=0},reset:function(){this._boundEntityInfos=[];this._unboundEntityInfos=[]},findIndex:function(t,e){var i=t.getId();for(var n=0,r=e.length;n<r;n++){if(i===e[n].getId()){return n}}return-1}};BX.Crm.EntityBindingTracker.create=function(){var t=new BX.Crm.EntityBindingTracker;t.initialize();return t}}if(typeof BX.Crm.ClientEditorEntitySkeleton==="undefined"){BX.Crm.ClientEditorEntitySkeleton=function(){this._id="";this._settings={};this._container=null;this._wrapper=null;this._hasLayout=false};BX.Crm.ClientEditorEntitySkeleton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null)},layout:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-block crm-entity-widget-client-block-skeleton"},children:[BX.create("div",{props:{className:"crm-entity-widget-client-box"}})]});this._container.appendChild(this._wrapper);this._hasLayout=true},clearLayout:function(){this._wrapper=BX.remove(this._wrapper);this._hasLayout=false}};BX.Crm.ClientEditorEntitySkeleton.create=function(t,e){var i=new BX.Crm.ClientEditorEntitySkeleton;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorEntityPanel==="undefined"){BX.Crm.ClientEditorEntityPanel=function(){this._id="";this._settings={};this._editor=null;this._entityInfo=null;this._requisiteInfo=null;this._requisitePanel=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._communicationButtons=null;this._deleteButton=null;this._container=null;this._wrapper=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._hasLayout=false};BX.Crm.ClientEditorEntityPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null);this._editor=BX.prop.get(this._settings,"editor");this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._mode=BX.prop.getInteger(this._settings,"mode",0)},getContainer:function(){return this._container},setContainer:function(t){this._container=t},getEntity:function(){return this._entityInfo},layout:function(){var t=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-block"}});this._container.appendChild(this._wrapper);var e=BX.create("div",{props:{className:"crm-entity-widget-client-box"}});this._wrapper.appendChild(e);if(BX.prop.getBoolean(this._settings,"enableEntityTypeCaption",false)){e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-box-type"},text:this._entityInfo.getTypeCaption()}))}this._deleteButton=null;if(!t){this._deleteButton=BX.create("div",{props:{className:"crm-entity-widget-client-block-remove"},events:{click:this._deleteButtonHandler}});e.appendChild(this._deleteButton)}var i=BX.create("div",{props:{className:"crm-entity-widget-client-box-name-container"}});e.appendChild(i);i.appendChild(BX.create("a",{props:{className:"crm-entity-widget-client-box-name",href:this._entityInfo.getShowUrl()},text:this._entityInfo.getTitle()}));var n=BX.create("div",{props:{className:"crm-entity-widget-client-actions-container"}});i.appendChild(n);this._communicationButtons=[];var r=["PHONE","EMAIL","IM"];for(var o=0,s=r.length;o<s;o++){var a=r[o];var l=BX.Crm.ClientEditorCommunicationButton.create(this._id+"_"+a,{entityInfo:this._entityInfo,type:a,ownerTypeId:this._editor.getOwnerTypeId(),ownerId:this._editor.getOwnerId(),container:n});l.layout();this._communicationButtons.push(l)}e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-box-position"},text:this._entityInfo.getDescription()}));if(BX.prop.getBoolean(this._settings,"enableRequisite",false)){var d=BX.prop.getObject(this._settings,"requisiteBinding",{});this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:BX.prop.getInteger(d,"REQUISITE_ID",0),bankDetailId:BX.prop.getInteger(d,"BANK_DETAIL_ID",0),data:this._entityInfo.getRequisites()});this._requisitePanel=BX.Crm.ClientEditorEntityRequisitePanel.create(this._id,{editor:this._editor,entityInfo:this._entityInfo,requisiteInfo:this._requisiteInfo,container:e,mode:this._mode});this._requisitePanel.layout()}var h=BX.prop.getFunction(this._settings,"onLayout",null);if(h){h(this,this._wrapper)}this._hasLayout=true},clearLayout:function(){if(this._requisitePanel){this._requisitePanel.clearLayout();this._requisitePanel=null}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},onDeleteButtonClick:function(t){var e=BX.prop.getFunction(this._settings,"onDelete");if(e){e(this)}}};BX.Crm.ClientEditorEntityPanel.create=function(t,e){var i=new BX.Crm.ClientEditorEntityPanel;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorEntityBindingPanel==="undefined"){BX.Crm.ClientEditorEntityBindingPanel=function(){this._id="";this._settings={};this._container=null;this._entityInfo=null;this._editor=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._item=null};BX.Crm.ClientEditorEntityBindingPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null);this._editor=BX.prop.get(this._settings,"editor");this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._mode=BX.prop.getInteger(this._settings,"mode",0);this._item=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+this._entityInfo.getId().toString(),{editor:this._editor,entityInfo:this._entityInfo,mode:this._mode,onLayout:BX.delegate(this.onItemLayout,this),onDelete:BX.delegate(this.onItemDelete,this)})},getEntity:function(){return this._entityInfo},getContainer:function(){return this._container},setContainer:function(t){this._container=t},layout:function(){this._button=BX.create("div",{props:{className:"crm-entity-widget-client-child-link"},events:{click:BX.delegate(this.onButtonClick,this)}});this._item.setContainer(this._container);this._item.layout()},onItemLayout:function(t,e){BX.addClass(e,"crm-entity-widget-client-block-child");var i=e.firstChild;if(i){e.insertBefore(this._button,i)}else{e.appendChild(this._button)}},clearLayout:function(){this._item.clearLayout()},onItemDelete:function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){return}var e=BX.prop.getFunction(this._settings,"onChange",null);if(e){e(this,"delete")}},onButtonClick:function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){return}var e=BX.prop.getFunction(this._settings,"onChange",null);if(e){e(this,"unbind")}}};BX.Crm.ClientEditorEntityBindingPanel.create=function(t,e){var i=new BX.Crm.ClientEditorEntityBindingPanel;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorCommunicationButton==="undefined"){BX.Crm.ClientEditorCommunicationButton=function(){this._id="";this._settings={};this._entityInfo=null;this._type="";this._items=null;this._container=null;this._wrapper=null;this._menu=null};BX.Crm.ClientEditorCommunicationButton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._type=BX.prop.getString(this._settings,"type","");this._container=BX.prop.getElementNode(this._settings,"container","");if(this._type===""){this._type="PHONE"}this._items=this._entityInfo.getMultiFieldsByType(this._type)},layout:function(){var t="";if(this._type==="EMAIL"){t="crm-entity-widget-client-action-mail"}else if(this._type==="IM"){t="crm-entity-widget-client-action-im"}else{t="crm-entity-widget-client-action-call"}if(this._items.length>0){t+=" crm-entity-widget-client-action-available"}this._wrapper=BX.create("div",{props:{className:t}});BX.bind(this._wrapper,"click",BX.delegate(this.onClick,this));this._container.appendChild(this._wrapper)},onClick:function(t){if(this._items.length===0){return}if(this._items.length===1){var e=this._items[0];var i=BX.prop.getString(e,"VALUE");if(i!==""){if(this._type==="PHONE"){this.addCall(i)}else if(this._type==="EMAIL"){this.addEmail(i)}else if(this._type==="IM"){}}return}this.toggleMenu()},toggleMenu:function(){if(!this._menu){var t=[];for(var e=0,i=this._items.length;e<i;e++){var n=BX.prop.getString(this._items[e],"VALUE");var r=BX.prop.getString(this._items[e],"VALUE_FORMATTED");var o=BX.prop.getString(this._items[e],"COMPLEX_NAME");var s=(o?o+": ":"")+(r?r:n);if(n!==""){t.push({id:n,text:s})}}this._menu=BX.Crm.ClientEditorMenu.create(this._id.toLowerCase()+"_menu",{anchor:this._wrapper,items:t,callback:BX.delegate(this.onMenuItemSelect,this)})}this._menu.toggle()},onMenuItemSelect:function(t,e){if(this._type==="EMAIL"){this.addEmail(e["id"])}else if(this._type==="IM"){}else{this.addCall(e["id"])}this._menu.close()},addCall:function(t){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("telephonyNotSupported"));return}var e={ENTITY_TYPE_NAME:this._entityInfo.getTypeName(),ENTITY_ID:this._entityInfo.getId(),AUTO_FOLD:true};var i=BX.prop.getInteger(this._settings,"ownerTypeId",0);var n=BX.prop.getInteger(this._settings,"ownerId",0);if(i!==this._entityInfo.getTypeId()||n!==this._entityInfo.getId()){e["BINDINGS"]=[{OWNER_TYPE_NAME:BX.CrmEntityType.resolveName(i),OWNER_ID:n}]}window.top["BXIM"].phoneTo(t,e)},addEmail:function(t){BX.CrmActivityEditor.addEmail({communicationsLoaded:true,communications:[{type:"EMAIL",entityType:this._entityInfo.getTypeName(),entityId:this._entityInfo.getId(),value:t}]})}};BX.Crm.ClientEditorCommunicationButton.prototype.getMessage=function(t){var e=BX.Crm.ClientEditorCommunicationButton.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.ClientEditorCommunicationButton.messages==="undefined"){BX.Crm.ClientEditorCommunicationButton.messages={}}BX.Crm.ClientEditorCommunicationButton.create=function(t,e){var i=new BX.Crm.ClientEditorCommunicationButton;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorMenu==="undefined"){BX.Crm.ClientEditorMenu=function(){this._id=null;this._settings={};this._items=null;this._isOpened=false;this._popup=null};BX.Crm.ClientEditorMenu.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._items=BX.prop.getArray(this._settings,"items",[]);for(var i=0,n=this._items.length;i<n;i++){this._items[i]["onclick"]=BX.delegate(this.onItemSelect,this)}},onItemSelect:function(t,e){var i=BX.prop.getFunction(this._settings,"callback",null);if(i){i(this,e)}},isOpened:function(){return this._isOpened},open:function(){if(this._isOpened){return}BX.PopupMenu.show(this._id,BX.prop.getElementNode(this._settings,"anchor",null),this._items,{offsetTop:0,offsetLeft:0,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._popup=BX.PopupMenu.currentItem},close:function(){if(!this._isOpened){return}if(this._popup){if(this._popup.popupWindow){this._popup.popupWindow.destroy()}}},toggle:function(){if(!this._isOpened){this.open()}else{this.close()}},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){this.close()},onPopupDestroy:function(){this._isOpened=false;this._popup=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}};BX.Crm.ClientEditorMenu.create=function(t,e){var i=new BX.Crm.ClientEditorMenu;i.initialize(t,e);return i}}if(typeof BX.Crm.UserFieldTypeMenu==="undefined"){BX.Crm.UserFieldTypeMenu=function(){this._id=null;this._settings={};this._items=null;this._isOpened=false;this._popup=null};BX.Crm.UserFieldTypeMenu.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._items=[];var i=BX.prop.getArray(e,"items");for(var n=0,r=i.length;n<r;n++){var o=i[n];o["menu"]=this;this._items.push(BX.Crm.UserFieldTypeMenuItem.create(BX.prop.getString(o,"value"),o))}},getId:function(){return this._id},isOpened:function(){return this._isOpened},open:function(t){if(this._isOpened){return}this._popup=new BX.PopupWindow(this._id,t,{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:true},closeByEsc:true,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.prepareContent()});this._popup.show()},close:function(){if(!this._isOpened){return}if(this._popup){this._popup.close()}},prepareContent:function(){var t=BX.create("div",{props:{className:"crm-entity-card-widget-create-field-popup"}});var e=BX.create("div",{props:{className:"crm-entity-card-widget-create-field-list"}});t.appendChild(e);for(var i=0,n=this._items.length;i<n;i++){e.appendChild(this._items[i].prepareContent())}return t},onItemSelect:function(t){var e=BX.prop.getFunction(this._settings,"callback",null);if(e){e(this,t)}},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){if(this._popup){this._popup.destroy()}},onPopupDestroy:function(){this._isOpened=false;this._popup=null}};BX.Crm.UserFieldTypeMenu.create=function(t,e){var i=new BX.Crm.UserFieldTypeMenu;i.initialize(t,e);return i}}if(typeof BX.Crm.UserFieldTypeMenuItem==="undefined"){BX.Crm.UserFieldTypeMenuItem=function(){this._id="";this._settings=null;this._menu="";this._value="";this._text="";this._legend=""};BX.Crm.UserFieldTypeMenuItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._menu=BX.prop.get(e,"menu");this._value=BX.prop.getString(e,"value");this._text=BX.prop.getString(e,"text");this._legend=BX.prop.getString(e,"legend")},getId:function(){return this._id},getValue:function(){return this._value},getText:function(){return this._text},getLegend:function(){return this._legend},prepareContent:function(){var t=BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item"},events:{click:BX.delegate(this.onClick,this)}});t.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item-title"},text:this._text}));t.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item-desc"},text:this._legend}));return t},onClick:function(t){this._menu.onItemSelect(this)}};BX.Crm.UserFieldTypeMenuItem.create=function(t,e){var i=new BX.Crm.UserFieldTypeMenuItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurring==="undefined"){BX.Crm.EntityEditorRecurring=function(){this._input=null};BX.extend(BX.Crm.EntityEditorRecurring,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorRecurring.prototype.doInitialize=function(t){this._enableRecurring=BX.prop.getBoolean(this._schemeElement._settings,"enableRecurring",true)};BX.Crm.EntityEditorRecurring.prototype.layout=function(t){var e=this._schemeElement.getData();var i=this.getName();var n=this._model.getField(i);var r=this._schemeElement.getTitle();var o=this._mode===BX.Crm.EntityEditorMode.view;this._showClassName="crm-entity-widget-content-show";this._hideClassName="crm-entity-widget-content-hide";this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-container"},events:{}})]});if(!BX.type.isPlainObject(t)){t={}}var s=BX.prop.getElementNode(t,"anchor",null);if(s){this._container.insertBefore(this._wrapper,s)}else{this._container.appendChild(this._wrapper)}if(o){var a=BX.create("div");if(this._schemeElement._promise instanceof BX.Promise){a.classList="crm-entity-widget-content-wrapper";this._wrapper.appendChild(a);this.loadViewText();this._wrapper.appendChild(a);this._schemeElement._promise.then(BX.proxy(function(){a.classList="crm-entity-widget-content-block-title";a.innerHTML=BX.util.htmlspecialchars(e.view.text);this._wrapper.innerHTML="";this._wrapper.appendChild(a)},this))}else{a.classList="crm-entity-widget-content-block-title";a.innerHTML=e.view.text;this._wrapper.appendChild(a)}}else{if(!this._enableRecurring)BX.addClass(this._wrapper,"crm-entity-widget-content-block-locked");this._input=BX.create("input",{attrs:{name:this.getName(),type:"hidden",value:n}});if(BX.type.isPlainObject(e.data)&&e.data.MULTIPLY_EXECUTION===n.EXECUTION_TYPE&&e.data.NON_ACTIVE===n.PERIOD_DEAL){this._isShowBlock=false}else this._isShowBlock=true;if(this._enableRecurring)this._actionWrapper=this.getLayoutEdit(e.data);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},text:r}));if(this._enableRecurring){this._wrapper.appendChild(this._actionWrapper)}else{var l=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{type:"text",props:{className:"crm-entity-widget-content-input",disabled:"disabled"},text:this.getMessage("notRepeat"),events:{click:BX.delegate(this.showLicencePopup,this)}})]});this._wrapper.appendChild(l);var d=BX.create("button",{props:{className:"crm-entity-widget-content-block-locked-icon"},events:{click:BX.delegate(this.showLicencePopup,this)}});this._wrapper.appendChild(d)}}};BX.Crm.EntityEditorRecurring.prototype.toggleFields=function(t){var e=this._schemeElement.getData();var i=null;if(BX.type.isPlainObject(e.data)&&e.data.MULTIPLY_EXECUTION===t.EXECUTION_TYPE&&e.data.NON_ACTIVE===t.PERIOD_DEAL){var n=BX.findChildrenByClassName(this._actionWrapper,this._showClassName);for(i in n){if(BX.type.isDomNode(n[i])){BX.removeClass(n[i],this._showClassName);BX.addClass(n[i],this._hideClassName)}}}else{var r=BX.findChildrenByClassName(this._actionWrapper,this._hideClassName);for(i in r){if(BX.type.isDomNode(r[i])){BX.removeClass(r[i],this._hideClassName);BX.addClass(r[i],this._showClassName)}}}};BX.Crm.EntityEditorRecurring.prototype.getLayoutEdit=function(t){var e=this._model.getField(this.getName());var i={};if(BX.type.isPlainObject(t.PERIOD_DEAL)&&BX.type.isPlainObject(t.PERIOD_DEAL.options)){i=t.PERIOD_DEAL.options}var n=BX.create("div",{props:{className:"crm-entity-widget-content-block-form"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-form-radio"},children:[BX.create("input",{props:{name:"RECURRING[EXECUTION_TYPE]",type:"radio",value:BX.prop.getString(t,"MULTIPLY_EXECUTION"),checked:BX.prop.getString(e,"EXECUTION_TYPE")===BX.prop.getString(t,"MULTIPLY_EXECUTION")||!BX.prop.getString(e,"EXECUTION_TYPE",false)},events:{change:BX.delegate(function(t){this.setParams("EXECUTION_TYPE",t.target.value)},this)}})]}),this.createListInput({text:BX.type.isPlainObject(i[BX.prop.getString(e,"PERIOD_DEAL")])?i[BX.prop.getString(e,"PERIOD_DEAL")]["NAME"]:"",props:{className:"crm-entity-widget-content-select crm-entity-widget-content-select-form",name:"PERIOD_DEAL",value:BX.prop.getString(e,"PERIOD_DEAL")},options:i}),BX.create("input",{props:{id:"crm-entity-widget-content-select-PERIOD_DEAL",name:"RECURRING[PERIOD_DEAL]",type:"hidden",value:BX.prop.getString(e,"PERIOD_DEAL")}})]});var r=this._isShowBlock?this._showClassName:this._hideClassName;var o="crm-entity-widget-content-block-form"+" "+r;var s={};if(BX.type.isPlainObject(t.DEAL_TYPE_BEFORE)&&BX.type.isPlainObject(t.DEAL_TYPE_BEFORE.options)){s=t.DEAL_TYPE_BEFORE.options}var a=BX.create("div",{props:{className:o},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-form-radio"},children:[BX.create("input",{props:{id:"deal_recurring_execution_type2",name:"RECURRING[EXECUTION_TYPE]",type:"radio",value:BX.prop.getString(t,"SINGLE_EXECUTION"),checked:BX.prop.getString(e,"EXECUTION_TYPE")===BX.prop.getString(t,"SINGLE_EXECUTION")},events:{change:BX.delegate(function(t){this.setParams("EXECUTION_TYPE",t.target.value)},this)}})]}),BX.create("div",{props:{className:"crm-entity-widget-content-select-form"},children:[BX.create("label",{text:this.getMessage("createBeforeDate"),style:{marginTop:"10px",display:"block"},attrs:{for:"deal_recurring_execution_type2"}}),BX.create("br",{}),BX.create("input",{style:{width:"50px",display:"inline-block",textAlign:"center",marginRight:"5px"},props:{type:"text",name:"RECURRING[DEAL_COUNT_BEFORE]",className:"crm-entity-widget-content-input",value:BX.prop.getString(e,"DEAL_COUNT_BEFORE")||""},events:{input:BX.delegate(function(t){this.setParams("DEAL_COUNT_BEFORE",t.target.value)},this)}}),this.createListInput({text:BX.type.isPlainObject(s[BX.prop.getString(e,"DEAL_TYPE_BEFORE")])?s[BX.prop.getString(e,"DEAL_TYPE_BEFORE")]["NAME"]:"",style:{width:"130px",display:"inline-block",marginRight:"5px"},props:{className:"crm-entity-widget-content-select",name:"DEAL_TYPE_BEFORE",value:BX.prop.getString(e,"DEAL_TYPE_BEFORE")},options:s}),BX.create("input",{props:{id:"crm-entity-widget-content-select-DEAL_TYPE_BEFORE",name:"RECURRING[DEAL_TYPE_BEFORE]",type:"hidden",value:BX.prop.getString(e,"DEAL_TYPE_BEFORE")}}),BX.create("span",{text:this.getMessage("until")}),BX.create("div",{props:{className:"crm-entity-widget-content-block-date-input"},style:{width:"160px",display:"inline-block"},children:[BX.create("input",{text:BX.prop.getString(e,"DEAL_DATEPICKER_BEFORE")||"",style:{display:"inline-block"},props:{name:"RECURRING[DEAL_DATEPICKER_BEFORE]",className:"crm-entity-widget-content-input",value:BX.prop.getString(e,"DEAL_DATEPICKER_BEFORE")},events:{click:function(){BX.calendar({node:this,field:this,bTime:false})},change:BX.delegate(function(t){this.setParams("DEAL_DATEPICKER_BEFORE",t.target.value)},this)}})]})]})]});var l=BX.create("div",{props:{className:o},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},text:this.getMessage("repeatUntil")})]});var d=BX.create("div",{props:{className:o},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-form-radio"},style:{minHeight:"16px"},children:[BX.create("input",{props:{id:"deal_recurring_before_no_limited",name:"RECURRING[REPEAT_TILL]",type:"radio",checked:BX.prop.getString(e,"REPEAT_TILL")===BX.prop.getString(t,"NO_LIMIT")||!BX.prop.getString(e,"REPEAT_TILL",false),value:BX.prop.getString(t,"NO_LIMIT")},events:{change:BX.delegate(function(t){this.setParams("REPEAT_TILL",t.target.value)},this)}})]}),BX.create("div",{props:{className:"crm-entity-widget-content-select-form"},children:[BX.create("label",{text:this.getMessage("noLimitDate"),attrs:{for:"deal_recurring_before_no_limited"}})]})]});var h=BX.create("div",{props:{className:o},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-form-radio"},children:[BX.create("input",{props:{id:"deal_recurring_before_limited_by_date",name:"RECURRING[REPEAT_TILL]",type:"radio",checked:BX.prop.getString(e,"REPEAT_TILL")===BX.prop.getString(t,"LIMITED_BY_DATE"),value:BX.prop.getString(t,"LIMITED_BY_DATE")},events:{change:BX.delegate(function(t){this.setParams("REPEAT_TILL",t.target.value)},this)}})]}),BX.create("div",{props:{className:"crm-entity-widget-content-select-form"},children:[BX.create("label",{text:this.getMessage("dateLimit"),attrs:{for:"deal_recurring_before_limited_by_date"}}),BX.create("div",{props:{className:"crm-entity-widget-content-block-date-input"},style:{width:"160px",display:"inline-block"},children:[BX.create("input",{text:BX.prop.getString(e,"END_DATE")||"",props:{name:"RECURRING[END_DATE]",className:"crm-entity-widget-content-date-input",value:BX.prop.getString(e,"END_DATE")||""},events:{click:function(){BX.calendar({node:this,field:this,bTime:false})},change:BX.delegate(function(t){this.setParams("END_DATE",t.target.value)},this)}})]})]})]});var p=BX.create("div",{props:{className:o},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-form-radio"},children:[BX.create("input",{props:{id:"deal_recurring_before_limited_by_times",name:"RECURRING[REPEAT_TILL]",type:"radio",checked:BX.prop.getString(e,"REPEAT_TILL")===BX.prop.getString(t,"LIMITED_BY_TIMES"),value:BX.prop.getString(t,"LIMITED_BY_TIMES")},events:{change:BX.delegate(function(t){this.setParams("REPEAT_TILL",t.target.value)},this)}})]}),BX.create("div",{props:{className:"crm-entity-widget-content-select-form"},children:[BX.create("label",{text:this.getMessage("finishAfter"),attrs:{for:"deal_recurring_before_limited_by_times"}}),BX.create("input",{style:{width:"50px",display:"inline-block"},props:{type:"text",name:"RECURRING[LIMIT_REPEAT]",className:"crm-entity-widget-content-input",value:BX.prop.getString(e,"LIMIT_REPEAT")||""},events:{input:BX.delegate(function(t){this.setParams("LIMIT_REPEAT",t.target.value)},this)}}),BX.create("span",{text:this.getMessage("repeats")})]})]});var c=BX.create("input",{props:{name:"IS_RECURRING",type:"hidden",value:this._model.getField("IS_RECURRING")==="Y"?"Y":"N"}});var u={};if(BX.type.isPlainObject(t.CATEGORY_LIST)&&BX.type.isArray(t.CATEGORY_LIST.options)){u=t.CATEGORY_LIST.options}if(u.length>0){var m=BX.create("div",{props:{className:o},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},text:this.getMessage("directionSelectorTitle")}),this.createListInput({text:BX.type.isPlainObject(u[BX.prop.getString(e,"CATEGORY_ID")])?u[BX.prop.getString(e,"CATEGORY_ID")]["NAME"]:"",props:{className:"crm-entity-widget-content-select",name:"CATEGORY_ID",value:BX.prop.getString(e,"CATEGORY_ID")},options:u}),BX.create("input",{props:{id:"crm-entity-widget-content-select-CATEGORY_ID",name:"RECURRING[CATEGORY_ID]",type:"hidden",value:BX.prop.getString(e,"CATEGORY_ID")}})]})}return BX.create("div",{children:[n,a,l,d,h,p,c,m]})};BX.Crm.EntityEditorRecurring.prototype.createListInput=function(t){var e=this._model.getField(this.getName());if(!BX.type.isPlainObject(t)){return{}}var i=this.getElementName(t);var n=t.options;var r="";if(i!==""&&BX.type.isNotEmptyString(BX.prop.getString(e,i))&&BX.type.isPlainObject(n[e[i]])&&BX.type.isNotEmptyString(n[e[i]]["text"])){r=n[e[i]]["text"]}else{r=t.text}return BX.create("div",{props:t.props||{},text:r,style:t.style||"",events:{click:BX.delegate(function(t){this._selectContainer=t.target;var e=[];var r="crm-entity-widget-content-select-"+i;var o=BX(r);for(var s in n){if(BX.type.isNotEmptyString(n[s]["NAME"])&&BX.type.isNotEmptyString(n[s]["VALUE"])){e.push({text:n[s]["NAME"],value:n[s]["VALUE"],onclick:BX.delegate(function(t,e){this.onMenuClose();this.setParams(i,e.value);o.setAttribute("value",e.value);this._selectContainer.innerHTML=BX.util.htmlspecialchars(e.text);BX.PopupMenu.destroy(i)},this)})}}BX.addClass(this._selectContainer,"active");BX.PopupMenu.show(i,this._selectContainer,e,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupClose:BX.delegate(this.onMenuClose,this)}})},this)}})};BX.Crm.EntityEditorRecurring.prototype.onMenuClose=function(t){BX.removeClass(this._selectContainer,"active")};BX.Crm.EntityEditorRecurring.prototype.showLicencePopup=function(t){t.preventDefault();if(!B24||!B24["licenseInfoPopup"]){return}var e=this._schemeElement.getData();var i=e.restrictMessage;if(BX.type.isPlainObject(i)&&BX.type.isNotEmptyString(i.title)&&BX.type.isNotEmptyString(i.text)){B24.licenseInfoPopup.show("crm-deal-recurring-restricted",i.title,i.text)}};BX.Crm.EntityEditorRecurring.prototype.getElementName=function(t){if(BX.type.isPlainObject(t)){if(BX.type.isPlainObject(t.props)){if(BX.type.isNotEmptyString(t.props.name)){return t.props.name}}}return""};BX.Crm.EntityEditorRecurring.prototype.setParams=function(t,e){if(!BX.type.isNotEmptyString(t))return;var i=this._model.getField(this.getName());i[t]=e;this._model.setField(this.getName(),i);if(t==="EXECUTION_TYPE"||t==="PERIOD_DEAL"){this.toggleFields(i)}this.markAsChanged()};BX.Crm.EntityEditorRecurring.prototype.onBeforeSubmit=function(){this._input.value=this._model.getField(this.getName())};BX.Crm.EntityEditorRecurring.prototype.save=function(){this._schemeElement._promise=new BX.Promise};BX.Crm.EntityEditorRecurring.prototype.loadViewText=function(){var t=this._schemeElement.getData();if(BX.type.isPlainObject(t.loaders)&&BX.type.isNotEmptyString(t.loaders["url"])&&BX.type.isNotEmptyString(t.loaders["action"])){BX.ajax({url:t.loaders["url"],method:"POST",dataType:"json",data:{ACTION:t.loaders["action"],PARAMS:{ID:this._model.getField("ID")}},onsuccess:BX.delegate(this.onEntityHintLoad,this)})}};BX.Crm.EntityEditorRecurring.prototype.onEntityHintLoad=function(t){var e=BX.prop.getObject(t,"DATA",null);if(!e){return}if(BX.type.isNotEmptyString(e.HINT)){this._schemeElement._data.view.text=e.HINT}if(this._schemeElement._promise instanceof BX.Promise){this._schemeElement._promise.fulfill();this._schemeElement._promise=null}};BX.Crm.EntityEditorRecurring.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRecurring.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRecurring.create=function(t,e){var i=new BX.Crm.EntityEditorRecurring;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorController==="undefined"){BX.Crm.EntityEditorController=function(){this._id="";this._settings={};this._editor=null;this._model=null;this._config=null;this._isChanged=false};BX.Crm.EntityEditorController.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor",null);this._model=BX.prop.get(this._settings,"model",null);this._config=BX.prop.getObject(this._settings,"config",{});this.doInitialize()},doInitialize:function(){},getConfig:function(){return this._config},getConfigStringParam:function(t,e){return BX.prop.getString(this._config,t,e)},isChanged:function(){return this._isChanged},markAsChanged:function(){if(this._isChanged){return}this._isChanged=true;if(this._editor){this._editor.processControllerChange(this)}},rollback:function(){},onBeforeSubmit:function(){}}}if(typeof BX.Crm.EntityEditorProductRowProxy==="undefined"){BX.Crm.EntityEditorProductRowProxy=function(){BX.Crm.EntityEditorProductRowProxy.superclass.constructor.apply(this);this._externalEditor=null;this._editorCreateHandler=null;this._sumTotalChangeHandler=null;this._productAddHandler=null;this._productChangeHandler=null;this._productRemoveHandler=null;this._editorModeChangeHandler=BX.delegate(this.onEditorModeChange,this);this._editorControlChangeHandler=BX.delegate(this.onEditorControlChange,this);this._currencyId=""};BX.extend(BX.Crm.EntityEditorProductRowProxy,BX.Crm.EntityEditorController);BX.Crm.EntityEditorProductRowProxy.prototype.doInitialize=function(){BX.Crm.EntityEditorProductRowProxy.superclass.doInitialize.apply(this);this._sumTotalChangeHandler=BX.delegate(this.onSumTotalChange,this);this._productAddHandler=BX.delegate(this.onProductAdd,this);this._productChangeHandler=BX.delegate(this.onProductChange,this);this._productRemoveHandler=BX.delegate(this.onProductRemove,this);var t=typeof BX.CrmProductEditor!=="undefined"?BX.CrmProductEditor.get(this.getExternalEditorId()):null;if(t){this.setExternalEditor(t)}else{this._editorCreateHandler=BX.delegate(this.onEditorCreate,this);BX.addCustomEvent(window,"ProductRowEditorCreated",this._editorCreateHandler)}this._editor.addModeChangeListener(this._editorModeChangeHandler);BX.addCustomEvent(window,"onEntityDetailsTabShow",BX.delegate(this.onTabShow,this))};BX.Crm.EntityEditorProductRowProxy.prototype.onTabShow=function(t){if(t.getId()!=="tab_products"){return}if(this._externalEditor&&!this._externalEditor.hasLayout()){this._externalEditor.layout()}};BX.Crm.EntityEditorProductRowProxy.prototype.getExternalEditorId=function(){return this.getConfigStringParam("editorId","")};BX.Crm.EntityEditorProductRowProxy.prototype.setExternalEditor=function(t){if(this._externalEditor===t){return}if(this._externalEditor){this._externalEditor.setForm(null);BX.removeCustomEvent(this._externalEditor,"sumTotalChange",this._sumTotalChangeHandler);BX.removeCustomEvent(this._externalEditor,"productAdd",this._productAddHandler);BX.removeCustomEvent(this._externalEditor,"productChange",this._productChangeHandler);BX.removeCustomEvent(this._externalEditor,"productRemove",this._productRemoveHandler)}this._externalEditor=t;if(this._externalEditor){this._externalEditor.setForm(this._editor.getFormElement());BX.addCustomEvent(this._externalEditor,"sumTotalChange",this._sumTotalChangeHandler);BX.addCustomEvent(this._externalEditor,"productAdd",this._productAddHandler);BX.addCustomEvent(this._externalEditor,"productChange",this._productChangeHandler);BX.addCustomEvent(this._externalEditor,"productRemove",this._productRemoveHandler);this.adjustLocks()}};BX.Crm.EntityEditorProductRowProxy.prototype.adjustLocks=function(){if(!this._externalEditor){return}if(this._externalEditor.getProductCount()>0){this._model.lockField("OPPORTUNITY")}else{this._model.unlockField("OPPORTUNITY")}};BX.Crm.EntityEditorProductRowProxy.prototype.adjustTotals=function(t){this._model.setField("FORMATTED_OPPORTUNITY",t["FORMATTED_SUM"],{enableNotification:false});this._model.setField("FORMATTED_OPPORTUNITY_WITH_CURRENCY",t["FORMATTED_SUM_WITH_CURRENCY"],{enableNotification:false});this._model.setField("OPPORTUNITY",t["SUM"],{enableNotification:true})};BX.Crm.EntityEditorProductRowProxy.prototype.onEditorCreate=function(t){if(t.getId()!==this.getExternalEditorId()){return}BX.removeCustomEvent(window,"ProductRowEditorCreated",this._editorCreateHandler);delete this._editorCreateHandler;this.setExternalEditor(t)};BX.Crm.EntityEditorProductRowProxy.prototype.onEditorModeChange=function(t){if(this._editor.getMode()===BX.Crm.EntityEditorMode.edit){this._editor.addControlChangeListener(this._editorControlChangeHandler)}else{this._editor.removeControlChangeListener(this._editorControlChangeHandler)}this._isChanged=false};BX.Crm.EntityEditorProductRowProxy.prototype.onEditorControlChange=function(t,e){if(!this._externalEditor){return}var i=BX.prop.getString(e,"fieldName","");if(i!=="CURRENCY_ID"){return}var n=BX.prop.getString(e,"fieldValue","");if(n!==""){this._currencyId=n;this._externalEditor.setCurrencyId(this._currencyId)}};BX.Crm.EntityEditorProductRowProxy.prototype.onProductAdd=function(t){this.adjustLocks();this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.onProductChange=function(t){this.adjustLocks();this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.onProductRemove=function(t){this.adjustLocks();this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.onSumTotalChange=function(t,e){this.adjustTotals({FORMATTED_SUM_WITH_CURRENCY:e["TOTAL_SUM_FORMATTED"],FORMATTED_SUM:e["TOTAL_SUM_FORMATTED_SHORT"],SUM:e["TOTAL_SUM"]});this.markAsChanged()};BX.Crm.EntityEditorProductRowProxy.prototype.rollback=function(){var t=this._model.getField("CURRENCY_ID","");if(this._currencyId!==t){this._currencyId=t;if(this._externalEditor){this._externalEditor.setCurrencyId(this._currencyId)}}};BX.Crm.EntityEditorProductRowProxy.prototype.onBeforeSubmit=function(){if(this._externalEditor){this._externalEditor.handleFormSubmit()}};BX.Crm.EntityEditorProductRowProxy.create=function(t,e){var i=new BX.Crm.EntityEditorProductRowProxy;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorToolPanel==="undefined"){BX.Crm.EntityEditorToolPanel=function(){this._id="";this._settings={};this._container=null;this._wrapper=null;this._editor=null;this._isVisible=false;this._hasLayout=false};BX.Crm.EntityEditorToolPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX.prop.getElementNode(this._settings,"container",null);this._editor=BX.prop.get(this._settings,"editor",null);this._isVisible=BX.prop.getBoolean(this._settings,"visible",false)},getId:function(){return this._id},getContainer:function(){return this._container},setContainer:function(t){this._container=t},isVisible:function(){return this._isVisible},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;if(this._hasLayout){if(!this._isVisible){BX.removeClass(this._wrapper,"crm-section-control-active")}else{BX.addClass(this._wrapper,"crm-section-control-active")}}},layout:function(){this._editButton=BX.create("button",{props:{className:"webform-small-button webform-small-button-accept webform-button-active"},children:[BX.create("span",{props:{className:"webform-small-button-text"},text:BX.message("CRM_EDITOR_SAVE")})],events:{click:BX.delegate(this.onSaveButtonClick,this)}});this._cancelButton=BX.create("a",{props:{className:"webform-button-link"},text:BX.message("CRM_EDITOR_CANCEL"),attrs:{href:"#"},events:{click:BX.delegate(this.onCancelButtonClick,this)}});this._errorContainer=BX.create("DIV",{props:{className:"crm-entity-section-control-error-block"}});this._errorContainer.style.maxHeight="0px";this._wrapper=BX.create("DIV",{props:{className:"crm-entity-wrap"},children:[BX.create("DIV",{props:{className:"crm-entity-section crm-entity-section-control"},children:[this._editButton,this._cancelButton,this._errorContainer]})]});if(!this._isVisible){BX.removeClass(this._wrapper,"crm-section-control-active")}else{BX.addClass(this._wrapper,"crm-section-control-active")}document.body.appendChild(this._wrapper);this._hasLayout=true}};BX.Crm.EntityEditorToolPanel.prototype.onSaveButtonClick=function(t){this._editor.save()};BX.Crm.EntityEditorToolPanel.prototype.onCancelButtonClick=function(t){this._editor.cancel()};BX.Crm.EntityEditorToolPanel.prototype.processSaveBegin=function(){BX.addClass(this._editButton,"webform-small-button-wait")};BX.Crm.EntityEditorToolPanel.prototype.processSaveComplete=function(){BX.removeClass(this._editButton,"webform-small-button-wait")};BX.Crm.EntityEditorToolPanel.prototype.addError=function(t){this._errorContainer.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-section-control-error-text"},html:t}));this._errorContainer.style.maxHeight=""};BX.Crm.EntityEditorToolPanel.prototype.clearErrors=function(){this._errorContainer.innerHTML="";this._errorContainer.style.maxHeight="0px"};BX.Crm.EntityEditorToolPanel.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorToolPanel.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.EntityEditorToolPanel.messages==="undefined"){BX.Crm.EntityEditorToolPanel.messages={}}BX.Crm.EntityEditorToolPanel.create=function(t,e){var i=new BX.Crm.EntityEditorToolPanel;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorFieldSelector==="undefined"){BX.Crm.EntityEditorFieldSelector=function(){this._id="";this._settings={};this._scheme=null;this._excludedNames=null;this._closingNotifier=null;this._contentWrapper=null;this._popup=null};BX.Crm.EntityEditorFieldSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._scheme=BX.prop.get(this._settings,"scheme",null);if(!this._scheme){throw"BX.Crm.EntityEditorFieldSelector. Parameter 'scheme' is not found."}this._excludedNames=BX.prop.getArray(this._settings,"excludedNames",[]);this._closingNotifier=BX.CrmNotifier.create(this)},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityEditorFieldSelector.messages,t,t)},isSchemeElementEnabled:function(t){var e=t.getName();for(var i=0,n=this._excludedNames.length;i<n;i++){if(this._excludedNames[i]===e){return false}}return true},addClosingListener:function(t){this._closingNotifier.addListener(t)},removeClosingListener:function(t){this._closingNotifier.removeListener(t)},isOpened:function(){return this._popup&&this._popup.isShown()},open:function(){if(this.isOpened()){return}this._popup=new BX.PopupWindow(this._id,null,{autoHide:false,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{},zIndex:1,titleBar:BX.prop.getString(this._settings,"title",""),events:{onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:this.prepareContent(),lightShadow:true,contentNoPaddings:true,buttons:[new BX.PopupWindowButton({text:this.getMessage("select"),className:"popup-window-button-create",events:{click:BX.delegate(this.onAcceptButtonClick,this)}}),new BX.PopupWindowButtonLink({text:this.getMessage("cancel"),className:"webform-button-link-cancel",events:{click:BX.delegate(this.onCancelButtonClick,this)}})]});this._popup.show()},close:function(){if(!(this._popup&&this._popup.isShown())){return}this._popup.close()},prepareContent:function(){this._contentWrapper=BX.create("div",{props:{className:"crm-entity-field-selector-window"}});var t=BX.create("div",{props:{className:"crm-entity-field-selector-window-list"}});this._contentWrapper.appendChild(t);var e=this._scheme.getElements();for(var i=0;i<e.length;i++){var n=e[i];if(!this.isSchemeElementEnabled(n)){continue}var r=[];var o=n.getElements();var s;for(var a=0;a<o.length;a++){s=o[a];if(s.isTransferable()&&s.getName()!==""){r.push(s)}}if(r.length===0){continue}var l=n.getName();var d=n.getTitle();t.appendChild(BX.create("div",{attrs:{className:"crm-entity-field-selector-window-list-caption"},text:d}));for(var h=0;h<r.length;h++){s=r[h];var p=s.getName();var c=s.getTitle();var u=l+"\\"+p;var m=BX.create("div",{attrs:{className:"crm-entity-field-selector-window-list-item"}});t.appendChild(m);m.appendChild(BX.create("input",{attrs:{id:u,type:"checkbox",className:"crm-entity-field-selector-window-list-checkbox"}}));m.appendChild(BX.create("label",{attrs:{for:u,className:"crm-entity-field-selector-window-list-label"},text:c}))}}return this._contentWrapper},getSelectedItems:function(){if(!this._contentWrapper){return[]}var t=[];var e=this._contentWrapper.querySelectorAll("input.crm-entity-field-selector-window-list-checkbox");for(var i=0,n=e.length;i<n;i++){var r=e[i];if(r.checked){var o=r.id.split("\\");if(o.length>=2){t.push({sectionName:o[0],fieldName:o[1]})}}}return t},onAcceptButtonClick:function(){this._closingNotifier.notify([{isCanceled:false,items:this.getSelectedItems()}]);this.close()},onCancelButtonClick:function(){this._closingNotifier.notify([{isCanceled:true}]);this.close()},onPopupClose:function(){if(this._popup){this._contentWrapper=null;this._popup.destroy()}},onPopupDestroy:function(){if(!this._popup){return}this._contentWrapper=null;this._popup=null}};if(typeof BX.Crm.EntityEditorFieldSelector.messages==="undefined"){BX.Crm.EntityEditorFieldSelector.messages={}}BX.Crm.EntityEditorFieldSelector.create=function(t,e){var i=new BX.Crm.EntityEditorFieldSelector(t,e);i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserSelector==="undefined"){BX.Crm.EntityEditorUserSelector=function(){this._id="";this._settings={}};BX.Crm.EntityEditorUserSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._isInitialized=false},getId:function(){return this._id},open:function(t){if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){return}if(!this._isInitialized){BX.SocNetLogDestination.init({name:this._id,extranetUser:false,bindMainPopup:{node:t,offsetTop:"5px",offsetLeft:"15px"},callback:{select:BX.delegate(this.onSelect,this)},showSearchInput:true,departmentSelectDisable:true,items:{users:BX.Crm.EntityEditorUserSelector.users,groups:{},sonetgroups:{},department:BX.Crm.EntityEditorUserSelector.department,departmentRelation:BX.SocNetLogDestination.buildDepartmentRelation(BX.Crm.EntityEditorUserSelector.department)},itemsLast:BX.Crm.EntityEditorUserSelector.last,itemsSelected:{},isCrmFeed:false,useClientDatabase:false,destSort:{},allowAddUser:false,allowSearchCrmEmailUsers:false,allowUserSearch:true});this._isInitialized=true}BX.SocNetLogDestination.openDialog(this._id);this._mainWindow=BX.SocNetLogDestination.containerWindow},close:function(){if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){BX.SocNetLogDestination.closeDialog();this._mainWindow=null;this._isInitialized=false}},onSelect:function(t,e,i,n){if(e!=="users"){return}var r=BX.prop.getFunction(this._settings,"callback",null);if(r){r(this,t)}}};BX.Crm.EntityEditorUserSelector.items={};BX.Crm.EntityEditorUserSelector.create=function(t,e){var i=new BX.Crm.EntityEditorUserSelector(t,e);i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityEditorCrmSelector==="undefined"){BX.Crm.EntityEditorCrmSelector=function(){this._id="";this._settings={};this._entityTypeIds=[];this._supportedItemTypes={}};BX.Crm.EntityEditorCrmSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._isInitialized=false;this._entityTypeIds=BX.prop.getArray(this._settings,"entityTypeIds",[]);this._supportedItemTypes=[];for(var i=0,n=this._entityTypeIds.length;i<n;i++){var r=this._entityTypeIds[i];if(r===BX.CrmEntityType.enumeration.contact){this._supportedItemTypes.push({name:"contacts",altName:"CRMCONTACT"})}else if(r===BX.CrmEntityType.enumeration.company){this._supportedItemTypes.push({name:"companies",altName:"CRMCOMPANY"})}}},getId:function(){return this._id},isOpened:function(){return BX.SocNetLogDestination.isOpenDialog()},open:function(t){if(this.isOpened()){return}if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){return}if(!this._isInitialized){var e={};var i={};var n=[];for(var r=0,o=this._supportedItemTypes.length;r<o;r++){var s=this._supportedItemTypes[r];e[s.name]=BX.Crm.EntityEditorCrmSelector[s.name];i[s.name]=BX.Crm.EntityEditorCrmSelector[s.name+"Last"];n.push(s.altName)}i["crm"]={};BX.SocNetLogDestination.init({name:this._id,extranetUser:false,bindMainPopup:{node:t,offsetTop:"20px",offsetLeft:"20px"},callback:{select:BX.delegate(this.onSelect,this)},showSearchInput:true,departmentSelectDisable:true,items:e,itemsLast:i,itemsSelected:{},useClientDatabase:false,destSort:{},allowAddUser:false,allowSearchCrmEmailUsers:false,allowUserSearch:false,isCrmFeed:true,CrmTypes:n});this._isInitialized=true}BX.SocNetLogDestination.openDialog(this._id,{bindNode:t});this._mainWindow=BX.SocNetLogDestination.containerWindow},close:function(){if(!this.isOpened()){return}if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){BX.SocNetLogDestination.closeDialog();this._mainWindow=null}},onSelect:function(t,e,i,n,r,o){if(o!=="select"){return}var s=false;for(var a=0,l=this._supportedItemTypes.length;a<l;a++){var d=this._supportedItemTypes[a];if(d.name===e){s=true;break}}if(!s){return}var h=BX.prop.getFunction(this._settings,"callback",null);if(h){h(this,t)}}};if(typeof BX.Crm.EntityEditorCrmSelector.contacts==="undefined"){BX.Crm.EntityEditorCrmSelector.contacts={}}if(typeof BX.Crm.EntityEditorCrmSelector.contactsLast==="undefined"){BX.Crm.EntityEditorCrmSelector.contactsLast={}}if(typeof BX.Crm.EntityEditorCrmSelector.companies==="undefined"){BX.Crm.EntityEditorCrmSelector.companies={}}if(typeof BX.Crm.EntityEditorCrmSelector.companiesLast==="undefined"){BX.Crm.EntityEditorCrmSelector.companiesLast={}}BX.Crm.EntityEditorCrmSelector.items={};BX.Crm.EntityEditorCrmSelector.create=function(t,e){var i=new BX.Crm.EntityEditorCrmSelector(t,e);i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityBizprocManager==="undefined"){BX.Crm.EntityBizprocManager=function(){this._id="";this._settings={};this._moduleId="";this._entity="";this._documentType="";this._autoExecuteType=0;this._containerId=null;this._fieldName=null;this._validParameters=null;this._formInput=null;this._editor=null;this._starter=null};BX.Crm.EntityBizprocManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._hasParameters=BX.prop.getBoolean(this._settings,"hasParameters",false);this._moduleId=BX.prop.getString(this._settings,"moduleId","");this._entity=BX.prop.getString(this._settings,"entity","");this._documentType=BX.prop.getString(this._settings,"documentType","");this._autoExecuteType=BX.prop.getInteger(this._settings,"autoExecuteType",0);this._containerId=BX.prop.getString(this._settings,"containerId","");this._fieldName=BX.prop.getString(this._settings,"fieldName","");this._contentNode=this._containerId?BX(this._containerId):null;if(this._hasParameters){this._starter=new BX.Bizproc.Starter({moduleId:this._moduleId,entity:this._entity,documentType:this._documentType})}},onBeforeSave:function(t){var e=new BX.Promise;var i=function(){window.setTimeout(BX.delegate(function(){e.fulfill()},this),0)};if(t.getStatus()&&this._hasParameters&&this._validParameters===null){try{this._starter.showAutoStartParametersPopup(this._autoExecuteType,{contentNode:this._contentNode,callback:this.onFillParameters.bind(this,e)});this._contentNode=null}catch(t){if("console"in window){window.console.log("Error occurred when bizproc popup is going to show",t)}i()}}else{i()}return e},onAfterSave:function(){this._validParameters=null;if(this._editor&&this._formInput){var t=this._editor.getFormElement();t.removeChild(this._formInput)}},onFillParameters:function(t,e){this._validParameters=e.parameters;if(this._editor){var i=this._editor.getFormElement();this._formInput=BX.create("input",{props:{type:"hidden",name:this._fieldName,value:this._validParameters}});i.appendChild(this._formInput)}t.fulfill()}};if(typeof BX.Crm.EntityBizprocManager.messages==="undefined"){BX.Crm.EntityBizprocManager.messages={}}BX.Crm.EntityBizprocManager.items={};BX.Crm.EntityBizprocManager.create=function(t,e){var i=new BX.Crm.EntityBizprocManager;i.initialize(t,e);this.items[t]=i;return i}}if(typeof BX.Crm.EntityRestPlacementManager==="undefined"){BX.Crm.EntityRestPlacementManager=function(){this._id="";this._entity="";this._editor=null};BX.Crm.EntityRestPlacementManager.items={};BX.Crm.EntityRestPlacementManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entity=BX.prop.getString(this._settings,"entity","");BX.defer(this.initializeInterface,this)()},initializeInterface:function(){if(!!BX.rest&&!!BX.rest.AppLayout){var t=BX.rest.AppLayout.initializePlacement("CRM_"+this._entity+"_DETAIL_TAB");var e=this._editor._entityTypeId,i=this._editor._entityId;t.prototype.resizeWindow=function(t,e){var i=BX(this.params.layoutName);t.height=parseInt(t.height);if(!!t.height){i.style.height=t.height+"px"}var n=BX.pos(i);e({width:n.width,height:n.height})};t.prototype.reloadData=function(t,n){BX.Crm.EntityEvent.fireUpdate(e,i,"");n()}}}};BX.Crm.EntityRestPlacementManager.create=function(t,e){var i=new BX.Crm.EntityRestPlacementManager;i.initialize(t,e);this.items[t]=i;return i}}